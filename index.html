<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nordic Trip</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initApp"></script>
    
    <style>
        /* åŒ—æ­/ä¸‹é›ªé¢¨æ ¼çš„å®¢è£½åŒ–æ¨£å¼ */
        :root {
            --nordic-blue: #A9D6E5;
            --nordic-light: #E0F2F7; /* æ·ºç°è‰²/é›ªç™½è‰² */
            --nordic-dark: #014F86; /* æ·±æµ·è— */
            --nordic-accent: #02B8D2; /* æ¹–æ°´è—/é»ç¶´è‰² */
        }
        body {
            background-color: var(--nordic-light);
            /* ç¶­æŒé›ªèŠ±èƒŒæ™¯ï¼Œå¢åŠ ç°¡ç´„æ„Ÿ */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><defs><pattern id="snow" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.8)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23snow)"/></svg>');
            /* **ä¿®æ­£å­—é«”ç‚º Noto Sans TC** */
            font-family: 'Noto Sans TC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--nordic-dark);
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--nordic-light);
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        .header-bg {
            background-color: var(--nordic-blue);
            background-image: linear-gradient(135deg, var(--nordic-blue) 0%, #61A5C2 100%);
            color: white;
            padding: 1.5rem 1rem 3rem;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .date-scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .date-scroll-container::-webkit-scrollbar {
            display: none;
        }
        /* Tab æ—¥æœŸæŒ‰éˆ•é¢¨æ ¼èª¿æ•´ */
        .tab-date-button {
            transition: all 0.3s;
            border-radius: 0.75rem; /* è¼ƒåœ“æ½¤çš„åœ“è§’ */
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: 1px solid var(--nordic-light);
        }
        .tab-date-active {
            background-color: var(--nordic-dark); 
            color: var(--nordic-light);
            border-color: var(--nordic-dark);
            box-shadow: 0 2px 8px rgba(0, 79, 134, 0.3); 
        }

        /* åœ°åœ–ç›¸é—œæ¨£å¼ */
        .map-container {
            height: 320px; 
            width: 100%;
        }
        .map-hidden {
            visibility: hidden;
            height: 0;
            margin-bottom: 0 !important;
            padding: 0 !important;
        }

        /* **ä¿®æ­£: è®“ SVG åœ–æ¨™å¯ä»¥è¢« Tailwind text-color å½±éŸ¿ (é©ç”¨æ–¼åº•éƒ¨çš„ Tab æŒ‰éˆ•)** */
        .tab-icon svg {
            stroke-width: 2.5; /* è®“åœ–æ¨™ç·šæ¢æ›´ç²—ä¸€äº›ï¼Œæ›´ç°¡æ½” */
            width: 28px;
            height: 28px;
            color: inherit; /* è®“ SVG é¡è‰²ç¹¼æ‰¿è‡ªçˆ¶å±¤æ–‡å­—é¡è‰² */
        }
        /* **ä¿®æ­£: è®“ SVG åœ–æ¨™åˆªé™¤æŒ‰éˆ•æ›´çµ±ä¸€** */
        .delete-icon svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>

<div id="app" class="app-container hidden"> 
    
    <div class="header-bg relative mb-[-2rem]">
        <h1 class="text-2xl font-bold mb-1">â„ï¸ åŒ—æ­æ¥µç°¡ä¹‹æ—…</h1>
        <p class="text-sm opacity-90">æ—…è¡Œæ—¥æœŸ: **12/19/2025 - 01/03/2026**</p>
        <div class="absolute top-4 right-4 text-sm opacity-90">
            1 EUR â‰ˆ 36.3 NT$
        </div>
    </div>
    
    <div class="relative z-10 mx-4 overflow-x-scroll date-scroll-container pb-2" v-if="travelDates.length">
        <div class="flex space-x-2 p-1 bg-white rounded-xl shadow-xl">
            <template v-for="(date, index) in travelDates" :key="index">
                <button 
                    @click="setActiveDate(date)" 
                    :class="{'tab-date-active': activeDate === date, 'bg-gray-100 text-gray-700 hover:bg-gray-200': activeDate !== date}"
                    class="tab-date-button flex-shrink-0 text-xs font-semibold px-3 py-1.5 transition-all"
                >
                    <span class="block text-sm font-bold">Day {{ index + 1 }}</span>
                    <span class="block text-xs font-normal opacity-90 mt-0.5">{{ formatDate(date) }}</span>
                </button>
            </template>
        </div>
    </div>

    <div class="p-4 pt-6" v-if="travelDates.length">
        
        <div v-show="activeTab === 'itinerary'">
            <h2 class="text-xl font-bold text-gray-700 mb-4">è¡Œç¨‹å®‰æ’</h2>
            
            <div class="card p-4 mb-6 flex items-center justify-between bg-white/80 backdrop-blur-sm border-l-4 border-nordic-accent">
                <div class="flex items-center">
                    <div class="text-4xl mr-4">{{ getCurrentWeather().icon }}</div>
                    <div>
                        <p class="font-semibold text-gray-800">å¥§æ–¯é™¸ - {{ formatDate(activeDate) }}</p>
                        <p class="text-sm text-gray-500">{{ getCurrentWeather().desc }}</p>
                    </div>
                </div>
                <p class="text-3xl font-extrabold text-nordic-dark">{{ getCurrentWeather().temp }}</p>
            </div>

            <div class="space-y-4">
                <div v-for="element in currentItinerary" :key="element.id" 
                    class="card p-4 relative border-l-4" 
                    :class="{'border-red-400': element.category === 'èˆªç­', 'border-green-400': element.category === 'ç¾é£Ÿ', 'border-nordic-blue': element.category === 'æ™¯é»', 'border-yellow-400': element.category === 'äº¤é€š'}"
                >
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="text-sm font-medium text-gray-500 mb-1">
                                {{ element.time }} 
                                <span :class="{'bg-red-100 text-red-700': element.category === 'èˆªç­', 'bg-nordic-light text-nordic-dark': element.category !== 'èˆªç­'}" class="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold">{{ element.category }}</span>
                            </p>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">{{ element.location }}</h3>
                            <p v-if="element.notes" class="text-sm text-gray-600 border-l-2 border-gray-200 pl-2 mt-2 italic">{{ element.notes }}</p>
                        </div>
                        <div class="flex space-x-1 ml-4">
                            <button @click="deleteItem('itinerary', element.id)" class="text-gray-400 hover:text-red-500 p-1 delete-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .527a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.003-2.245a48.156 48.156 0 0 0-4.008 0c-1.093.106-2.003 1.144-2.003 2.245v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <p v-if="currentItinerary.length === 0" class="text-center text-gray-500 p-6">æœ¬æ—¥ç„¡è¡Œç¨‹å®‰æ’ã€‚</p>
        </div>

        <div v-show="activeTab === 'map'">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ç•¶æ—¥è¡Œç¨‹åœ°åœ–èˆ‡å°èˆª</h2>
            
            <div id="googleMapWrapper" class="card mb-4 map-container" :class="{'map-hidden': activeTab !== 'map'}">
                <div id="googleMap" class="map-container">
                    <div v-if="!isGoogleMapsLoaded" class="flex items-center justify-center h-full text-gray-500">
                        åœ°åœ–æœå‹™è¼‰å…¥ä¸­... (è«‹ç¢ºèª API Key æ˜¯å¦æœ‰æ•ˆ)
                    </div>
                </div>
            </div>
            
            <p class="text-sm text-gray-600 p-2 border-l-4 border-nordic-dark bg-nordic-light/50">åœ°åœ–æœƒè‡ªå‹•æ¨™è¨˜**ç•¶å¤©æ‰€æœ‰è¡Œç¨‹åœ°é»**ï¼Œä¸¦é¡¯ç¤ºæ‚¨çš„**ç•¶å‰ä½ç½®** (éœ€é–‹å•Ÿå®šä½æ¬Šé™)ã€‚</p>
            <a :href="currentMapLink" target="_blank" class="block mt-4 text-center py-3 bg-nordic-dark text-white rounded-xl font-semibold hover:bg-nordic-blue transition-colors hover:text-nordic-dark">
                é–‹å•Ÿ Google åœ°åœ–å°èˆª
            </a>
        </div>

        <div v-show="activeTab === 'accounting'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">æ—…è²»ç®¡ç†</h2>
                <button @click="showModal('accounting')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢èŠ±è²»
                </button>
            </div>
            
            <div class="card p-4 mb-4 text-center bg-gray-50/80 border-l-4 border-red-500">
                <p class="text-sm text-gray-600">ç¸½æ”¯å‡º (NT$)</p>
                <p class="text-4xl font-extrabold text-red-600">NT$ {{ totalExpense.toFixed(0) }}</p>
                <p class="text-sm text-gray-500 mt-1">ç´¯ç©æ”¯å‡º (EUR) ç´„ â‚¬{{ totalExpenseEUR }} (ä»¥ 1 EUR â‰ˆ 36.3 NT$ ä¼°ç®—)</p>
            </div>

            <div class="space-y-3">
                <div v-for="expense in expenses.slice().reverse()" :key="expense.id" class="card p-3 flex justify-between items-center border-l-4 border-red-500">
                    <div>
                        <p class="font-semibold text-gray-800">{{ expense.item }}</p>
                        <p class="text-xs text-gray-500">{{ expense.date }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-red-600">- NT$ {{ expense.amount.toFixed(0) }}</p>
                        <button @click="deleteItem('accounting', expense.id)" class="text-xs text-gray-400 hover:text-red-500 delete-icon">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            </div>
            <p v-if="expenses.length === 0" class="text-center text-gray-500 p-6">å°šæœªæ–°å¢ä»»ä½•èŠ±è²»ã€‚</p>
        </div>

        <div v-show="activeTab === 'shopping'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">å¾…è¾¦/è³¼ç‰©æ¸…å–®</h2>
                <button @click="showModal('shopping')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢
                </button>
            </div>
            
            <div class="space-y-3">
                <div v-for="item in shoppingList" :key="item.id" class="card p-4 flex items-center justify-between transition-opacity border-l-4 border-nordic-accent" :class="{'opacity-50 line-through bg-green-50/50 border-green-400': item.done}">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" v-model="item.done" class="h-5 w-5 text-nordic-dark rounded border-gray-300 focus:ring-nordic-accent">
                        <span class="ml-3 text-lg font-medium text-gray-800">{{ item.name }}</span>
                    </label>
                    <button @click="deleteItem('shopping', item.id)" class="text-gray-400 hover:text-red-500 p-2 delete-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .527a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.003-2.245a48.156 48.156 0 0 0-4.008 0c-1.093.106-2.003 1.144-2.003 2.245v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    </button>
                </div>
            </div>
            <p v-if="shoppingList.length === 0" class="text-center text-gray-500 p-6">è³¼ç‰©æ¸…å–®å·²æ¸…ç©ºï¼</p>
        </div>
        
    </div>

    <div class="sticky bottom-0 bg-white/95 backdrop-blur-sm shadow-2xl p-3 mt-8 z-30" v-if="travelDates.length">
        <div class="flex justify-around text-gray-500">
            <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                :class="{'text-nordic-dark font-bold': activeTab === tab.id, 'hover:text-nordic-blue': activeTab !== tab.id}"
                class="flex flex-col items-center text-xs transition-colors p-1"
            >
                <span class="tab-icon" v-html="tab.icon"></span>
                <span>{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <div v-if="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-nordic-dark">
                {{ modalTitle }}
            </h3>
            
            <div v-if="modalType === 'accounting'">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">é …ç›®</label>
                    <input type="text" v-model="tempItem.item" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent" placeholder="ä¾‹å¦‚: æ™šé¤è²»ç”¨">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">é‡‘é¡ (NT$)</label>
                    <input type="number" v-model.number="tempItem.amount" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent">
                </div>
                </div>

            <div v-else-if="modalType === 'shopping'">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">å¾…è²·é …ç›®</label>
                    <input type="text" v-model="tempItem.name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent" placeholder="ä¾‹å¦‚: èŠ¬è˜­åˆ€">
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button @click="isModalOpen = false" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">å–æ¶ˆ</button>
                <button @click="saveItem" class="px-4 py-2 bg-nordic-dark text-white rounded-lg hover:bg-nordic-blue hover:text-nordic-dark transition-colors font-semibold">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, nextTick, watch } = Vue

// --- å…¨å±€å¸¸æ•¸è¨­å®š ---
const EXCHANGE_RATE = 36.3; // 1 EUR â‰ˆ 36.3 TWD
const TWD_SYMBOL = 'NT$';

let appInstance = null;
let googleMapsLoaded = ref(false); 
let mapInitialized = false; 
let appReadyToDisplay = false; 

window.initApp = function() {
    googleMapsLoaded.value = true;
    if (appInstance) {
        if (appInstance.activeTab === 'map' && !mapInitialized) {
             nextTick(() => appInstance.initMap());
        }
    } else {
        mountVueApp();
    }
}

function initMap() {
    if (!googleMapsLoaded.value) {
        return;
    }
    
    const mapElement = document.getElementById('googleMap');
    if (typeof google === 'undefined' || !mapElement) return;

    const locations = appInstance.currentItinerary.filter(item => item.lat && item.lng);
    // åŒ—æ­ä¸­å¿ƒé» (æŒªå¨/ç‘å…¸ä¹‹é–“)
    let center = { lat: 60.12816, lng: 18.6435 }; 
    let zoom = 5;

    if (locations.length > 0) {
        center = { lat: locations[0].lat, lng: locations[0].lng };
        zoom = 12;
    }
    
    const markerColor = '#014F86'; // ä½¿ç”¨ Nordic Dark ä½œç‚ºæ¨™è¨˜é¡è‰²

    if (!mapInitialized) {
        appInstance.map = new google.maps.Map(mapElement, {
            zoom: zoom,
            center: center,
            mapId: "DEMO_MAP_ID" 
        });
        mapInitialized = true;
    } else {
        appInstance.map.setCenter(center);
        appInstance.map.setZoom(zoom);
    }
    
    if (appInstance.markers) {
        appInstance.markers.forEach(marker => marker.setMap(null));
    }
    appInstance.markers = [];

    locations.forEach((item, index) => {
        const marker = new google.maps.Marker({
            position: { lat: item.lat, lng: item.lng },
            map: appInstance.map,
            title: `${index + 1}. ${item.location}`,
            label: (index + 1).toString(),
            icon: {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="${markerColor}"/><text x="12" y="16" font-family="Arial" font-size="12" fill="white" text-anchor="middle" dominant-baseline="middle">${index + 1}</text></svg>`),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
        appInstance.markers.push(marker);
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                
                new google.maps.Marker({
                    position: pos,
                    map: appInstance.map,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });

                if (locations.length === 0) {
                    appInstance.map.setCenter(pos);
                    appInstance.map.setZoom(14);
                }
            },
            (error) => {
                console.error("Geolocation failed:", error);
            }
        );
    }
    
    google.maps.event.trigger(mapElement, 'resize');
}

// ä¿®æ­£æ—¥æœŸç‚º 12/19 - 1/3 (å·²æ˜¯æ­£ç¢ºç¯„åœ)
function getTravelDates() {
    const start = new Date('2025-12-19T00:00:00');
    const end = new Date('2026-01-03T00:00:00');
    const dates = [];
    let currentDate = new Date(start);
    while (currentDate <= end) {
        // ç¢ºä¿æ—¥æœŸæ˜¯æ­£ç¢ºæ ¼å¼
        dates.push(currentDate.toISOString().split('T')[0]);
        // å¢åŠ ä¸€å¤©
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
}

function showApp() {
    if (appReadyToDisplay) return;

    const appElement = document.getElementById('app');
    if (appElement) {
        // ç§»é™¤éš±è— classï¼Œè®“æ‡‰ç”¨ç¨‹å¼é¡¯ç¤º
        appElement.classList.remove('hidden');
    }
    appReadyToDisplay = true;
}

// **å®šç¾© SVG åœ–æ¨™ (Heroicons 2.5, line style)**
const ICONS = {
    // åœ°åœ–/è¡Œç¨‹: Globe Alt Icon
    itinerary: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21v-4.5m0 0V5.25M12 16.5h3.375M12 16.5L10.5 21M12 16.5H8.625M9.75 8.25m1.125 0a2.25 2.25 0 1 1 0 4.5 2.25 2.25 0 0 1 0-4.5ZM12 4.5v1.5m-3 0h6m-1.5-1.5a1.5 1.5 0 0 1 1.5 1.5v1.5m-6 0v-1.5a1.5 1.5 0 0 1 1.5-1.5h3m-6 0H9m-3 0a1.5 1.5 0 0 0 1.5 1.5h3.75"/></svg>`,
    // åœ°åœ–: Map Pin Icon
    map: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`,
    // è¨˜å¸³: Currency Dollar Icon (ä»£è¡¨è²¨å¹£)
    accounting: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.01 60.01 0 0 0 10.5.5H12m10.5-11.25H12V12c0 1.295.127 2.583.374 3.824M19.5 16.5l-6-6M4.5 9h9m-9 0a7.5 7.5 0 0 1 7.5-7.5v1.5m-7.5 6v1.5m7.5-7.5a7.5 7.5 0 0 1 7.5 7.5v1.5m-15 3h1.5a7.5 7.5 0 0 0 7.5-7.5v-1.5m-15 3a7.5 7.5 0 0 0 7.5 7.5h1.5M4.5 18.75h15m-15 0a7.5 7.5 0 0 0 7.5 7.5V22.5"/></svg>`,
    // è³¼ç‰©: Shopping Cart Icon
    shopping: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.056.832L6.772 17.5c.101.489.546.832 1.056.832H20.25a1.125 1.125 0 0 0 1.12-1.248L19.46 8.423a.975.975 0 0 0-.95-1.075H5.87l-.44-2.126C5.228 4.253 4.8 3 3.636 3H2.25" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM6.75 19.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" /></svg>`,
};


function mountVueApp() {
    const app = createApp({
        setup() {
            const tabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹', icon: ICONS.itinerary },
                { id: 'map', name: 'åœ°åœ–', icon: ICONS.map },
                { id: 'accounting', name: 'è¨˜å¸³', icon: ICONS.accounting },
                { id: 'shopping', name: 'è³¼ç‰©', icon: ICONS.shopping },
            ];
            const activeTab = ref('itinerary');
            
            const travelDates = getTravelDates();
            const activeDate = ref(travelDates[0]); // 12/19
            
            const itinerary = ref({
                '2025-12-19': [ // Day 1
                    { id: 1, time: '09:00', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', category: 'èˆªç­', notes: 'ç¢ºèªç™»æ©Ÿè­‰èˆ‡è¡Œæ', lat: 25.0777, lng: 121.2298 },
                    { id: 2, time: '18:00', location: 'æŠµé”å¥§æ–¯é™¸æ©Ÿå ´ (OSL)', category: 'èˆªç­', notes: 'æ­ä¹˜æ©Ÿå ´å¿«ç·š Flytoget', lat: 60.1939, lng: 11.1004 },
                ],
                '2025-12-20': [ // Day 2
                    { id: 3, time: '10:00', location: 'å¥§æ–¯é™¸æ­ŒåŠ‡é™¢', category: 'æ™¯é»', notes: 'çˆ¬ä¸Šå±‹é ‚æ‹ç…§', lat: 59.9079, lng: 10.7511 },
                    { id: 4, time: '13:00', location: 'Kaffistova å‚³çµ±åˆé¤', category: 'ç¾é£Ÿ', notes: 'è©¦è©¦æŒªå¨è‚‰ä¸¸', lat: 59.9138, lng: 10.7390 },
                    { id: 5, time: '15:00', location: 'ç¶­æ ¼æœ—é›•å¡‘å…¬åœ’', category: 'æ™¯é»', notes: 'å·¨å¤§çš„ç”Ÿå‘½ä¹‹æŸ±', lat: 59.9270, lng: 10.7029 },
                ],
                // 12/21 - 01/02 ç•™ç©ºæˆ–è‡ªè¡Œå¡«å¯«
                '2025-12-21': [],
                '2025-12-22': [],
                '2025-12-23': [],
                '2025-12-24': [],
                '2025-12-25': [],
                '2025-12-26': [],
                '2025-12-27': [],
                '2025-12-28': [],
                '2025-12-29': [],
                '2025-12-30': [],
                '2025-12-31': [],
                '2026-01-01': [],
                '2026-01-02': [],
                '2026-01-03': [ // Day 16
                    { id: 6, time: '14:00', location: 'å“¥æœ¬å“ˆæ ¹æ©Ÿå ´ (CPH) è¿”ç¨‹', category: 'èˆªç­', notes: 'é ç•™å……è¶³æ™‚é–“é€€ç¨…', lat: 55.6268, lng: 12.6558 },
                ]
            });

            const currentItinerary = computed(() => itinerary.value[activeDate.value] || []);
            const getCurrentWeather = () => ({ temp: '-5Â°C', desc: 'å¤šé›²ï¼Œå¶æœ‰é›ªèŠ±', icon: 'ğŸŒ¨ï¸' });
            
            // ä¿®æ­£: å‡è¨­åˆå§‹é‡‘é¡ç‚º TWDï¼Œä¸¦åˆªé™¤ method
            const expenses = ref([
                { id: 101, date: '2025-12-19', item: 'æ©Ÿå ´å¿«ç·šè»Šç¥¨', amount: 1270, currency: 'TWD' }, 
                { id: 102, date: '2025-12-19', item: 'æ™šé¤ (ä¾¿åˆ©å•†åº—)', amount: 310, currency: 'TWD' }
            ]);
            
            // è¨ˆç®—ç¸½ TWD æ”¯å‡º
            const totalExpense = computed(() => expenses.value.reduce((sum, item) => {
                 // é€™è£¡å‡è¨­æ‰€æœ‰æ–°èˆŠè²»ç”¨éƒ½å·²æ˜¯ TWD
                 return sum + item.amount
            }, 0));
            
            // è¨ˆç®—ç¸½ EUR æ”¯å‡º (ç”¨æ–¼åƒè€ƒé¡¯ç¤º)
            const totalExpenseEUR = computed(() => (totalExpense.value / EXCHANGE_RATE).toFixed(2));

            const shoppingList = ref([{ id: 201, name: 'æ¥µå…‰å°ˆç”¨ä¸‰è…³æ¶', done: false }, { id: 202, name: 'èŠ¬è˜­æ¯›å¸½', done: false }, { id: 203, name: 'æ—…éŠä¿éšª', done: true }]);
            const isModalOpen = ref(false);
            const modalType = ref('');
            const modalTitle = computed(() => modalType.value === 'accounting' ? 'æ–°å¢èŠ±è²»ç´€éŒ„' : 'æ–°å¢è³¼ç‰©é …ç›®');
            const tempItem = ref({});
            
            function setActiveDate(date) {
                activeDate.value = date;
                if (activeTab.value === 'map') {
                    nextTick(() => initMap());
                }
            }
            
            function showModal(type, item = null) {
                if (type === 'itinerary') return;
                modalType.value = type;
                
                // ä¿®æ­£: åˆªé™¤ tempItem ä¸­çš„ method å±¬æ€§
                tempItem.value = type === 'accounting' 
                    ? { item: '', amount: null, date: activeDate.value } 
                    : { name: '', done: false };
                    
                isModalOpen.value = true;
            }
            
            function saveItem() {
                if (modalType.value === 'accounting') {
                    if (!tempItem.value.item || !tempItem.value.amount) return alert('è«‹å¡«å¯«é …ç›®å’Œé‡‘é¡');
                    // ä¿®æ­£: æ–°å¢è²»ç”¨é è¨­ç‚º TWD
                    expenses.value.push({ 
                        ...tempItem.value, 
                        id: Date.now(), 
                        date: new Date().toISOString().split('T')[0],
                        currency: 'TWD' // é è¨­æ–°å¢çš„è²»ç”¨ç‚º TWD
                    });
                } else if (modalType.value === 'shopping') {
                    if (!tempItem.value.name) return alert('è«‹å¡«å¯«è³¼ç‰©é …ç›®');
                    shoppingList.value.push({ ...tempItem.value, id: Date.now() });
                }
                isModalOpen.value = false;
            }

            function deleteItem(type, id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤å—?')) return;
                if (type === 'itinerary') {
                    const currentList = itinerary.value[activeDate.value] || [];
                    itinerary.value[activeDate.value] = currentList.filter(item => item.id !== id);
                    if (activeTab.value === 'map') {
                        nextTick(() => initMap());
                    }
                } else if (type === 'accounting') {
                    expenses.value = expenses.value.filter(item => item.id !== id);
                } else if (type === 'shopping') {
                    shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                }
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                // ä¿®æ­£ï¼šä¿®æ­£æœˆä»½å–å¾—æ–¹å¼ï¼Œç¢ºä¿è·¨å¹´é¡¯ç¤ºæ­£ç¢º (ä¾‹å¦‚ 12/31 -> 1/1)
                return `${date.getUTCMonth() + 1}/${date.getUTCDate()}`; 
            }

            const currentMapLink = computed(() => {
                const locations = currentItinerary.value.filter(item => item.lat && item.lng);
                if (locations.length === 0) return `https://www.google.com/maps/@60.12816,18.6435,5z`; // åŒ—æ­ä¸­å¿ƒé»
                const destinationMarkers = locations.map(loc => `${loc.location}`).join(' to ');
                // å‰µå»ºä¸€å€‹åŒ…å«æ‰€æœ‰åœ°é»çš„ Google Maps é€£çµï¼Œä½¿ç”¨ q åƒæ•¸æŸ¥æ‰¾å¤šå€‹åœ°é»
                return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(locations[locations.length - 1].location)}&waypoints=${encodeURIComponent(locations.slice(0, -1).map(l => l.location).join('|'))}`;
            });

            watch(activeTab, (newTab) => {
                if (newTab === 'map' && googleMapsLoaded.value) {
                    nextTick(() => initMap());
                }
            });
            
            appInstance = { activeTab, initMap, currentItinerary, map: null, markers: [] };
            
            if (activeTab.value === 'map' && googleMapsLoaded.value) {
                 nextTick(() => initMap());
            }

            return {
                tabs,
                activeTab,
                travelDates,
                activeDate,
                currentItinerary,
                setActiveDate,
                getCurrentWeather,
                formatDate,
                currentMapLink,
                expenses,
                totalExpense,
                totalExpenseEUR, // æ–°å¢çš„ computed å±¬æ€§
                shoppingList,
                isModalOpen,
                modalType,
                modalTitle,
                tempItem,
                showModal,
                saveItem,
                deleteItem,
                isGoogleMapsLoaded: googleMapsLoaded
            };
        }
    });

    app.mount('#app');
    
    // Vue æ›è¼‰å¾Œï¼Œé¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼
    showApp();
}

// å‚™ç”¨æ©Ÿåˆ¶ï¼šå¦‚æœ Google Maps API è¼‰å…¥å¤±æ•—æˆ–è¶…æ™‚
if (typeof google === 'undefined') {
    setTimeout(() => {
        if (!appReadyToDisplay) { 
             googleMapsLoaded.value = false;
             mountVueApp();
        }
    }, 500); 
}

// ç¢ºä¿é é¢è¼‰å…¥å®Œæˆä¸” Google Maps æœªè¼‰å…¥æ™‚ï¼Œä¹Ÿèƒ½é–‹å§‹ Vue æ‡‰ç”¨ç¨‹å¼
document.addEventListener('DOMContentLoaded', () => {
    if (typeof google === 'undefined' && !appReadyToDisplay) {
        // å¦‚æœ DOM è¼‰å…¥å®Œæˆï¼Œä½† Google å°šæœªè¼‰å…¥ï¼Œå‰‡ç«‹å³å•Ÿå‹• Vue æ‡‰ç”¨ç¨‹å¼
        // è®“ç”¨æˆ¶è‡³å°‘èƒ½çœ‹åˆ°è¡Œç¨‹è¡¨å’Œè¨˜å¸³ç­‰å…§å®¹
        mountVueApp();
    }
});
</script>

</body>
</html>

<script>
const { createApp, ref, computed, nextTick, watch } = Vue

let appInstance = null;
let googleMapsLoaded = ref(false); 
let mapInitialized = false; 
let appReadyToDisplay = false; 
const EXCHANGE_RATE_EUR_TO_HKD = 8.5; // åŒ¯ç‡å¸¸æ•¸

// Google Maps callback å‡½å¼
window.initApp = function() {
    googleMapsLoaded.value = true;
    if (appInstance && appInstance.activeTab === 'map') {
        nextTick(() => appInstance.initMap());
    } else if (!appInstance) {
        mountVueApp();
    }
}

function initMap() {
    if (!googleMapsLoaded.value || typeof google === 'undefined') return;
    
    const mapElement = document.getElementById('googleMap');
    if (!mapElement) return;

    // ç¯©é¸å‡ºç•¶å¤©æ‰€æœ‰æœ‰ç¶“ç·¯åº¦çš„åœ°é»
    const locations = appInstance.currentItinerary.filter(item => item.lat && item.lng);
    
    let center = { lat: 60.12816, lng: 18.6435 }; // åŒ—æ­ä¸­å¿ƒé»
    let zoom = 5;

    if (locations.length > 0) {
        // å¦‚æœæœ‰å¤šå€‹åœ°é»ï¼Œå˜—è©¦è¨ˆç®—ä¸­å¿ƒé»
        if (locations.length > 1) {
            const sumLat = locations.reduce((sum, item) => sum + item.lat, 0);
            const sumLng = locations.reduce((sum, item) => sum + item.lng, 0);
            center = { lat: sumLat / locations.length, lng: sumLng / locations.length };
            zoom = 10; // ç¸®å°ä¸€é»ä»¥é¡¯ç¤ºå¤šå€‹é»
        } else {
            // åªæœ‰ä¸€å€‹åœ°é»ï¼Œä»¥è©²é»ç‚ºä¸­å¿ƒ
            center = { lat: locations[0].lat, lng: locations[0].lng };
            zoom = 12;
        }
    } else {
        // å˜—è©¦å¾ç•¶å¤©æ´»å‹•çš„åœ°é»åç¨±åˆ¤æ–·åŸå¸‚ï¼Œä¸¦è¨­å®šä¸­å¿ƒé» (ç°¡åŒ–é‚è¼¯)
        const firstLocation = appInstance.currentItinerary[0]?.location || '';
        if (firstLocation.includes('Helsinki')) center = { lat: 60.1699, lng: 24.9384 }; 
        else if (firstLocation.includes('Rovaniemi')) center = { lat: 66.5039, lng: 25.7294 }; 
        else if (firstLocation.includes('TromsÃ¸')) center = { lat: 69.6492, lng: 18.9553 }; 
        else if (firstLocation.includes('Copenhagen')) center = { lat: 55.6761, lng: 12.5683 }; 
        else if (firstLocation.includes('Stockholm')) center = { lat: 59.3293, lng: 18.0686 };
    }
    
    const markerColor = '#014F86'; 

    if (!mapInitialized) {
        appInstance.map = new google.maps.Map(mapElement, {
            zoom: zoom,
            center: center,
            mapId: "DEMO_MAP_ID" 
        });
        mapInitialized = true;
    } else {
        appInstance.map.setCenter(center);
        appInstance.map.setZoom(zoom);
    }
    
    // æ¸…é™¤èˆŠçš„æ¨™è¨˜
    if (appInstance.markers) {
        appInstance.markers.forEach(marker => marker.setMap(null));
    }
    appInstance.markers = [];

    // æ¨™è¨˜æ–°çš„åœ°é» (æŒ‰é †åºç·¨è™Ÿ)
    locations.forEach((item, index) => {
        const marker = new google.maps.Marker({
            position: { lat: item.lat, lng: item.lng },
            map: appInstance.map,
            title: `${index + 1}. ${item.location}`,
            label: (index + 1).toString(),
            icon: {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="${markerColor}"/><text x="12" y="16" font-family="Arial" font-size="12" fill="white" text-anchor="middle" dominant-baseline="middle">${index + 1}</text></svg>`),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
        appInstance.markers.push(marker);
    });

    // é¡¯ç¤ºç¾åœ¨ä½ç½®
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                
                new google.maps.Marker({
                    position: pos,
                    map: appInstance.map,
                    title: 'Your Location (ç¾åœ¨ä½ç½®)',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });

                // å¦‚æœç•¶å¤©æ²’æœ‰è¨­å®šåœ°é»ï¼Œä»¥ç¾åœ¨ä½ç½®ç‚ºä¸­å¿ƒ
                if (locations.length === 0) {
                    appInstance.map.setCenter(pos);
                    appInstance.map.setZoom(14);
                }
            },
            (error) => {
                console.error("Geolocation failed:", error);
            }
        );
    }
    
    google.maps.event.trigger(mapElement, 'resize');
}

// ä¿®æ­£æ—¥æœŸç‚º 12/19 - 1/3
function getTravelDates() {
    const start = new Date('2025-12-19T00:00:00');
    const end = new Date('2026-01-03T00:00:00');
    const dates = [];
    let currentDate = new Date(start);
    while (currentDate <= end) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
}

function showApp() {
    if (appReadyToDisplay) return;

    const appElement = document.getElementById('app');
    if (appElement) {
        // ç§»é™¤ hidden class ä»¥é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼
        appElement.classList.remove('hidden'); 
    }
    appReadyToDisplay = true;
}


function mountVueApp() {
    const app = createApp({
        setup() {
            const tabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹è¡¨', icon: 'ğŸ—ºï¸' },
                { id: 'map', name: 'åœ°åœ–', icon: 'ğŸ“' },
                { id: 'packing', name: 'è£å‚™', icon: 'ğŸ§³' }, 
                { id: 'accounting', name: 'è¨˜å¸³', icon: 'ğŸ’°' },
                { id: 'shopping', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸' },
            ];
            const activeTab = ref('itinerary');
            
            const travelDates = getTravelDates();
            const activeDate = ref(travelDates[0]); 
            
            // ===========================================
            // START: å¡«å……çš„åŒ—æ­è¡Œç¨‹ (12/19/2025 - 01/03/2026) - ä¾†è‡ª ç¸½è¡Œç¨‹.csv
            // 
            const itinerary = ref({
                '2025-12-19': [ 
                    { id: 1, time: '09:00', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', category: 'èˆªç­', notes: 'ç¢ºèªç™»æ©Ÿè­‰èˆ‡è¡Œæ', lat: 25.0777, lng: 121.2298 },
                    { id: 2, time: '18:00', location: 'æŠµé”å¥§æ–¯é™¸æ©Ÿå ´ (OSL)', category: 'èˆªç­', notes: 'æ­ä¹˜æ©Ÿå ´å¿«ç·š Flytoget', lat: 60.1939, lng: 11.1004 },
                ],
                '2025-12-20': [ 
                    { id: 3, time: '10:00', location: 'å¥§æ–¯é™¸æ­ŒåŠ‡é™¢', category: 'æ™¯é»', notes: 'çˆ¬ä¸Šå±‹é ‚æ‹ç…§', lat: 59.9079, lng: 10.7511 },
                    { id: 4, time: '13:00', location: 'Kaffistova å‚³çµ±åˆé¤', category: 'ç¾é£Ÿ', notes: 'è©¦è©¦æŒªå¨è‚‰ä¸¸', lat: 59.9138, lng: 10.7390 },
                    { id: 5, time: '15:00', location: 'ç¶­æ ¼æœ—é›•å¡‘å…¬åœ’', category: 'æ™¯é»', notes: 'å·¨å¤§çš„ç”Ÿå‘½ä¹‹æŸ±', lat: 59.9270, lng: 10.7029 },
                ],
                '2026-01-03': [ 
                    { id: 6, time: '14:00', location: 'å“¥æœ¬å“ˆæ ¹æ©Ÿå ´ (CPH) è¿”ç¨‹', category: 'èˆªç­', notes: 'é ç•™å……è¶³æ™‚é–“é€€ç¨…', lat: 55.6268, lng: 12.6558 },
                ],
                // è£œé½Šæ‰€æœ‰æ—¥æœŸï¼Œé¿å…éŒ¯èª¤
                ...Object.fromEntries(travelDates.filter(d => !['2025-12-19', '2025-12-20', '2026-01-03'].includes(d)).map(d => [d, []])),
            });
            // 
            // END: å¡«å……çš„åŒ—æ­è¡Œç¨‹
            // ===========================================

            const currentItinerary = computed(() => itinerary.value[activeDate.value] || []);
            const getCurrentWeather = () => ({ temp: '-5Â°C', desc: 'å¤šé›²ï¼Œå¶æœ‰é›ªèŠ±', icon: 'ğŸŒ¨ï¸' });
            
            // ä¿®æ­£é» 4: è¨˜å¸³ç³»çµ±åŠ å…¥ currency æ¬„ä½
            const expenses = ref([
                { id: 101, date: '2025-12-19', item: 'æ©Ÿå ´å¿«ç·šè»Šç¥¨', amount: 350.00, currency: 'HKD' },
                { id: 102, date: '2025-12-20', item: 'æ­ŒåŠ‡é™¢é–€ç¥¨', amount: 15.00, currency: 'EUR' }
            ]);
            
            // ä¿®æ­£é» 4: é‡æ–°è¨ˆç®—ç¸½æ”¯å‡º (å°‡ EUR è½‰æ›ç‚º HKD)
            const totalExpense = computed(() => expenses.value.reduce((sum, item) => {
                let amountInHKD = item.amount;
                if (item.currency === 'EUR') {
                    amountInHKD = item.amount * EXCHANGE_RATE_EUR_TO_HKD;
                }
                return sum + amountInHKD;
            }, 0));
            
            const shoppingList = ref([{ id: 201, name: 'èŠ¬è˜­åˆ€', done: false }]);
            const packingList = ref([{ id: 301, name: 'ç¦¦å¯’è¡£ç‰©', packed: true }, { id: 302, name: 'è½‰æ›æ’é ­', packed: false }]);
            
            const isModalOpen = ref(false);
            const modalType = ref('');
            const isEditMode = ref(false);
            const editingId = ref(null);
            
            const modalTitle = computed(() => {
                if (isEditMode.value) return 'ç·¨è¼¯é …ç›®';
                switch (modalType.value) {
                    case 'itinerary': return 'æ–°å¢è¡Œç¨‹é …ç›®';
                    case 'packing': return 'æ–°å¢è£å‚™';
                    case 'accounting': return 'æ–°å¢èŠ±è²»ç´€éŒ„';
                    case 'shopping': return 'æ–°å¢è³¼ç‰©é …ç›®';
                    default: return 'æ–°å¢é …ç›®';
                }
            });
            const tempItem = ref({});
            
            function setActiveDate(date) {
                activeDate.value = date;
                if (activeTab.value === 'map') {
                    nextTick(() => initMap());
                }
            }
            
            function showModal(type, item = null) {
                modalType.value = type;
                isEditMode.value = !!item;
                
                if (item) {
                    editingId.value = item.id;
                    tempItem.value = { ...item };
                } else {
                    editingId.value = null;
                    switch(type) {
                        case 'itinerary': tempItem.value = { time: '', location: '', category: 'æ™¯é»', notes: '', lat: null, lng: null }; break;
                        case 'packing': tempItem.value = { name: '', packed: false }; break;
                        // ä¿®æ­£é» 4: ç§»é™¤ methodï¼ŒåŠ å…¥ currency
                        case 'accounting': tempItem.value = { item: '', amount: null, currency: 'HKD', date: activeDate.value }; break; 
                        case 'shopping': tempItem.value = { name: '', done: false }; break;
                    }
                }
                isModalOpen.value = true;
            }

            function editItem(type, item) {
                showModal(type, item);
            }
            
            function saveItem() {
                const itemToSave = { ...tempItem.value };

                const updateList = (list) => {
                    const index = list.findIndex(i => i.id === editingId.value);
                    if (index !== -1) {
                        list[index] = itemToSave;
                    } else {
                        itemToSave.id = Date.now();
                        list.push(itemToSave);
                    }
                };
                
                if (modalType.value === 'itinerary') {
                    if (!itemToSave.location || !itemToSave.time) return alert('è«‹å¡«å¯«æ™‚é–“å’Œåœ°é»');
                    const list = itinerary.value[activeDate.value] || (itinerary.value[activeDate.value] = []);
                    updateList(list);
                    if (activeTab.value === 'map') nextTick(() => initMap());
                } else if (modalType.value === 'packing') {
                    if (!itemToSave.name) return alert('è«‹å¡«å¯«è£å‚™åç¨±');
                    updateList(packingList.value);
                } else if (modalType.value === 'accounting') {
                    if (!itemToSave.item || itemToSave.amount === null) return alert('è«‹å¡«å¯«é …ç›®å’Œé‡‘é¡');
                    if (!isEditMode.value) itemToSave.date = new Date().toISOString().split('T')[0];
                    // ç¢ºä¿ amount æ˜¯æ•¸å­—
                    itemToSave.amount = parseFloat(itemToSave.amount);
                    updateList(expenses.value);
                } else if (modalType.value === 'shopping') {
                    if (!itemToSave.name) return alert('è«‹å¡«å¯«è³¼ç‰©é …ç›®');
                    updateList(shoppingList.value);
                }
                
                isModalOpen.value = false;
            }

            function deleteItem(type, id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤å—?')) return;
                
                if (type === 'itinerary') {
                    const currentList = itinerary.value[activeDate.value] || [];
                    itinerary.value[activeDate.value] = currentList.filter(item => item.id !== id);
                    if (activeTab.value === 'map') nextTick(() => initMap());
                } else if (type === 'packing') {
                    packingList.value = packingList.value.filter(item => item.id !== id);
                } else if (type === 'accounting') {
                    expenses.value = expenses.value.filter(item => item.id !== id);
                } else if (type === 'shopping') {
                    shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                }
            }
            
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }

            // ä¿®æ­£é» 3: åˆªé™¤åœ°åœ–æŒ‰éˆ•ï¼Œä½†ä¿ç•™é€£çµé‚è¼¯ä»¥å‚™å°‡ä¾†ä½¿ç”¨ (ä½†ä¸æœƒåœ¨ HTML ä¸­é¡¯ç¤º)
            const currentMapLink = computed(() => {
                const locations = currentItinerary.value.filter(item => item.lat && item.lng);
                if (locations.length === 0) return `https://www.google.com/maps/search/Northern+Europe`;
                const waypoints = locations.slice(1).map(loc => `${loc.lat},${loc.lng}`).join('/');
                const origin = `${locations[0].lat},${locations[0].lng}`;
                
                let url = `https://www.google.com/maps/dir/${origin}/`;
                if (waypoints) {
                    url += waypoints;
                }
                return url;
            });

            watch(activeTab, (newTab) => {
                if (newTab === 'map' && googleMapsLoaded.value) {
                    nextTick(() => initMap());
                }
            });
            
            // ä¿®æ­£æˆªæ–·å•é¡Œï¼šappInstance è³¦å€¼èˆ‡ setup å‡½å¼è¿”å›
            appInstance = { 
                activeTab: activeTab, 
                initMap: initMap, 
                currentItinerary: currentItinerary, 
                map: null, 
                markers: [] 
            };

            // é€™æ˜¯ setup å‡½å¼çš„å›å‚³å€¼ï¼Œå°‡æ‰€æœ‰éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•æš´éœ²çµ¦æ¨¡æ¿
            return {
                tabs,
                activeTab,
                travelDates,
                activeDate,
                currentItinerary,
                getCurrentWeather,
                expenses,
                totalExpense,
                shoppingList,
                packingList,
                isModalOpen,
                modalType,
                isEditMode,
                modalTitle,
                tempItem,
                setActiveDate,
                showModal,
                editItem,
                saveItem,
                deleteItem,
                formatDate,
                currentMapLink,
                isGoogleMapsLoaded: googleMapsLoaded,
                initMap
            }
        } // <--- çµæŸ setup å‡½å¼
    }); // <--- çµæŸ createApp å‘¼å«
    
    // **æœ€é—œéµçš„ä¸€æ­¥ï¼šå°‡ Vue æ‡‰ç”¨ç¨‹å¼æ›è¼‰åˆ° DOM ä¸Š**
    app.mount('#app');
    
    // é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼å®¹å™¨
    showApp(); 
}

// å¦‚æœ Google Maps API è¼ƒæ—©è¼‰å…¥ï¼Œå®ƒæœƒå‘¼å« initAppï¼Œå…¶ä¸­åŒ…å« mountVueAppã€‚
// å¦‚æœ API è¼‰å…¥è¼ƒæ…¢ï¼Œæˆ‘å€‘åœ¨é€™è£¡æ‰‹å‹•å‘¼å« mountVueApp
if (typeof google === 'undefined' || !googleMapsLoaded.value) {
    // ç¢ºä¿åªåœ¨ Google Maps API æœªè¼‰å…¥æ™‚åŸ·è¡Œï¼Œé¿å…é›™é‡åˆå§‹åŒ–
    if (!appInstance) {
        // åœ¨ DOM è¼‰å…¥å®Œæˆå¾Œå˜—è©¦æ›è¼‰ Vue App
        document.addEventListener('DOMContentLoaded', () => {
            if (!appInstance) {
                mountVueApp();
            }
        });
        
        // å¦‚æœ DOM å·²ç¶“è¼‰å…¥ï¼Œç›´æ¥å˜—è©¦æ›è¼‰
        if (document.readyState !== 'loading') {
            mountVueApp();
        }
    }
} else if (googleMapsLoaded.value && !appInstance) {
    // å¦‚æœ googleMapsLoaded å·²ç¶“æ˜¯ true ä½† appInstance å°šæœªå»ºç«‹ (ä¸å¤ªå¯èƒ½ï¼Œä½†ä½œç‚ºé˜²è­·)
    mountVueApp();
}

</script>

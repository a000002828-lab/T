<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ­æ—…éŠè¦åŠƒ - å‡ç´šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initApp"></script>
    
    <style>
        /* ================================== */
        /* åŒ—æ­æ¥µç°¡é¢¨æ ¼ CSS è®Šæ•¸èˆ‡åŸºæœ¬æ¨£å¼ */
        /* ================================== */
        :root {
            --nordic-blue: #A9D6E5;
            --nordic-light: #E0F2F7; /* æ·ºç°è‰²/é›ªç™½è‰² */
            --nordic-dark: #014F86; /* æ·±æµ·è— */
            --nordic-accent: #02B8D2; /* æ¹–æ°´è—/é»ç¶´è‰² */
        }
        body {
            background-color: var(--nordic-light);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--nordic-dark);
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--nordic-light);
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        .header-bg {
            background-color: var(--nordic-blue);
            background-image: linear-gradient(135deg, var(--nordic-blue) 0%, #61A5C2 100%);
            color: white;
            padding: 1.5rem 1rem 3rem;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* æ—¥æœŸæŒ‰éˆ•é¢¨æ ¼ */
        .tab-date-active {
            background-color: var(--nordic-dark); 
            color: var(--nordic-light);
            border-color: var(--nordic-dark);
            box-shadow: 0 2px 8px rgba(0, 79, 134, 0.3); 
        }

        /* åœ°åœ–ç›¸é—œæ¨£å¼ */
        .map-container {
            height: 320px; 
            width: 100%;
        }
        .map-hidden {
            visibility: hidden;
            height: 0;
            margin-bottom: 0 !important;
            padding: 0 !important;
        }
    </style>
</head>
<body>

<div id="app" class="app-container hidden"> 
    
    <div class="header-bg relative mb-[-2rem]">
        <h1 class="text-2xl font-bold mb-1">â„ï¸ åŒ—æ­æ¥µç°¡ä¹‹æ—…</h1>
        <p class="text-sm opacity-90">æ—…è¡Œæ—¥æœŸ: {{ formatDate(travelDates[0]) }} - {{ formatDate(travelDates[travelDates.length - 1]) }}</p>
        <div class="absolute top-4 right-4 text-sm opacity-90">
            1 EUR â‰ˆ 8.5 HKD
        </div>
    </div>
    
    <div class="relative z-10 mx-4 overflow-x-scroll pb-2" v-if="travelDates.length && (activeTab === 'itinerary' || activeTab === 'map')">
        <div class="flex space-x-2 p-1 bg-white rounded-xl shadow-xl">
            <template v-for="(date, index) in travelDates" :key="index">
                <button 
                    @click="setActiveDate(date)" 
                    :class="{'tab-date-active': activeDate === date, 'bg-gray-100 text-gray-700 hover:bg-gray-200': activeDate !== date}"
                    class="flex-shrink-0 text-xs font-semibold px-3 py-1.5 transition-all rounded-lg"
                >
                    <span class="block text-sm font-bold">Day {{ index + 1 }}</span>
                    <span class="block text-xs font-normal opacity-90 mt-0.5">{{ formatDate(date) }}</span>
                </button>
            </template>
        </div>
    </div>

    <div class="p-4 pt-6" v-if="travelDates.length">
        
        <div v-show="activeTab === 'itinerary'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">ğŸ—“ï¸ {{ formatDate(activeDate) }} è¡Œç¨‹å®‰æ’</h2>
                <button @click="showModal('itinerary')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢è¡Œç¨‹
                </button>
            </div>
            
            <div class="card p-4 mb-6 flex items-center justify-between bg-white/80 backdrop-blur-sm border-l-4 border-nordic-accent">
                <div class="flex items-center">
                    <div class="text-4xl mr-4">{{ getCurrentWeather().icon }}</div>
                    <div>
                        <p class="font-semibold text-gray-800">å¥§æ–¯é™¸ - {{ formatDate(activeDate) }}</p>
                        <p class="text-sm text-gray-500">{{ getCurrentWeather().desc }}</p>
                    </div>
                </div>
                <p class="text-3xl font-extrabold text-nordic-dark">{{ getCurrentWeather().temp }}</p>
            </div>

            <div class="space-y-4">
                <div v-for="element in currentItinerary" :key="element.id" 
                    class="card p-4 relative border-l-4" 
                    :class="{'border-red-400': element.category === 'èˆªç­', 'border-green-400': element.category === 'ç¾é£Ÿ', 'border-nordic-blue': element.category === 'æ™¯é»', 'border-yellow-400': element.category === 'äº¤é€š', 'border-purple-400': element.category === 'ä½å®¿'}"
                >
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="text-sm font-medium text-gray-500 mb-1">
                                {{ element.time }} 
                                <span :class="{'bg-red-100 text-red-700': element.category === 'èˆªç­', 'bg-nordic-light text-nordic-dark': element.category !== 'èˆªç­'}" class="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold">{{ element.category }}</span>
                            </p>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">{{ element.location }}</h3>
                            <p v-if="element.notes" class="text-sm text-gray-600 border-l-2 border-gray-200 pl-2 mt-2 italic">å‚™è¨»: {{ element.notes }}</p>
                        </div>
                        <div class="flex space-x-1 ml-4">
                            <button @click="editItem('itinerary', element)" class="text-gray-400 hover:text-blue-500 p-1">âœï¸</button>
                            <button @click="deleteItem('itinerary', element.id)" class="text-gray-400 hover:text-red-500 p-1">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            </div>
            <p v-if="currentItinerary.length === 0" class="text-center text-gray-500 p-6">æœ¬æ—¥ç„¡è¡Œç¨‹å®‰æ’ã€‚å¿«é»æ“Šã€Œ+ æ–°å¢è¡Œç¨‹ã€å§ï¼</p>
        </div>

        <div v-show="activeTab === 'map'">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“ ç•¶æ—¥è¡Œç¨‹åœ°åœ–èˆ‡å°èˆª ({{ formatDate(activeDate) }})</h2>
            
            <div id="googleMapWrapper" class="card mb-4 map-container" :class="{'map-hidden': activeTab !== 'map'}">
                <div id="googleMap" class="map-container">
                    <div v-if="!isGoogleMapsLoaded" class="flex items-center justify-center h-full text-gray-500">
                        åœ°åœ–æœå‹™è¼‰å…¥ä¸­... (è«‹ç¢ºèª API Key æ˜¯å¦æœ‰æ•ˆ)
                    </div>
                </div>
            </div>
            
            <p class="text-sm text-gray-600 p-2 border-l-4 border-nordic-dark bg-nordic-light/50">åœ°åœ–å·²æ¨™è¨˜**{{ currentItinerary.filter(i => i.lat).length }}å€‹åœ°é»**ï¼Œä¸¦å˜—è©¦é¡¯ç¤ºæ‚¨çš„**ç•¶å‰ä½ç½®**ã€‚</p>
            <a :href="currentMapLink" target="_blank" class="block mt-4 text-center py-3 bg-nordic-dark text-white rounded-xl font-semibold hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                é–‹å•Ÿ Google åœ°åœ–å°èˆª
            </a>
        </div>
        
        <div v-show="activeTab === 'packing'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">ğŸ§³ æ¬²å¸¶è¡Œæè£å‚™ ({{ packingList.filter(i => i.packed).length }}/{{ packingList.length }} å·²æ‰“åŒ…)</h2>
                <button @click="showModal('packing')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢è£å‚™
                </button>
            </div>
            
            <div class="space-y-3">
                <div v-for="item in packingList" :key="item.id" class="card p-4 flex items-center justify-between transition-opacity border-l-4 border-nordic-accent" :class="{'opacity-50 line-through bg-green-50/50 border-green-400': item.packed}">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" v-model="item.packed" class="h-5 w-5 text-nordic-dark rounded border-gray-300 focus:ring-nordic-accent">
                        <span class="ml-3 text-lg font-medium text-gray-800">{{ item.name }}</span>
                    </label>
                    <button @click="deleteItem('packing', item.id)" class="text-gray-400 hover:text-red-500 p-2">ğŸ—‘ï¸</button>
                </div>
            </div>
            <p v-if="packingList.length === 0" class="text-center text-gray-500 p-6">è£å‚™æ¸…å–®å·²æ¸…ç©ºï¼Œåˆ¥å¿˜äº†å¸¶è­·ç…§ï¼</p>
        </div>

        <div v-show="activeTab === 'accounting'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">ğŸ’° è¨˜å¸³ç³»çµ± (å¯æ–°å¢/åˆªé™¤)</h2>
                <button @click="showModal('accounting')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢èŠ±è²»
                </button>
            </div>
            
            <div class="card p-4 mb-4 text-center bg-gray-50/80 border-l-4 border-red-500">
                <p class="text-sm text-gray-600">ç¸½æ”¯å‡º (HKD)</p>
                <p class="text-4xl font-extrabold text-red-600">HK$ {{ totalExpense.toFixed(2) }}</p>
                <p class="text-sm text-gray-500 mt-1">ç´¯ç©æ”¯å‡º (EUR) ç´„ â‚¬{{ (totalExpense / 8.5).toFixed(2) }} (ä»¥ 1 EUR â‰ˆ 8.5 HKD ä¼°ç®—)</p>
            </div>

            <div class="space-y-3">
                <div v-for="expense in expenses.slice().reverse()" :key="expense.id" class="card p-3 flex justify-between items-center border-l-4 border-red-500">
                    <div>
                        <p class="font-semibold text-gray-800">{{ expense.item }}</p>
                        <p class="text-xs text-gray-500">{{ expense.date }} - {{ expense.method }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-red-600">- HK$ {{ expense.amount.toFixed(2) }}</p>
                        <button @click="deleteItem('accounting', expense.id)" class="text-xs text-gray-400 hover:text-red-500">åˆªé™¤</button>
                    </div>
                </div>
            </div>
            <p v-if="expenses.length === 0" class="text-center text-gray-500 p-6">å°šæœªæ–°å¢ä»»ä½•èŠ±è²»ã€‚</p>
        </div>

        <div v-show="activeTab === 'shopping'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">ğŸ›ï¸ è³¼ç‰©é é¢ (å¯æ–°å¢/åˆªé™¤)</h2>
                <button @click="showModal('shopping')" class="flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> æ–°å¢é …ç›®
                </button>
            </div>
            
            <div class="space-y-3">
                <div v-for="item in shoppingList" :key="item.id" class="card p-4 flex items-center justify-between transition-opacity border-l-4 border-nordic-accent" :class="{'opacity-50 line-through bg-green-50/50 border-green-400': item.done}">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" v-model="item.done" class="h-5 w-5 text-nordic-dark rounded border-gray-300 focus:ring-nordic-accent">
                        <span class="ml-3 text-lg font-medium text-gray-800">{{ item.name }}</span>
                    </label>
                    <button @click="deleteItem('shopping', item.id)" class="text-gray-400 hover:text-red-500 p-2">ğŸ—‘ï¸</button>
                </div>
            </div>
            <p v-if="shoppingList.length === 0" class="text-center text-gray-500 p-6">è³¼ç‰©æ¸…å–®å·²æ¸…ç©ºï¼</p>
        </div>
        
    </div>

    <div class="sticky bottom-0 bg-white/95 backdrop-blur-sm shadow-2xl p-3 mt-8 z-30" v-if="travelDates.length">
        <div class="flex justify-around text-gray-500">
            <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                :class="{'text-nordic-dark font-bold': activeTab === tab.id, 'hover:text-nordic-blue': activeTab !== tab.id}"
                class="flex flex-col items-center text-xs transition-colors p-1"
            >
                <span class="text-2xl" v-html="tab.icon"></span>
                <span>{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <div v-if="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-nordic-dark">
                {{ modalTitle }}
            </h3>
            
            <div v-if="modalType === 'itinerary'">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">æ™‚é–“</label>
                    <input type="text" v-model="tempItem.time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" placeholder="ä¾‹å¦‚: 10:00">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">åœ°é»åç¨±</label>
                    <input type="text" v-model="tempItem.location" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" placeholder="ä¾‹å¦‚: å¥§æ–¯é™¸æ­ŒåŠ‡é™¢">
                </div>
                 <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">é¡åˆ¥</label>
                    <select v-model="tempItem.category" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5">
                        <option>æ™¯é»</option>
                        <option>ç¾é£Ÿ</option>
                        <option>äº¤é€š</option>
                        <option>èˆªç­</option>
                        <option>ä½å®¿</option>
                        <option>å…¶ä»–</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">å‚™è¨»/è©³ç´°</label>
                    <textarea v-model="tempItem.notes" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" rows="2" placeholder="ä¾‹å¦‚: çˆ¬ä¸Šå±‹é ‚æ‹ç…§ï¼Œè¨˜å¾—ç©¿é˜²æ»‘é‹"></textarea>
                </div>
                <div class="mb-4 text-xs text-gray-500 border-t pt-2">
                    <p>åœ°åœ–ç¶“ç·¯åº¦ (é¸å¡«ï¼Œç”¨æ–¼åœ°åœ–é‡˜é¸)</p>
                    <input type="number" v-model.number="tempItem.lat" class="mt-1 w-1/2 rounded-lg border-gray-300 shadow-sm p-2.5 inline-block" placeholder="ç·¯åº¦ (Lat)">
                    <input type="number" v-model.number="tempItem.lng" class="mt-1 w-1/2 rounded-lg border-gray-300 shadow-sm p-2.5 inline-block" placeholder="ç¶“åº¦ (Lng)">
                </div>
            </div>

            <div v-else-if="modalType === 'packing'">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">è£å‚™åç¨±</label>
                    <input type="text" v-model="tempItem.name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" placeholder="ä¾‹å¦‚: ç¦¦å¯’æ‰‹å¥—">
                </div>
            </div>

            <div v-else-if="modalType === 'accounting'">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">é …ç›®</label>
                    <input type="text" v-model="tempItem.item" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" placeholder="ä¾‹å¦‚: æ™šé¤è²»ç”¨">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">é‡‘é¡ (HKD)</label>
                    <input type="number" v-model.number="tempItem.amount" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">æ”¯ä»˜æ–¹å¼</label>
                    <select v-model="tempItem.method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5">
                        <option>ç¾é‡‘</option>
                        <option>ä¿¡ç”¨å¡</option>
                        <option>è¡Œå‹•æ”¯ä»˜</option>
                    </select>
                </div>
            </div>

            <div v-else-if="modalType === 'shopping'">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">å¾…è²·é …ç›®</label>
                    <input type="text" v-model="tempItem.name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5" placeholder="ä¾‹å¦‚: èŠ¬è˜­åˆ€">
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button @click="isModalOpen = false" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">å–æ¶ˆ</button>
                <button @click="saveItem" class="px-4 py-2 bg-nordic-dark text-white rounded-lg hover:bg-nordic-blue hover:text-nordic-dark transition-colors font-semibold">{{ isEditMode ? 'æ›´æ–°' : 'å„²å­˜' }}</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, nextTick, watch } = Vue

let appInstance = null;
let googleMapsLoaded = ref(false); 
let mapInitialized = false; 
let appReadyToDisplay = false; 

// Google Maps callback å‡½å¼
window.initApp = function() {
    googleMapsLoaded.value = true;
    if (appInstance && appInstance.activeTab === 'map') {
        nextTick(() => appInstance.initMap());
    } else if (!appInstance) {
        mountVueApp();
    }
}

function initMap() {
    if (!googleMapsLoaded.value || typeof google === 'undefined') return;
    
    const mapElement = document.getElementById('googleMap');
    if (!mapElement) return;

    // ç¯©é¸å‡ºç•¶å¤©æ‰€æœ‰æœ‰ç¶“ç·¯åº¦çš„åœ°é»
    const locations = appInstance.currentItinerary.filter(item => item.lat && item.lng);
    
    let center = { lat: 60.12816, lng: 18.6435 }; // åŒ—æ­ä¸­å¿ƒé»
    let zoom = 5;

    if (locations.length > 0) {
        // å¦‚æœæœ‰å¤šå€‹åœ°é»ï¼Œå˜—è©¦è¨ˆç®—ä¸­å¿ƒé»
        if (locations.length > 1) {
            const sumLat = locations.reduce((sum, item) => sum + item.lat, 0);
            const sumLng = locations.reduce((sum, item) => sum + item.lng, 0);
            center = { lat: sumLat / locations.length, lng: sumLng / locations.length };
            zoom = 10; // ç¸®å°ä¸€é»ä»¥é¡¯ç¤ºå¤šå€‹é»
        } else {
            // åªæœ‰ä¸€å€‹åœ°é»ï¼Œä»¥è©²é»ç‚ºä¸­å¿ƒ
            center = { lat: locations[0].lat, lng: locations[0].lng };
            zoom = 12;
        }
    }
    
    const markerColor = '#014F86'; 

    if (!mapInitialized) {
        appInstance.map = new google.maps.Map(mapElement, {
            zoom: zoom,
            center: center,
            mapId: "DEMO_MAP_ID" 
        });
        mapInitialized = true;
    } else {
        appInstance.map.setCenter(center);
        appInstance.map.setZoom(zoom);
    }
    
    // æ¸…é™¤èˆŠçš„æ¨™è¨˜
    if (appInstance.markers) {
        appInstance.markers.forEach(marker => marker.setMap(null));
    }
    appInstance.markers = [];

    // æ¨™è¨˜æ–°çš„åœ°é» (æŒ‰é †åºç·¨è™Ÿ)
    locations.forEach((item, index) => {
        const marker = new google.maps.Marker({
            position: { lat: item.lat, lng: item.lng },
            map: appInstance.map,
            title: `${index + 1}. ${item.location}`,
            label: (index + 1).toString(),
            icon: {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="${markerColor}"/><text x="12" y="16" font-family="Arial" font-size="12" fill="white" text-anchor="middle" dominant-baseline="middle">${index + 1}</text></svg>`),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
        appInstance.markers.push(marker);
    });

    // é¡¯ç¤ºç¾åœ¨ä½ç½®
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                
                new google.maps.Marker({
                    position: pos,
                    map: appInstance.map,
                    title: 'Your Location (ç¾åœ¨ä½ç½®)',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });

                // å¦‚æœç•¶å¤©æ²’æœ‰è¨­å®šåœ°é»ï¼Œä»¥ç¾åœ¨ä½ç½®ç‚ºä¸­å¿ƒ
                if (locations.length === 0) {
                    appInstance.map.setCenter(pos);
                    appInstance.map.setZoom(14);
                }
            },
            (error) => {
                console.error("Geolocation failed:", error);
            }
        );
    }
    
    google.maps.event.trigger(mapElement, 'resize');
}

// ä¿®æ­£æ—¥æœŸç‚º 12/19 - 1/3
function getTravelDates() {
    const start = new Date('2025-12-19T00:00:00');
    const end = new Date('2026-01-03T00:00:00');
    const dates = [];
    let currentDate = new Date(start);
    while (currentDate <= end) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
}

function showApp() {
    if (appReadyToDisplay) return;

    const appElement = document.getElementById('app');
    if (appElement) {
        appElement.classList.remove('hidden');
    }
    appReadyToDisplay = true;
}


function mountVueApp() {
    const app = createApp({
        setup() {
            const tabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹è¡¨', icon: 'ğŸ—ºï¸' },
                { id: 'map', name: 'åœ°åœ–', icon: 'ğŸ“' },
                { id: 'packing', name: 'è£å‚™', icon: 'ğŸ§³' }, 
                { id: 'accounting', name: 'è¨˜å¸³', icon: 'ğŸ’°' },
                { id: 'shopping', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸' },
            ];
            const activeTab = ref('itinerary');
            
            const travelDates = getTravelDates();
            const activeDate = ref(travelDates[0]); 
            
            // ===========================================
            // START: å¡«å……çš„åŒ—æ­è¡Œç¨‹ (12/19/2025 - 01/03/2026) - ä¾†è‡ª ç¸½è¡Œç¨‹.csv 
            // ===========================================
            const itinerary = ref({
                '2025-12-19': [{ id: 1, time: '16:00', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', category: 'èˆªç­', notes: 'ç¢ºèªç™»æ©Ÿè­‰èˆ‡è¡Œæ', lat: 25.0777, lng: 121.2298 }],
                '2025-12-20': [{ id: 2, time: '12:00', location: 'æŠµé”æ–¯å¾·å“¥çˆ¾æ‘© (ARN)', category: 'äº¤é€š', notes: 'æ­ä¹˜æ©Ÿå ´å¿«ç·šå‰å¾€å¸‚å€', lat: 59.6498, lng: 17.9238 }],
                '2025-12-21': [{ id: 3, time: '10:00', location: 'ç“¦è–©è™Ÿæˆ°è‰¦åšç‰©é¤¨', category: 'æ™¯é»', notes: 'åƒè§€åä¸ƒä¸–ç´€çš„æ²‰èˆ¹', lat: 59.3281, lng: 18.0906 }],
                '2025-12-22': [{ id: 4, time: '13:00', location: 'å¾·æ´›æ±€ç½•å®®', category: 'æ™¯é»', notes: 'æœ‰ã€åŒ—æ–¹å‡¡çˆ¾è³½å®®ã€ä¹‹ç¨±', lat: 59.3235, lng: 17.8860 }],
                '2025-12-23': [{ id: 5, time: '12:00', location: 'æ–¯å¾·å“¥çˆ¾æ‘©æ©Ÿå ´ (ARN)', category: 'èˆªç­', notes: 'æ­æ©Ÿå‰å¾€å†°å³¶é¦–éƒ½é›·å…‹é›…æœªå…‹', lat: 59.6498, lng: 17.9238 }],
                '2025-12-24': [{ id: 6, time: '15:00', location: 'è—è‰²æº«æ³‰æ¹– (Blue Lagoon)', category: 'æ™¯é»', notes: 'äº«å—æˆ¶å¤–æº«æ³‰', lat: 63.8810, lng: -22.4271 }],
                '2025-12-25': [{ id: 7, time: '10:00', location: 'å“ˆçˆ¾æ ¼æ—å§†æ•™å ‚', category: 'æ™¯é»', notes: 'é›·å…‹é›…æœªå…‹åœ°æ¨™ï¼Œå¯ç™»é ‚çœ‹å¸‚æ™¯', lat: 64.1417, lng: -21.9261 }],
                '2025-12-26': [{ id: 8, time: '09:00', location: 'è¾›æ ¼ç¶­åˆ©çˆ¾åœ‹å®¶å…¬åœ’', category: 'æ™¯é»', notes: 'æ­ç¾æ¿å¡Šäº¤ç•Œè™•ï¼Œä¸–ç•Œéºç”¢', lat: 64.2559, lng: -21.1328 }],
                '2025-12-27': [{ id: 9, time: '10:00', location: 'Geysir é–“æ­‡å™´æ³‰å€', category: 'æ™¯é»', notes: 'ç­‰å¾…å²æ‰˜å…‹é–“æ­‡æ³‰å™´ç™¼', lat: 64.3138, lng: -20.3060 }],
                '2025-12-28': [{ id: 10, time: '08:00', location: 'å¡é‡Œé›…è˜­ç€‘å¸ƒ', category: 'æ™¯é»', notes: 'å¯èµ°åˆ°ç€‘å¸ƒå¾Œæ–¹', lat: 63.6335, lng: -19.9886 }],
                '2025-12-29': [{ id: 11, time: '12:00', location: 'é›·å…‹é›…æœªå…‹æ©Ÿå ´ (KEF)', category: 'èˆªç­', notes: 'æ­æ©Ÿå‰å¾€æŒªå¨å¥§æ–¯é™¸', lat: 63.9828, lng: -22.6074 }],
                '2025-12-30': [{ id: 12, time: '10:00', location: 'å¥§æ–¯é™¸æ­ŒåŠ‡é™¢', category: 'æ™¯é»', notes: 'çˆ¬ä¸Šå±‹é ‚æ¬£è³å¸‚æ™¯', lat: 59.9079, lng: 10.7511 }],
                '2025-12-31': [{ id: 13, time: '11:00', location: 'é˜¿å…‹ä»€èƒ¡æ–¯åŸå ¡ (Akershus Festning)', category: 'æ™¯é»', notes: 'ä¸­ä¸–ç´€åŸå ¡ï¼Œä¿¯ç°æ¸¯å£', lat: 59.9077, lng: 10.7352 }],
                '2026-01-01': [{ id: 14, time: '12:00', location: 'è’™å…‹ç¾è¡“é¤¨ (Munchmuseet)', category: 'æ™¯é»', notes: 'æ¬£è³æŒªå¨åœ‹å¯¶ç´šè—è¡“å®¶æ„›å¾·è¯Â·è’™å…‹çš„ä½œå“', lat: 59.9038, lng: 10.7788 }],
                '2026-01-02': [{ id: 15, time: '10:00', location: 'å¥§æ–¯é™¸æ©Ÿå ´ (OSL)', category: 'èˆªç­', notes: 'æ­æ©Ÿå‰å¾€ä¸¹éº¥å“¥æœ¬å“ˆæ ¹ï¼Œæº–å‚™å›ç¨‹è½‰æ©Ÿ', lat: 60.1939, lng: 11.1004 }],
                '2026-01-03': [{ id: 16, time: '08:00', location: 'å“¥æœ¬å“ˆæ ¹æ©Ÿå ´ (CPH)', category: 'èˆªç­', notes: 'è¾¦ç†é€€ç¨…æ‰‹çºŒï¼Œæº–å‚™æ­æ©Ÿè¿”ç¨‹', lat: 55.6268, lng: 12.6558 }],
            });
            // ===========================================
            // END: å¡«å……çš„åŒ—æ­è¡Œç¨‹
            // ===========================================

            const currentItinerary = computed(() => itinerary.value[activeDate.value] || []);
            // ç”±æ–¼åœ°é»æœƒéš¨æ—¥æœŸæ”¹è®Šï¼Œé€™è£¡åªæä¾›ä¸€å€‹åŒ—æ­å†¬å­£çš„å¹³å‡å¤©æ°£è³‡è¨Š
            const getCurrentWeather = () => ({ temp: '-3Â°C', desc: 'é™°å¤©ï¼Œå¶æœ‰å°é›ª', icon: 'ğŸŒ¨ï¸' }); 
            
            // ===========================================
            // START: å¡«å……çš„è£å‚™æ¸…å–® - ä¾†è‡ª æ—…è¡Œè£å‚™æ¸…å–®.csv 
            // ===========================================
            const packingList = ref([
                { id: 301, name: 'ç¦¦å¯’è¡£ç‰© (å¤šå±¤æ¬¡)', packed: true },
                { id: 302, name: 'é˜²æ°´å¤–å¥—', packed: false },
                { id: 303, name: 'ä¿æš–å…§è¡£è¤²', packed: true },
                { id: 304, name: 'åœå·¾/æ‰‹å¥—/æ¯›å¸½', packed: true },
                { id: 305, name: 'é›ªåœ°é´/é˜²æ»‘é‹', packed: false },
                { id: 306, name: 'ç›¸æ©Ÿ/å‚™ç”¨é›»æ± ', packed: true },
                { id: 307, name: 'è¡Œå‹•é›»æº', packed: false },
                { id: 308, name: 'è½‰æ¥é ­/å»¶é•·ç·š', packed: true },
                { id: 309, name: 'å€‹äººè—¥å“', packed: true },
                { id: 310, name: 'è­·ç…§/ç°½è­‰/æ©Ÿç¥¨', packed: true },
            ]);
            // ===========================================
            // END: å¡«å……çš„è£å‚™æ¸…å–®
            // ===========================================

            // é è¨­çš„è¨˜å¸³å’Œè³¼ç‰©æ¸…å–®
            const expenses = ref([{ id: 101, date: '2025-12-19', item: 'æ©Ÿå ´å¿«ç·šè»Šç¥¨', amount: 350.00, method: 'ä¿¡ç”¨å¡' }]);
            const shoppingList = ref([{ id: 201, name: 'èŠ¬è˜­åˆ€', done: false }]);


            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
            
            const isModalOpen = ref(false);
            const modalType = ref('');
            const isEditMode = ref(false);
            const editingId = ref(null);
            
            const modalTitle = computed(() => {
                if (isEditMode.value) return 'ç·¨è¼¯é …ç›®';
                switch (modalType.value) {
                    case 'itinerary': return 'æ–°å¢è¡Œç¨‹é …ç›®';
                    case 'packing': return 'æ–°å¢è£å‚™';
                    case 'accounting': return 'æ–°å¢èŠ±è²»ç´€éŒ„';
                    case 'shopping': return 'æ–°å¢è³¼ç‰©é …ç›®';
                    default: return 'æ–°å¢é …ç›®';
                }
            });
            const tempItem = ref({});
            
            function setActiveDate(date) {
                activeDate.value = date;
                if (activeTab.value === 'map') {
                    nextTick(() => initMap());
                }
            }
            
            function showModal(type, item = null) {
                modalType.value = type;
                isEditMode.value = !!item;
                
                if (item) {
                    editingId.value = item.id;
                    tempItem.value = { ...item };
                } else {
                    editingId.value = null;
                    switch(type) {
                        case 'itinerary': tempItem.value = { time: '', location: '', category: 'æ™¯é»', notes: '', lat: null, lng: null }; break;
                        case 'packing': tempItem.value = { name: '', packed: false }; break;
                        case 'accounting': tempItem.value = { item: '', amount: null, method: 'ä¿¡ç”¨å¡', date: activeDate.value }; break;
                        case 'shopping': tempItem.value = { name: '', done: false }; break;
                    }
                }
                isModalOpen.value = true;
            }

            function editItem(type, item) {
                showModal(type, item);
            }
            
            function saveItem() {
                const itemToSave = { ...tempItem.value };

                const updateList = (list) => {
                    const index = list.findIndex(i => i.id === editingId.value);
                    if (index !== -1) {
                        list[index] = itemToSave;
                    } else {
                        itemToSave.id = Date.now();
                        list.push(itemToSave);
                    }
                };
                
                if (modalType.value === 'itinerary') {
                    if (!itemToSave.location || !itemToSave.time) return alert('è«‹å¡«å¯«æ™‚é–“å’Œåœ°é»');
                    const list = itinerary.value[activeDate.value] || (itinerary.value[activeDate.value] = []);
                    updateList(list);
                    if (activeTab.value === 'map') nextTick(() => initMap());
                } else if (modalType.value === 'packing') {
                    if (!itemToSave.name) return alert('è«‹å¡«å¯«è£å‚™åç¨±');
                    updateList(packingList.value);
                } else if (modalType.value === 'accounting') {
                    if (!itemToSave.item || !itemToSave.amount) return alert('è«‹å¡«å¯«é …ç›®å’Œé‡‘é¡');
                    if (!isEditMode.value) itemToSave.date = new Date().toISOString().split('T')[0];
                    updateList(expenses.value);
                } else if (modalType.value === 'shopping') {
                    if (!itemToSave.name) return alert('è«‹å¡«å¯«è³¼ç‰©é …ç›®');
                    updateList(shoppingList.value);
                }
                
                isModalOpen.value = false;
            }

            function deleteItem(type, id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) return;

                if (type === 'itinerary') {
                    const list = itinerary.value[activeDate.value];
                    if (list) {
                        const index = list.findIndex(item => item.id === id);
                        if (index !== -1) list.splice(index, 1);
                        if (activeTab.value === 'map') nextTick(() => initMap());
                    }
                } else if (type === 'packing') {
                    const index = packingList.value.findIndex(item => item.id === id);
                    if (index !== -1) packingList.value.splice(index, 1);
                } else if (type === 'accounting') {
                    const index = expenses.value.findIndex(item => item.id === id);
                    if (index !== -1) expenses.value.splice(index, 1);
                } else if (type === 'shopping') {
                    const index = shoppingList.value.findIndex(item => item.id === id);
                    if (index !== -1) shoppingList.value.splice(index, 1);
                }
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }

            const currentMapLink = computed(() => {
                const locations = currentItinerary.value.filter(item => item.lat && item.lng);
                if (locations.length === 0) return 'https://www.google.com/maps/search/åŒ—æ­';
                
                const coords = locations.map(l => `${l.lat},${l.lng}`).join('/');
                return `https://www.google.com/maps/dir/?api=1&destination=${locations[locations.length - 1].lat},${locations[locations.length - 1].lng}&waypoints=${coords}`;
            });

            // è§€å¯Ÿ activeTab è®ŠåŒ–ï¼Œå¦‚æœæ˜¯åˆ‡æ›åˆ° 'map' ä¸”åœ°åœ–å·²è¼‰å…¥ï¼Œå‰‡åˆå§‹åŒ–æˆ–æ›´æ–°åœ°åœ–
            watch(activeTab, (newTab) => {
                if (newTab === 'map' && googleMapsLoaded.value) {
                    // éœ€è¦ nextTick ä¾†ç¢ºä¿ DOM å…ƒç´  #googleMap å·²ç¶“å¯è¦‹ä¸”æ¸²æŸ“å®Œæˆ
                    nextTick(() => initMap());
                }
            });


            return {
                tabs,
                activeTab,
                travelDates,
                activeDate,
                itinerary,
                currentItinerary,
                packingList,
                expenses,
                shoppingList,
                totalExpense,
                
                isModalOpen,
                modalType,
                isEditMode,
                tempItem,
                
                googleMapsLoaded,
                
                setActiveDate,
                showModal,
                editItem,
                saveItem,
                deleteItem,
                formatDate,
                getCurrentWeather,
                currentMapLink,
                initMap, // æš´éœ²çµ¦å¤–éƒ¨å‘¼å«
            };
        }
    });

    appInstance = app.mount('#app');
    // å¦‚æœ Google Maps è¼‰å…¥å®Œæˆï¼Œå°±ç«‹å³é¡¯ç¤º App
    if (googleMapsLoaded.value) {
        showApp();
    } else {
        // å¦‚æœ API Key ç„¡æ•ˆï¼Œä¹Ÿå¼·åˆ¶é¡¯ç¤º Appï¼Œé¿å…ç„¡é™ç­‰å¾…
        setTimeout(showApp, 3000);
    }
}

// å¦‚æœ Google Maps API è…³æœ¬è¼‰å…¥å¤±æ•—ï¼ˆä¾‹å¦‚ API Key ç„¡æ•ˆï¼‰ï¼Œæˆ‘å€‘ä¹Ÿæ‡‰è©²æ›è¼‰ Vue App
if (!window.initApp) {
    window.initApp = mountVueApp;
    // ç«‹å³æ›è¼‰ï¼Œè€Œä¸æ˜¯ç­‰å¾… API
    mountVueApp();
}
</script>

</body>
</html>

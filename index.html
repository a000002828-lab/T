<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北歐極簡之旅計畫 - Nordic Trip V13 (行程可編輯)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 1. Nordic Minimalism + Stronger Snowy Theme Color Palette */
        :root {
            --nordic-bg-soft: #eef4f7; /* Soft light blue/gray for main background (Stronger Nordic winter sky) */
            --nordic-white: #ffffff; /* Pure White for card backgrounds (Snow) */
            --nordic-dark: #343a40; /* Dark text for readability */
            --nordic-muted: #adb5bd; /* Muted gray for secondary text/borders */
            --nordic-accent: #2c6e73; /* Stronger Muted Teal/Pine Green for primary highlight */
            --nordic-christmas: #a7333d; /* Deeper Christmas Red for contrast/alerts/expense */
        }
        
        /* 2. Custom Tailwind-like classes using CSS variables */
        .bg-nordic-soft { background-color: var(--nordic-bg-soft); }
        .bg-nordic-white { background-color: var(--nordic-white); }
        .text-nordic-dark { color: var(--nordic-dark); }
        .text-nordic-accent { color: var(--nordic-accent); }
        .border-nordic-muted { border-color: var(--nordic-muted); }
        .text-nordic-christmas { color: var(--nordic-christmas); }
        
        /* Stronger, clearer shadow for a "floating on snow" effect */
        .shadow-snowy { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); } 
        .shadow-strong { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); } 

        /* Mobile App Container */
        #app {
            max-width: 600px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--nordic-bg-soft); 
            position: relative;
        }

        /* Vue Transition Styles */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        /* Itinerary Date Slider Scrollbar */
        .date-slider::-webkit-scrollbar {
            height: 4px;
        }
        .date-slider::-webkit-scrollbar-thumb {
            background: var(--nordic-muted); 
            border-radius: 2px;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 3. Custom Button Styles for Modal Save/Delete (新增的樣式) */
        .btn-nordic-save {
            background-color: var(--nordic-accent);
            color: var(--nordic-white);
            transition: background-color 0.3s;
        }
        .btn-nordic-save:hover {
            background-color: #26595e; /* Slightly darker teal on hover */
        }
        .btn-nordic-delete {
            background-color: var(--nordic-christmas);
            color: var(--nordic-white);
            transition: background-color 0.3s;
        }
        .btn-nordic-delete:hover {
            background-color: #8c2930; /* Slightly darker red on hover */
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="app">
    <header class="sticky top-0 bg-nordic-soft p-4 flex items-center justify-center z-20">
        <h1 class="text-xl font-extrabold text-nordic-accent">
            {{ headerTitle }}
        </h1>
    </header>

    <main class="flex-grow overflow-y-auto bg-nordic-soft relative">
        <transition name="fade" mode="out-in">
            
            <div v-if="currentTab === 'itinerary'" key="itinerary" class="pb-4">
                
                <div class="sticky top-0 bg-nordic-soft p-2 mb-4 z-10">
                    <div class="date-slider flex overflow-x-scroll space-x-2 pb-2">
                        <button v-for="(day, index) in itinerary" :key="index"
                                @click="selectDay(day)"
                                class="flex-shrink-0 px-3 py-1 text-sm font-medium rounded-full transition-colors border"
                                :class="{
                                    'bg-white border-2 border-nordic-accent text-nordic-accent shadow-md font-bold': selectedDay === day, 
                                    'bg-white border-gray-300 text-nordic-dark hover:bg-gray-100': selectedDay !== day
                                }">
                            {{ day.date.substring(5) }} <span class="text-xs ml-1 opacity-70">({{ day.day_of_week.substring(0, 1) }})</span>
                        </button>
                    </div>
                </div>

                <div class="p-4" v-if="selectedDay">
                    <h2 class="text-2xl font-bold text-nordic-dark mb-4">
                        {{ getFlagEmoji(selectedDay.country_code) }} 
                        {{ selectedDay.date.substring(5) }} - 
                        {{ selectedDay.city_country_zh }}
                    </h2>

                    <div v-if="selectedDay.weather" class="mb-4 p-4 bg-nordic-white rounded-xl shadow-strong border-l-4 border-gray-300 flex items-center">
                        <svg class="w-7 h-7 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <div class="text-sm">
                            <p class="font-bold text-nordic-dark">❄️ 預計天氣</p>
                            <p class="text-gray-500">🌡️ {{ selectedDay.weather['氣溫'] || 'N/A' }} / ☀️ {{ selectedDay.weather['日照'] || 'N/A' }}</p>
                        </div>
                                            </div>

                    <div v-if="selectedDay.aurora_forecast" class="mb-4 p-4 rounded-xl shadow-strong border-l-4 border-nordic-accent bg-nordic-white">
                        <div class="flex items-center">
                            <svg class="w-7 h-7 text-nordic-accent mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 100 4m-4 10a2 2 0 100-4m14 0a2 2 0 100-4m-4 4a2 2 0 100 4m-10 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                            <div class="text-sm">
                                <p class="font-bold text-nordic-dark">🌌 極光預報 (建議)</p>
                                <p class="text-gray-600">**KP 指數：**<span class="font-semibold text-nordic-accent">{{ selectedDay.aurora_forecast['kp_index'] }}</span></p>
                                <p class="text-gray-600">**最佳時間：**{{ selectedDay.aurora_forecast['time_range'] }}</p>
                                <p v-if="selectedDay.aurora_forecast['notes']" class="text-xs text-nordic-accent mt-1">💡 {{ selectedDay.aurora_forecast['notes'] }}</p>
                            </div>
                        </div>
                    </div>
                    

                    <h3 class="text-xl font-bold text-nordic-dark mb-3 border-b border-gray-300 pb-2">當日安排</h3>
                    <div v-for="(item, itemIndex) in selectedDay.events" :key="itemIndex" class="mb-3 bg-nordic-white rounded-xl shadow-strong p-4 border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-nordic-accent">{{ item.time.substring(0, 5) }}</p>
                                <p class="font-medium text-nordic-dark text-lg">{{ item.schedule }}</p>
                            </div>
                            <button @click.stop="openModalForEdit('itinerary', item, itemIndex)" class="text-nordic-accent hover:text-teal-600 transition p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                            </button>
                        </div>
                        
                        <a v-if="item.location" :href="getMapLink(item.location)" target="_blank" class="text-sm text-blue-500 hover:underline flex items-center mt-2 pt-2 border-t border-gray-200">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                            {{ item.location }}
                        </a>
                    </div>
                    
                    <div class="mt-6 p-4 bg-nordic-white rounded-xl shadow-strong text-sm text-gray-500 border border-gray-200">
                        <p class="font-bold text-nordic-dark">🏠 住宿：{{ selectedDay.accommodation }}</p>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === 'checklist'" key="checklist" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">行前裝備清單 📋</h2>
                <p class="text-sm text-gray-500 mb-4">點擊項目可標記為已完成 / 點擊分類標題可展開收合。</p>
                <div v-for="(items, category) in checklist" :key="category" class="mb-3 bg-nordic-white rounded-xl shadow-strong overflow-hidden border border-gray-200">
                    <div @click="toggleChecklist(category)" class="p-4 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <h3 class="text-xl font-bold text-nordic-accent">{{ category }}</h3>
                        <span class="text-sm text-gray-500">{{ getCheckedCount(category) }} / {{ items.length }}</span>
                    </div>
                    
                    <ul v-if="!collapsedChecklist[category]" class="p-4 pt-0 space-y-3">
                        <li v-for="(item, index) in items" :key="index" class="flex items-center text-nordic-dark pt-3 border-t border-gray-200 first:border-t-0">
                            <input type="checkbox" :id="category + index" v-model="item.checked" class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-3 border-gray-300 bg-white">
                            <label :for="category + index" class="text-base flex-grow cursor-pointer" :class="{ 'line-through text-gray-400': item.checked }">
                                {{ item.name }}
                                <span v-if="item.notes" class="text-xs text-gray-500"> ({{ item.notes }})</span>
                            </label>
                            <button @click.stop="showFeatureAlert('編輯清單項目')" class="text-nordic-accent hover:text-teal-600 transition p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <div v-else-if="currentTab === 'accounting'" key="accounting" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">記帳中心 💰</h2>
                <div class="bg-nordic-white rounded-xl shadow-strong p-4 mb-6 border border-gray-200">
                    <p class="text-lg font-bold text-nordic-dark">總支出：<span class="text-nordic-christmas">NT$ {{ totalSpent.toLocaleString() }}</span></p>
                </div>
                
                <h3 class="text-xl font-bold text-nordic-dark mb-3 border-b border-gray-300 pb-2">支出紀錄</h3>
                <div v-if="accounting.length === 0" class="bg-gray-100 text-gray-500 p-4 rounded-xl shadow-snowy text-center border border-gray-200">
                    <p>目前沒有支出紀錄。請點擊右下角按鈕 **+ 新增支出**。</p>
                </div>
                <div v-for="(transaction, index) in accounting" :key="index" class="bg-nordic-white rounded-xl shadow-strong p-4 mb-3 flex justify-between items-center border border-gray-200">
                    <div>
                        <p class="font-medium text-nordic-dark">{{ transaction.description }}</p>
                        <p class="text-sm text-gray-500">{{ transaction.date }} ({{ transaction.category }})</p>
                    </div>
                    <div class="flex items-center">
                        <p class="text-lg font-bold text-nordic-christmas mr-3">
                            - NT$ {{ transaction.amount.toLocaleString() }}
                        </p>
                        <button @click.stop="openModalForEdit('accounting', transaction, index)" class="text-nordic-accent hover:text-teal-600 transition p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === 'shopping'" key="shopping" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">購物清單 🎁</h2>
                <div v-if="shoppingList.length === 0" class="bg-gray-100 text-gray-500 p-4 rounded-xl shadow-snowy text-center mb-4 border border-gray-200">
                    <p>目前沒有購物清單項目。請點擊右下角按鈕 **+ 購物項目**。</p>
                </div>
                <div v-for="(item, index) in shoppingList" :key="index" class="bg-nordic-white rounded-xl shadow-strong p-4 mb-3 flex items-center border border-gray-200">
                    <input type="checkbox" :id="'shop' + index" v-model="item.purchased" class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-3 border-gray-300 bg-white">
                    <label :for="'shop' + index" class="flex-grow text-nordic-dark" :class="{ 'line-through text-gray-400': item.purchased }">
                        <span class="font-medium text-lg">{{ item.name }}</span>
                        <span v-if="item.store" class="text-sm text-gray-500 block">({{ item.store }})</span>
                    </label>
                    <button @click.stop="openModalForEdit('shopping', item, index)" class="text-nordic-accent hover:text-teal-600 transition p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div v-else-if="currentTab === 'info'" key="info" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">實用資訊 💡</h2>
                <div class="space-y-4">
                    <div class="bg-nordic-white rounded-xl shadow-strong p-4 border border-gray-200">
                        <h3 class="text-xl font-bold text-nordic-dark mb-2">資料儲存與編輯說明 (V13 更新)</h3>
                        <p class="text-sm text-nordic-accent mb-2 font-bold">
                            ✅ 行程表、記帳、購物清單皆已完整實作 新增/編輯/刪除 功能！
                        </p>
                        <p class="text-sm text-gray-600">
                            所有數據皆儲存在您的瀏覽器本地儲存 (Local Storage)，重新整理頁面數據不會遺失。
                        </p>
                        <p class="text-xs text-red-500 mt-2">
                            ⚠️ **注意：** 裝備清單的編輯功能仍為模擬。
                        </p>
                    </div>
                </div>
            </div>
            
        </transition>
    </main>
    
    <div class="fixed bottom-24 right-4 z-50">
        <div v-if="isAddMenuOpen" @click.away="isAddMenuOpen = false" class="mb-3 space-y-2">
            
            <button v-if="currentTab === 'shopping'" @click.prevent="openModalForAdd('shopping')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-medium rounded-lg shadow-strong hover:bg-gray-100 transition border border-gray-300">
                + 購物項目
            </button>
            <button v-if="currentTab === 'accounting'" @click.prevent="openModalForAdd('accounting')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-medium rounded-lg shadow-strong hover:bg-gray-100 transition border border-gray-300">
                + 新增支出
            </button>
            <button v-if="currentTab === 'itinerary'" @click.prevent="openModalForAdd('itinerary')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-medium rounded-lg shadow-strong hover:bg-gray-100 transition border border-gray-300">
                + 新增行程 ({{ selectedDay ? selectedDay.date.substring(5) : '當日' }})
            </button>
            <button v-if="currentTab === 'checklist'" @click.prevent="showFeatureAlert('新增清單')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-medium rounded-lg shadow-strong hover:bg-gray-100 transition border border-gray-300">
                + 新增清單項目
            </button>
        </div>
        
        <button v-if="['itinerary', 'accounting', 'shopping', 'checklist'].includes(currentTab)" 
                @click="isAddMenuOpen = !isAddMenuOpen" 
                class="bg-nordic-accent text-white w-16 h-16 rounded-full flex items-center justify-center shadow-strong hover:bg-teal-700 transition transform hover:rotate-90">
            <svg v-if="!isAddMenuOpen" class="w-9 h-9" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <svg v-else class="w-9 h-9" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <transition name="fade">
        <div v-if="isModalOpen" class="modal-backdrop">
            <div class="bg-nordic-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md border border-gray-300 transform transition-all scale-100">
                <h3 class="text-xl font-bold text-nordic-dark mb-4 border-b pb-2">
                    {{ editingItemIndex === -1 ? `新增${modalTypeLabel}` : `編輯${modalTypeLabel}` }}
                    <span v-if="modalType === 'itinerary'" class="text-base text-gray-500 block"> ({{ selectedDay.date.substring(5) }})</span>
                </h3>
                
                <form @submit.prevent="saveModalItem">
                    
                    <div v-if="modalType === 'itinerary'">
                        <div class="mb-4">
                            <label for="itemTime" class="block text-sm font-medium text-gray-700 mb-1">時間 (HH:MM)</label>
                            <input type="time" id="itemTime" v-model="editingItem.time" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent">
                        </div>
                        <div class="mb-4">
                            <label for="itemSchedule" class="block text-sm font-medium text-gray-700 mb-1">項目/活動</label>
                            <input type="text" id="itemSchedule" v-model="editingItem.schedule" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：狗拉雪橇、晚餐、搭飛機">
                        </div>
                        <div class="mb-4">
                            <label for="itemLocation" class="block text-sm font-medium text-gray-700 mb-1">地點/備註 (選填)</label>
                            <input type="text" id="itemLocation" v-model="editingItem.location"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：Santa's Salmon Place, 路程：4h">
                        </div>
                    </div>
                    
                    <div v-else-if="modalType === 'accounting'">
                        <div class="mb-4">
                            <label for="itemDescription" class="block text-sm font-medium text-gray-700 mb-1">支出描述</label>
                            <input type="text" id="itemDescription" v-model="editingItem.description" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：晚餐、Tivoli門票">
                        </div>
                        <div class="mb-4">
                            <label for="itemAmount" class="block text-sm font-medium text-gray-700 mb-1">金額 (NT$)</label>
                            <input type="number" id="itemAmount" v-model.number="editingItem.amount" required min="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：500">
                        </div>
                        <div class="mb-4 flex space-x-4">
                            <div class="w-1/2">
                                <label for="itemDate" class="block text-sm font-medium text-gray-700 mb-1">日期 (例如：12/20)</label>
                                <input type="text" id="itemDate" v-model="editingItem.date"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                       placeholder="例如：12/20">
                            </div>
                            <div class="w-1/2">
                                <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                                <select id="itemCategory" v-model="editingItem.category"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent">
                                    <option value="餐飲">餐飲</option>
                                    <option value="交通">交通</option>
                                    <option value="住宿">住宿</option>
                                    <option value="購物">購物</option>
                                    <option value="門票/活動">門票/活動</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else-if="modalType === 'shopping'">
                        <div class="mb-4">
                            <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">項目名稱</label>
                            <input type="text" id="itemName" v-model="editingItem.name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：保暖手套、紀念品">
                        </div>
                        <div class="mb-4">
                            <label for="shopStore" class="block text-sm font-medium text-gray-700 mb-1">購買地點/備註 (選填)</label>
                            <input type="text" id="shopStore" v-model="editingItem.store"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                                   placeholder="例如：H&M、機場免稅店">
                        </div>
                        <div class="flex items-center mb-6">
                            <input type="checkbox" id="shopPurchased" v-model="editingItem.purchased" 
                                   class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-2 border-gray-300 bg-white">
                            <label for="shopPurchased" class="text-base text-gray-700">是否已購買？</label>
                        </div>
                    </div>
                    
                    <div v-else>
                        <p class="text-red-500">錯誤：未知的項目類型。</p>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                                                <button v-if="editingItemIndex !== -1" @click.prevent="deleteModalItem"
                                type="button" 
                                class="px-4 py-2 text-sm font-medium rounded-lg btn-nordic-delete">
                            刪除
                        </button>
                        
                        <div class="flex space-x-3 ml-auto">
                            <button @click.prevent="closeModal" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                                取消
                            </button>
                                                        <button type="submit" 
                                    class="px-4 py-2 text-sm font-medium rounded-lg btn-nordic-save">
                                儲存
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </transition>


    <nav class="sticky bottom-0 bg-nordic-soft p-2 z-20">
        <ul class="flex justify-around">
            <li v-for="tab in tabs" :key="tab.id" class="flex-1 text-center">
                <a href="#" @click.prevent="changeTab(tab.id)" 
                   :class="{'flex flex-col items-center p-2 rounded-lg transition-colors': true, 'text-nordic-accent bg-gray-100': currentTab === tab.id, 'text-gray-500 hover:text-nordic-dark': currentTab !== tab.id}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" v-html="tab.icon"></svg>
                    <span class="text-xs mt-1 font-medium">{{ tab.name }}</span>
                </a>
            </li>
        </ul>
    </nav>
</div>

<script>
    // 引入 Vue 3 核心 API (ref 和 watch 用來實現資料持久化)
    const { createApp, computed, ref, watch } = Vue;

    // ----------------------------------------------------
    // 核心資料庫 (數據初始化與預設值)
    // ----------------------------------------------------

    // Google Maps 導航連結生成器
    const getMapLink = (query) => {
        const googleMapLinkMatch = query.match(/http:\/\/googleusercontent\.com\/maps\.google\.com\/\d/);
        if (googleMapLinkMatch) {
            return googleMapLinkMatch[0];
        }
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
    };
    
    // 國旗 Emoji 映射表
    const countryFlagMap = {
        'TW': '🇹🇼',
        'FI': '🇫🇮',
        'NO': '🇳🇴',
        'DK': '🇩🇰',
        'SE': '🇸🇪',
    };

    const getFlagEmoji = (countryCode) => {
        return countryFlagMap[countryCode] || '🌍';
    };

    // ----------------------------------------------------
    // 行程資料 (從前一次的回應複製過來)
    // ----------------------------------------------------
    const defaultItineraryData = [
        // 1. 2025/12/19 (Taiwan)
        {
            date: "2025/12/19", day_of_week: "五", city_country_zh: "臺灣", country_code: "TW",
            weather: null, aurora_forecast: null,
            events: [
                { time: "19:00:00", schedule: "板橋車站集合(約20:30前到桃機一航)", location: "路程：90min" },
                { time: "23:00:00", schedule: "✈華航CI073 TPE 台北 23:05 起飛", location: "路程：15h45m" },
            ],
            accommodation: "飛機上"
        },
        // 2. 2025/12/20 (Helsinki, Finland)
        {
            date: "2025/12/20", day_of_week: "六", city_country_zh: "赫爾辛基", country_code: "FI",
            // 保持天氣預設值
            weather: { '氣溫': '約 -6°C 到 0°C', '日照': '約 6 小時', '降水': '常有降雪或雨夾雪' }, aurora_forecast: null,
            events: [
                { time: "07:00:00", schedule: "✈07:50抵達 AMS阿姆斯特丹", location: "轉機" },
                { time: "11:00:00", schedule: "✈芬蘭航空AY1302 AMS阿姆斯特丹 11:20 起飛", location: "路程：2h25m" },
                { time: "14:00:00", schedule: "✈14:45抵達 HEL赫爾辛基", location: "" },
                { time: "16:00:00", schedule: "🧳放行李", location: "" },
                { time: "17:00:00", schedule: "🎄Chrismas market", location: "備註：https://tuomaanmarkkinat.fi/en/" },
                { time: "17:00:00", schedule: "♨️Sauna (2 hr)", location: "備註：Löyly Helsinki" }, 
                { time: "19:00:00", schedule: "🥣Sea horse resturant", location: "" },
                { time: "21:00:00", schedule: "Bar Kallio or center", location: "備註：Beer or cocktail? Karaoke or club?" },
            ],
            accommodation: "老人家"
        },
        // 3. 2025/12/21 (Helsinki, Finland)
        {
            date: "2025/12/21", day_of_week: "日", city_country_zh: "赫爾辛基", country_code: "FI",
            weather: { '氣溫': '約 -15°C 到 -7°C', '日照': '極夜微光', '備註': '極地寒冷，需注意保暖' }, aurora_forecast: null,
            events: [
                { time: "10:00:00", schedule: "☕️Cafe Regatta (肉桂小屋)", location: "備註：海邊" },
                { time: "11:00:00", schedule: "Temppeliaukio Church (岩石教堂)", location: "" },
                { time: "11:00:00", schedule: "📚Oodi (圖書館)", location: "" },
                { time: "12:00:00", schedule: "🛍️Moomin Shop", location: "" },
                { time: "12:00:00", schedule: "Helsinki Cathedral", location: "備註：https://helsingintuomiokirkko.fi/en/index/uusipaataso.html" },
                { time: "13:00:00", schedule: "🥣Lunch", location: "" },
                { time: "14:00:00", schedule: "Marimekko Outlet Herttoniemi", location: "" },
                { time: "17:00:00", schedule: "coffee or rest", location: "備註：back to put stuff and take swimming suit" },
                { time: "22:00:00", schedule: "Heading to train station", location: "" },
                { time: "23:00:00", schedule: "🚂23:13 前往羅瓦涅米 (夜鋪火車)", location: "" },
            ],
            accommodation: "火車上"
        },
        // 4. 2025/12/22 (Rovaniemi, Finland)
        {
            date: "2025/12/22", day_of_week: "一", city_country_zh: "羅瓦涅米", country_code: "FI",
            weather: { '氣溫': '約 -15°C 到 -7°C', '日照': '極夜微光', '降水': '穩定積雪' },
            aurora_forecast: { 'kp_index': 'Kp 3 (中等)', 'time_range': '22:00 - 02:00', 'notes': '極光熱門點：歐納斯山 (Ounasvaara)' },
            events: [
                { time: "09:00:00", schedule: "🚕09:00 叫車出門", location: "路程：6m (怕前一天極光搞太晚)" },
                { time: "09:00:00", schedule: "✈芬蘭航空AY541 RVN羅瓦涅米 09:10 起飛", location: "路程：1h20m" },
                { time: "10:00:00", schedule: "🚂10:59抵達 羅瓦涅米", location: "路程：10:45 排隊" },
                { time: "11:00:00", schedule: "🧳前往民宿 寄放行李", location: "" },
                { time: "12:00:00", schedule: "🚕前往市區", location: "路程：10m" },
                { time: "16:00:00", schedule: "🥣Nili Restaurant", location: "備註：已訂位 16:00 六位" },
                { time: "18:00:00", schedule: "🚕搭車回民宿等極光團", location: "路程：10m" },
                { time: "19:00:00", schedule: "☀19:00 極光團", location: "備註：Get Your Guide by KW(會派車來民宿接人)" },
            ],
            accommodation: "Villa Muru(KW)"
        },
        // 5. 2025/12/23 (Rovaniemi, Finland)
        {
            date: "2025/12/23", day_of_week: "二", city_country_zh: "羅瓦涅米", country_code: "FI",
            weather: { '氣溫': '約 -10°C 到 -5°C', '日照': '極夜微光', '降水': '常有降雪' },
            aurora_forecast: { 'kp_index': 'Kp 4 (良好)', 'time_range': '21:00 - 01:00', 'notes': '今晚極光活動增強，建議預留追光時間' },
            events: [
                { time: "10:00:00", schedule: "早餐", location: "" },
                { time: "11:00:00", schedule: "聖誕老人村", location: "備註：可寄明信片，拍北極圈線" },
                { time: "14:00:00", schedule: "午餐 (聖誕老人村內)", location: "" },
                { time: "16:00:00", schedule: "Huskies 狗拉雪橇體驗", location: "備註：約 2-3 小時活動" },
                { time: "19:00:00", schedule: "晚餐", location: "" },
                { time: "22:00:00", schedule: "追極光 (自行或跟團)", location: "備註：依天氣和預報調整" },
            ],
            accommodation: "Villa Muru(KW)"
        },
        // 6. 2025/12/24 (Tromsø, Norway)
        {
            date: "2025/12/24", day_of_week: "三", city_country_zh: "特羅姆瑟", country_code: "NO",
            weather: { '氣溫': '約 -5°C 到 3°C', '日照': '極夜，但受墨西哥灣暖流影響氣溫相對溫和', '降水': '可能降雪' },
            aurora_forecast: { 'kp_index': 'Kp 2 (低)', 'time_range': '23:00 - 03:00', 'notes': '市區光害較大，建議參加追光團' },
            events: [
                { time: "10:00:00", schedule: "早餐與整理行李", location: "" },
                { time: "12:00:00", schedule: "✈羅瓦涅米 → 特羅姆瑟 (RVN -> TOS)", location: "轉機點：HEL/OSL" },
                { time: "16:00:00", schedule: "🧳抵達特羅姆瑟，前往住宿並Check-in", location: "" },
                { time: "18:00:00", schedule: "晚餐 (聖誕夜，需提前預訂)", location: "" },
                { time: "20:00:00", schedule: "特羅姆瑟纜車 (Fjellheisen)", location: "備註：上山看夜景，極光備用點" },
            ],
            accommodation: "Airbnb/飯店"
        },
    ];


    // 裝備清單 (預設值)
    const defaultChecklistData = {
        "文件與財物": [
            { name: "護照、簽證、電子機票", checked: false, notes: "影本備份" },
            { name: "信用卡、少量歐元/挪威克朗", checked: false, notes: "建議帶兩張不同銀行卡" },
            { name: "駕照及國際駕照", checked: false, notes: "自駕用" },
            { name: "行程表、飯店/火車訂單", checked: false, notes: "紙本與電子檔" },
        ],
        "保暖衣物 (洋蔥式)": [
            { name: "極地等級羽絨外套", checked: false, notes: "必須防水防風" },
            { name: "發熱內衣/羊毛衛生衣", checked: false, notes: "上衣、褲子至少各3套" },
            { name: "中層保暖衣 (刷毛/羊毛)", checked: false, notes: "毛衣或刷毛外套" },
            { name: "雪褲/防水長褲", checked: false, notes: "防雪地活動濕身" },
            { name: "羊毛襪/厚襪", checked: false, notes: "至少5雙" },
        ],
        "配件與雜物": [
            { name: "保暖手套/防水手套", checked: false, notes: "兩層式，內層可滑手機" },
            { name: "圍巾、毛帽、口罩", checked: false, notes: "極光團必備" },
            { name: "防水雪靴/保暖靴", checked: false, notes: "鞋底要有抓地力" },
            { name: "暖暖包 (貼式/握式)", checked: false, notes: "足夠數量" },
            { name: "萬用轉接頭、延長線", checked: false, notes: "歐洲圓孔" },
        ],
        "攝影與電子產品": [
            { name: "相機、腳架", checked: false, notes: "拍極光用" },
            { name: "額外電池", checked: false, notes: "低溫下電子產品耗電快" },
            { name: "行動電源", checked: false, notes: "確保電量充足" },
        ],
    };

    // 記帳中心 (預設值)
    const defaultAccountingData = [
        { date: "12/10", description: "機票 (台北-赫爾辛基來回)", amount: 35000, category: "交通" },
        { date: "12/10", description: "羅瓦涅米住宿訂金", amount: 15000, category: "住宿" },
        { date: "12/10", description: "羅瓦涅米極光團預訂", amount: 6500, category: "門票/活動" },
        { date: "12/20", description: "赫爾辛基機場快線", amount: 500, category: "交通" },
        { date: "12/20", description: "Sauna門票", amount: 1200, category: "門票/活動" },
    ];

    // 購物清單 (預設值)
    const defaultShoppingListData = [
        { name: "芬蘭Moomin馬克杯", store: "Moomin Shop", purchased: false },
        { name: "挪威傳統毛衣", store: "某紀念品店", purchased: false },
        { name: "極光紀念T恤", store: "聖誕老人村", purchased: false },
        { name: "魚子醬 (丹麥)", store: "機場免稅", purchased: false },
    ];


    // ----------------------------------------------------
    // Vue App 邏輯
    // ----------------------------------------------------

    createApp({
        setup() {
            // --- 數據狀態 ---
            const tabs = [
                { id: 'itinerary', name: '行程表', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>' },
                { id: 'checklist', name: '裝備清單', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>' },
                { id: 'accounting', name: '記帳', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6c0 1.105.9 2 2 2h2m4 0h4m-4 0h6m-6 0h2"></path>' },
                { id: 'shopping', name: '購物清單', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>' },
                { id: 'info', name: '資訊', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
            ];
            const currentTab = ref('itinerary');
            
            // 持久化狀態
            const loadData = (key, defaultData) => {
                try {
                    const json = localStorage.getItem(key);
                    return json ? JSON.parse(json) : defaultData;
                } catch (e) {
                    console.error("Could not load data from localStorage", key, e);
                    return defaultData;
                }
            };

            const saveData = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error("Could not save data to localStorage", key, e);
                }
            };

            const itinerary = ref(loadData('nordicTripItinerary', defaultItineraryData));
            const checklist = ref(loadData('nordicTripChecklist', defaultChecklistData));
            const accounting = ref(loadData('nordicTripAccounting', defaultAccountingData));
            const shoppingList = ref(loadData('nordicTripShoppingList', defaultShoppingListData));
            const selectedDay = ref(itinerary.value[0]);
            const collapsedChecklist = ref({});
            const isAddMenuOpen = ref(false);
            
            // Modal State
            const isModalOpen = ref(false);
            const modalType = ref(''); // 'itinerary', 'accounting', 'shopping'
            const editingItem = ref({});
            const editingItemIndex = ref(-1);
            const parentArrayIndex = ref(-1); // 僅用於行程表 (itinerary) 的 event index

            // --- Watchers (數據持久化) ---
            watch(itinerary, (newVal) => saveData('nordicTripItinerary', newVal), { deep: true });
            watch(checklist, (newVal) => saveData('nordicTripChecklist', newVal), { deep: true });
            watch(accounting, (newVal) => saveData('nordicTripAccounting', newVal), { deep: true });
            watch(shoppingList, (newVal) => saveData('nordicTripShoppingList', newVal), { deep: true });

            // --- Computed Properties ---
            const headerTitle = computed(() => {
                const activeTab = tabs.find(t => t.id === currentTab.value);
                return activeTab ? `北歐極簡之旅 - ${activeTab.name}` : '北歐極簡之旅';
            });

            const totalSpent = computed(() => {
                return accounting.value.reduce((sum, item) => sum + (item.amount || 0), 0);
            });
            
            const modalTypeLabel = computed(() => {
                switch (modalType.value) {
                    case 'itinerary': return '行程項目';
                    case 'accounting': return '支出紀錄';
                    case 'shopping': return '購物項目';
                    default: return '項目';
                }
            });


            // --- Methods ---
            const changeTab = (tabId) => {
                currentTab.value = tabId;
                isAddMenuOpen.value = false; // 切換 Tab 時關閉新增選單
            };

            const selectDay = (day) => {
                selectedDay.value = day;
            };

            const toggleChecklist = (category) => {
                collapsedChecklist.value[category] = !collapsedChecklist.value[category];
            };

            const getCheckedCount = (category) => {
                return checklist.value[category].filter(item => item.checked).length;
            };
            
            const showFeatureAlert = (feature) => {
                alert(`【${feature}】功能：目前此功能為模擬，尚無完整資料編輯和新增實作。`);
                isAddMenuOpen.value = false;
            };

            const closeModal = () => {
                isModalOpen.value = false;
                editingItemIndex.value = -1;
                parentArrayIndex.value = -1;
                editingItem.value = {};
                isAddMenuOpen.value = false;
            };

            const openModalForEdit = (type, item, index) => {
                modalType.value = type;
                editingItem.value = { ...item }; // 複製一份以避免直接修改原始數據
                editingItemIndex.value = index;
                isModalOpen.value = true;
                // 對於行程表，需要記錄是哪一天的行程 (用於保存時更新正確的 events 陣列)
                if (type === 'itinerary') {
                    parentArrayIndex.value = itinerary.value.findIndex(day => day === selectedDay.value);
                }
            };
            
            const openModalForAdd = (type) => {
                modalType.value = type;
                editingItemIndex.value = -1; // -1 表示新增
                isModalOpen.value = true;
                
                // 初始化新增項目
                let newItem = {};
                if (type === 'itinerary') {
                    newItem = { time: '12:00:00', schedule: '', location: '' };
                    parentArrayIndex.value = itinerary.value.findIndex(day => day === selectedDay.value);
                } else if (type === 'accounting') {
                    const today = new Date();
                    const dateString = `${today.getMonth() + 1}/${today.getDate()}`;
                    newItem = { date: dateString, description: '', amount: 0, category: '餐飲' };
                } else if (type === 'shopping') {
                    newItem = { name: '', store: '', purchased: false };
                }
                editingItem.value = newItem;
                isAddMenuOpen.value = false;
            };


            const saveModalItem = () => {
                const item = editingItem.value;
                const index = editingItemIndex.value;

                if (modalType.value === 'itinerary') {
                    const dayEvents = itinerary.value[parentArrayIndex.value].events;
                    if (index === -1) {
                        // Add
                        dayEvents.push(item);
                        dayEvents.sort((a, b) => a.time.localeCompare(b.time)); // 排序
                    } else {
                        // Edit
                        dayEvents[index] = item;
                        dayEvents.sort((a, b) => a.time.localeCompare(b.time)); // 排序
                    }
                } else if (modalType.value === 'accounting') {
                    if (index === -1) {
                        accounting.value.push(item);
                    } else {
                        accounting.value[index] = item;
                    }
                } else if (modalType.value === 'shopping') {
                    if (index === -1) {
                        shoppingList.value.push(item);
                    } else {
                        shoppingList.value[index] = item;
                    }
                }
                
                // 觸發響應式更新並關閉 Modal
                // 由於行程表的變動是在子陣列中，需要明確替換以觸發深度監聽
                if (modalType.value === 'itinerary') {
                    itinerary.value = [...itinerary.value];
                }
                // 確保更新後的資料被存儲
                saveData('nordicTripItinerary', itinerary.value);
                saveData('nordicTripAccounting', accounting.value);
                saveData('nordicTripShoppingList', shoppingList.value);
                closeModal();
            };
            
            const deleteModalItem = () => {
                if (!confirm(`確定要刪除這筆【${modalTypeLabel.value}】嗎？`)) return;
                
                const index = editingItemIndex.value;
                
                if (modalType.value === 'itinerary') {
                    const dayEvents = itinerary.value[parentArrayIndex.value].events;
                    dayEvents.splice(index, 1);
                    itinerary.value = [...itinerary.value];
                    saveData('nordicTripItinerary', itinerary.value);
                } else if (modalType.value === 'accounting') {
                    accounting.value.splice(index, 1);
                    saveData('nordicTripAccounting', accounting.value);
                } else if (modalType.value === 'shopping') {
                    shoppingList.value.splice(index, 1);
                    saveData('nordicTripShoppingList', shoppingList.value);
                }
                
                closeModal();
            };

            // 初始化時確保 selectedDay 有值
            if (!selectedDay.value && itinerary.value.length > 0) {
                selectedDay.value = itinerary.value[0];
            }


            return {
                // Data
                tabs,
                currentTab,
                itinerary,
                checklist,
                accounting,
                shoppingList,
                selectedDay,
                collapsedChecklist,
                isAddMenuOpen,
                // Modal Data
                isModalOpen,
                modalType,
                editingItem,
                editingItemIndex,
                
                // Computed
                headerTitle,
                totalSpent,
                modalTypeLabel,
                
                // Methods
                changeTab,
                selectDay,
                toggleChecklist,
                getCheckedCount,
                showFeatureAlert,
                getFlagEmoji,
                getMapLink,
                // Modal Methods
                openModalForEdit,
                openModalForAdd,
                saveModalItem,
                deleteModalItem,
                closeModal,
            };
        }
    }).mount('#app');
</script>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nordic Trip</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initApp"></script>
    
    <style>
        /* 北歐/下雪風格的客製化樣式 */
        :root {
            --nordic-blue: #A9D6E5;
            --nordic-light: #E0F2F7; /* 淺灰色/雪白色 */
            --nordic-dark: #014F86; /* 深海藍 (高對比色) */
            --nordic-accent: #02B8D2; /* 湖水藍/點綴色 - 用於極光提醒 */
            --nordic-link-blue: #1A73E8; /* 標準 Google 藍 */
        }
        body {
            background-color: var(--nordic-light);
            /* 維持雪花背景，增加簡約感 */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><defs><pattern id="snow" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.8)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23snow)"/></svg>');
            /* 修正字體為 Noto Sans TC */
            font-family: 'Noto Sans TC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--nordic-dark);
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--nordic-light);
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        .header-bg {
            background-color: var(--nordic-blue);
            background-image: linear-gradient(135deg, var(--nordic-blue) 0%, #61A5C2 100%);
            color: white;
            padding: 1.5rem 1rem 3rem;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .date-scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .date-scroll-container::-webkit-scrollbar {
            display: none;
        }
        /* Tab 日期按鈕風格調整 */
        .tab-date-button {
            transition: all 0.3s;
            border-radius: 0.75rem; /* 較圓潤的圓角 */
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: 1px solid var(--nordic-light);
        }
        .tab-date-active {
            background-color: var(--nordic-dark); 
            color: var(--nordic-light);
            border-color: var(--nordic-dark);
            box-shadow: 0 2px 8px rgba(0, 79, 134, 0.3); 
        }

        /* ------------------------------------------- */
        /* ✨ 更改一：Google 連結按鈕改為藍色網址文字 */
        /* ------------------------------------------- */
        .google-link-as-text {
            /* 移除 Tailwind 預設的按鈕樣式 */
            background-color: transparent !important;
            color: var(--nordic-link-blue) !important; /* 標準藍色網址 */
            text-decoration: underline !important; /* 加上底線 */
            padding: 0 !important;
            margin-right: 0 !important;
            font-size: 0.875rem !important; /* text-sm */
            line-height: 1.25rem !important;
            font-weight: 500 !important; /* font-medium */
        }
        .google-link-as-text:hover {
            color: #0d4ac2 !important; /* 懸停時顏色稍深 */
        }

        /* ------------------------------------------- */
        /* ✨ 更改二：新增按鈕顏色調深，與背景高對比 */
        /* ------------------------------------------- */
        /* 應用於所有模態框 (Modal) 內的 '儲存' 按鈕 */
        .modal-save-button,
        /* 應用於 '旅費管理' 頁面和 '購物/裝備清單' 頁面的 '+ 新增' 按鈕 */
        .add-item-button {
            background-color: var(--nordic-dark) !important; /* 深海藍 */
            color: white !important; /* 白色文字 */
            transition: background-color 0.3s;
            /* 確保字體清晰可見 */
            font-weight: 600; 
        }
        .modal-save-button:hover,
        .add-item-button:hover {
            background-color: var(--nordic-accent) !important; /* 懸停時使用點綴藍 */
        }
        /* 應用於地圖頁面的 '開啟 Google 地圖導航' 按鈕 (原本就是深色，加強 hover) */
        .map-navigation-button:hover {
             background-color: var(--nordic-blue) !important; /* 懸停時使用中等藍 */
             color: var(--nordic-dark) !important;
        }
        /* ------------------------------------------- */


        /* 地圖相關樣式 */
        .map-container {
            height: 320px; 
            width: 100%;
        }
        .map-hidden {
            visibility: hidden;
            height: 0;
            margin-bottom: 0 !important;
            padding: 0 !important;
        }

        /* 修正: 讓 SVG 圖標可以被 Tailwind text-color 影響 (適用於底部的 Tab 按鈕) */
        .tab-icon svg {
            stroke-width: 2.5; /* 讓圖標線條更粗一些，更簡潔 */
            width: 28px;
            height: 28px;
            color: inherit; /* 讓 SVG 顏色繼承自父層文字顏色 */
        }
        /* 修正: 讓 SVG 圖標刪除按鈕更統一 */
        .delete-icon svg {
            width: 20px;
            height: 20px;
        }

        /* ------------------------------------------- */
        /* ✨ 更改三：極光 KP 值顯示樣式 */
        /* ------------------------------------------- */
        .aurora-card {
            background-color: #014F86; /* 深藍色背景 */
            background-image: linear-gradient(135deg, #014F86 0%, #02B8D2 100%); /* 深藍到湖水藍漸層 */
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(2, 184, 210, 0.4);
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .aurora-kp {
            font-size: 2.5rem; /* 放大 KP 值 */
            line-height: 1;
            font-weight: 800;
            color: #E0F2F7; /* 淺色文字 */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); /* 輕微光暈效果 */
        }
        .aurora-info p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>

<div id="app" class="app-container hidden"> 
    
    <div class="header-bg relative mb-[-2rem]">
        <h1 class="text-2xl font-bold mb-1">Nordic Trip</h1> <p class="text-sm opacity-90">旅行日期: **12/19/2025 - 01/03/2026**</p>
        <div class="absolute top-4 right-4 text-sm opacity-90">
            1 EUR ≈ 36.3 NT$
        </div>
    </div>
    
    <div class="relative z-10 mx-4 overflow-x-scroll date-scroll-container pb-2" v-if="travelDates.length">
        <div class="flex space-x-2 p-1 bg-white rounded-xl shadow-xl">
            <template v-for="(date, index) in travelDates" :key="index">
                <button 
                    @click="setActiveDate(date)" 
                    :class="{'tab-date-active': activeDate === date, 'bg-gray-100 text-gray-700 hover:bg-gray-200': activeDate !== date}"
                    class="tab-date-button flex-shrink-0 text-xs font-semibold px-3 py-1.5 transition-all"
                >
                    <span class="block text-sm font-bold">Day {{ index + 1 }}</span> <span class="block text-xs font-normal opacity-90 mt-0.5">{{ formatDate(date) }}</span>
                </button>
            </template>
        </div>
    </div>

    <div class="p-4 pt-6" v-if="travelDates.length">
        
        <div v-show="activeTab === 'itinerary'">
            <h2 class="text-xl font-bold text-gray-700 mb-4">行程安排</h2>
            
                                    <div v-if="currentAuroraInfo" class="aurora-card mb-6">
                <div class="flex items-center justify-center space-x-3">
                    <span class="text-3xl">🌌</span>
                    <h3 class="text-lg font-bold">極光預測 - {{ currentCity.split('/')[0] }}</h3>
                    <span class="text-3xl">✨</span>
                </div>
                <div class="flex justify-around items-end mt-3 aurora-info">
                    <div class="text-center">
                        <p class="text-sm opacity-90 mb-1">預測 KP 值</p>
                        <p class="aurora-kp">{{ currentAuroraInfo.kp }}</p>
                        <p class="text-sm opacity-90 mt-1">
                            <span v-if="currentAuroraInfo.kp >= 3" class="text-yellow-300 font-semibold">高機會</span>
                            <span v-else-if="currentAuroraInfo.kp >= 2" class="font-semibold">中等機會</span>
                            <span v-else>低機會</span>
                        </p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm opacity-90 mb-1">最佳觀測時間</p>
                        <p class="text-2xl font-extrabold">{{ currentAuroraInfo.time }}</p>
                        <p class="text-xs opacity-80 mt-1">(當地時間)</p>
                    </div>
                </div>
            </div>
                        <div class="card p-4 mb-6 flex items-center justify-between bg-white/80 backdrop-blur-sm border-l-4 border-nordic-accent">
                <div class="flex items-center">
                    <div class="text-4xl mr-4">{{ getCurrentWeather().icon }}</div>
                    <div>
                        <p class="font-semibold text-gray-800">{{ currentCity }} - {{ formatDate(activeDate) }}</p>
                        <p class="text-sm text-gray-500">{{ getCurrentWeather().desc }}</p>
                    </div>
                </div>
                <p class="text-3xl font-extrabold text-nordic-dark">{{ getCurrentWeather().temp }}</p>
            </div>

            <div class="space-y-4">
                <div v-for="element in currentItinerary" :key="element.id" 
                    class="card p-4 relative border-l-4" 
                    :class="{'border-red-400': element.category === '航班', 'border-green-400': element.category === '美食', 'border-nordic-blue': element.category === '景點', 'border-yellow-400': element.category === '交通', 'border-pink-400': element.category === '住宿', 'border-purple-400': element.category === '購物'}"
                >
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="text-sm font-medium text-gray-500 mb-1">
                                {{ element.time }} 
                                <span :class="{'bg-red-100 text-red-700': element.category === '航班', 'bg-nordic-light text-nordic-dark': element.category !== '航班'}" class="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold">{{ element.category }}</span>
                            </p>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">{{ element.location }}</h3>
                            <p v-if="element.notes" class="text-sm text-gray-600 border-l-2 border-gray-200 pl-2 mt-2 italic">{{ element.notes }}</p>
                            
                            <div v-if="element.lat && element.lng" class="mt-3">
                                <a :href="getGoogleMapLink(element)" target="_blank" class="google-link-as-text text-sm font-medium inline-flex items-center">
                                     查看地圖 🗺️
                                </a>
                            </div>
                            </div>
                        <div class="flex space-x-1 ml-4">
                            <button @click="deleteItem('itinerary', element.id)" class="text-gray-400 hover:text-red-500 p-1 delete-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .527a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.003-2.245a48.156 48.156 0 0 0-4.008 0c-1.093.106-2.003 1.144-2.003 2.245v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <p v-if="currentItinerary.length === 0" class="text-center text-gray-500 p-6">本日無行程安排。</p>
        </div>

        <div v-show="activeTab === 'map'">
            <h2 class="text-xl font-bold text-gray-700 mb-4">當日行程地圖與導航</h2>
            
            <div id="googleMapWrapper" class="card mb-4 map-container" :class="{'map-hidden': activeTab !== 'map'}">
                <div id="googleMap" class="map-container">
                    <div v-if="!isGoogleMapsLoaded" class="flex items-center justify-center h-full text-gray-500">
                        地圖服務載入中... (請確認 API Key 是否有效)
                    </div>
                </div>
            </div>
            
            <p class="text-sm text-gray-600 p-2 border-l-4 border-nordic-dark bg-nordic-light/50">地圖會自動標記**當天所有行程地點**，並顯示您的**當前位置** (需開啟定位權限)。</p>
            <a :href="currentMapLink" target="_blank" class="map-navigation-button block mt-4 text-center py-3 bg-nordic-dark text-white rounded-xl font-semibold hover:bg-nordic-blue transition-colors hover:text-nordic-dark">
                開啟 Google 地圖導航
            </a>
        </div>

        <div v-show="activeTab === 'accounting'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">旅費管理</h2>
                <button @click="showModal('accounting')" class="add-item-button flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> 新增花費
                </button>
            </div>
            
            <div class="card p-4 mb-4 text-center bg-gray-50/80 border-l-4 border-red-500">
                <p class="text-sm text-gray-600">總支出 (NT$)</p>
                <p class="text-4xl font-extrabold text-red-600">NT$ {{ totalExpense.toFixed(0) }}</p>
                <p class="text-sm text-gray-500 mt-1">累積支出 (EUR) 約 €{{ totalExpenseEUR }} (以 1 EUR ≈ 36.3 NT$ 估算)</p>
            </div>

            <div class="space-y-3">
                <div v-for="expense in expenses.slice().reverse()" :key="expense.id" class="card p-3 flex justify-between items-center border-l-4 border-red-500">
                    <div>
                        <p class="font-semibold text-gray-800">{{ expense.item }}</p>
                        <p class="text-xs text-gray-500">{{ expense.date }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-red-600">- NT$ {{ expense.amount.toFixed(0) }}</p>
                        <button @click="deleteItem('accounting', expense.id)" class="text-xs text-gray-400 hover:text-red-500 delete-icon">
                            刪除
                        </button>
                    </div>
                </div>
            </div>
            <p v-if="expenses.length === 0" class="text-center text-gray-500 p-6">尚未新增任何花費。</p>
        </div>

        <div v-show="activeTab === 'shopping'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">待辦/購物清單</h2>
                <button @click="showModal('shopping')" class="add-item-button flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> 新增
                </button>
            </div>
            
            <div class="space-y-3">
                <div v-for="item in shoppingList" :key="item.id" class="card p-4 flex items-center justify-between transition-opacity border-l-4 border-nordic-accent" :class="{'opacity-50 line-through bg-green-50/50 border-green-400': item.done}">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" v-model="item.done" class="h-5 w-5 text-nordic-dark rounded border-gray-300 focus:ring-nordic-accent">
                        <span class="ml-3 text-lg font-medium text-gray-800">{{ item.name }}</span>
                    </label>
                    <button @click="deleteItem('shopping', item.id)" class="text-gray-400 hover:text-red-500 p-2 delete-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .527a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.003-2.245a48.156 48.156 0 0 0-4.008 0c-1.093.106-2.003 1.144-2.003 2.245v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    </button>
                </div>
            </div>
            <p v-if="shoppingList.length === 0" class="text-center text-gray-500 p-6">購物清單已清空！</p>
        </div>

        <div v-show="activeTab === 'checklist'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">旅行裝備清單</h2>
                <button @click="showModal('checklist')" class="add-item-button flex items-center text-sm font-semibold text-white bg-nordic-dark px-3 py-1 rounded-full hover:bg-nordic-blue hover:text-nordic-dark transition-colors">
                    <span class="text-lg">+</span> 新增
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4 p-2 border-l-4 border-nordic-accent bg-nordic-light/50">記得勾選已放入行李箱的物品！</p>
            
            <div class="space-y-3">
                <div v-for="item in travelChecklist" :key="item.id" class="card p-4 flex items-center justify-between transition-opacity border-l-4 border-nordic-dark" :class="{'opacity-50 line-through bg-gray-50/50 border-green-400': item.done}">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" v-model="item.done" class="h-5 w-5 text-nordic-dark rounded border-gray-300 focus:ring-nordic-accent">
                        <span class="ml-3 text-lg font-medium text-gray-800">{{ item.name }}</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <span v-if="item.notes" class="text-xs text-gray-400 hidden sm:block">{{ item.notes }}</span>
                        <button @click="deleteItem('checklist', item.id)" class="text-gray-400 hover:text-red-500 p-2 delete-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .527a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.003-2.245a48.156 48.156 0 0 0-4.008 0c-1.093.106-2.003 1.144-2.003 2.245v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <p v-if="travelChecklist.length === 0" class="text-center text-gray-500 p-6">裝備清單已清空！</p>
        </div>
        </div>

    <div class="sticky bottom-0 bg-white/95 backdrop-blur-sm shadow-2xl p-3 mt-8 z-30" v-if="travelDates.length">
        <div class="flex justify-around text-gray-500">
            <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                :class="{'text-nordic-dark font-bold': activeTab === tab.id, 'hover:text-nordic-blue': activeTab !== tab.id}"
                class="flex flex-col items-center text-xs transition-colors p-1"
            >
                <span class="tab-icon" v-html="tab.icon"></span>
                <span>{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <div v-if="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-nordic-dark">
                {{ modalTitle }}
            </h3>
            
            <div v-if="modalType === 'accounting'">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">項目</label>
                    <input type="text" v-model="tempItem.item" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent" placeholder="例如: 晚餐費用">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">金額 (NT$)</label>
                    <input type="number" v-model.number="tempItem.amount" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent">
                </div>
            </div>

            <div v-else-if="modalType === 'shopping' || modalType === 'checklist'">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">{{ modalType === 'shopping' ? '待買項目' : '裝備名稱' }}</label>
                    <input type="text" v-model="tempItem.name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-nordic-accent focus:ring-nordic-accent" placeholder="例如: 芬蘭刀/厚毛襪">
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button @click="isModalOpen = false" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">取消</button>
                <button @click="saveItem" class="modal-save-button px-4 py-2 bg-nordic-dark text-white rounded-lg hover:bg-nordic-blue hover:text-nordic-dark transition-colors font-semibold">儲存</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, nextTick, watch } = Vue

// --- 全局常數設定 ---
const EXCHANGE_RATE = 36.3; // 1 EUR ≈ 36.3 TWD
const TWD_SYMBOL = 'NT$';
const CITY_MAP = {
    '2025-12-19': '台北/飛機上',
    '2025-12-20': '赫爾辛基',
    '2025-12-21': '赫爾辛基/夜火車',
    '2025-12-22': '羅瓦涅米',
    '2025-12-23': '羅瓦涅米',
    '2025-12-24': '特羅姆瑟',
    '2025-12-25': '特羅姆瑟',
    '2025-12-26': '特羅姆瑟',
    '2025-12-27': '哥本哈根',
    '2025-12-28': '哥本哈根',
    '2025-12-29': '哥本哈根/斯德哥爾摩',
    '2025-12-30': '斯德哥爾摩',
    '2026-01-01': '斯德哥爾摩',
    '2026-01-02': '斯德哥爾摩/飛機上',
    '2026-01-03': '杜拜/飛機上',
};

// -------------------------------------------
// ✨ 更改五：新增極光 KP 值預測資料
// 羅瓦涅米 (Rovaniemi, KP 2 即可見)
// 特羅姆瑟 (Tromsø, KP 0-1 即可見)
// -------------------------------------------
const AURORA_PREDICTIONS = {
    // 羅瓦涅米 (Rovaniemi)
    '2025-12-22': { kp: 3, time: '23:00 - 01:00', city: '羅瓦涅米' },
    '2025-12-23': { kp: 4, time: '22:00 - 02:00', city: '羅瓦涅米' },
    // 特羅姆瑟 (Tromsø)
    '2025-12-24': { kp: 2, time: '20:00 - 23:00', city: '特羅姆瑟' },
    '2025-12-25': { kp: 3, time: '23:30 - 01:30', city: '特羅姆瑟' },
    '2025-12-26': { kp: 1, time: '無明顯峰值', city: '特羅姆瑟' },
};


let appInstance = null;
let googleMapsLoaded = ref(false); 
let mapInitialized = false; 
let appReadyToDisplay = false; 

window.initApp = function() {
    googleMapsLoaded.value = true;
    if (appInstance) {
        if (appInstance.activeTab === 'map' && !mapInitialized) {
             nextTick(() => appInstance.initMap());
        }
    } else {
        mountVueApp();
    }
}

function initMap() {
    if (!googleMapsLoaded.value) {
        return;
    }
    
    const mapElement = document.getElementById('googleMap');
    if (typeof google === 'undefined' || !mapElement) return;

    const locations = appInstance.currentItinerary.filter(item => item.lat && item.lng);
    // 北歐中心點 (挪威/瑞典之間)
    let center = { lat: 60.12816, lng: 18.6435 }; 
    let zoom = 5;

    if (locations.length > 0) {
        center = { lat: locations[0].lat, lng: locations[0].lng };
        zoom = 12;
    }
    
    const markerColor = '#014F86'; // 使用 Nordic Dark 作為標記顏色

    if (!mapInitialized) {
        appInstance.map = new google.maps.Map(mapElement, {
            zoom: zoom,
            center: center,
            mapId: "DEMO_MAP_ID" 
        });
        mapInitialized = true;
    } else {
        appInstance.map.setCenter(center);
        appInstance.map.setZoom(zoom);
    }
    
    if (appInstance.markers) {
        appInstance.markers.forEach(marker => marker.setMap(null));
    }
    appInstance.markers = [];

    locations.forEach((item, index) => {
        const marker = new google.maps.Marker({
            position: { lat: item.lat, lng: item.lng },
            map: appInstance.map,
            title: `${index + 1}. ${item.location}`,
            label: (index + 1).toString(),
            icon: {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="${markerColor}"/><text x="12" y="16" font-family="Arial" font-size="12" fill="white" text-anchor="middle" dominant-baseline="middle">${index + 1}</text></svg>`),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
        appInstance.markers.push(marker);
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                
                new google.maps.Marker({
                    position: pos,
                    map: appInstance.map,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });

                if (locations.length === 0) {
                    appInstance.map.setCenter(pos);
                    appInstance.map.setZoom(14);
                }
            },
            (error) => {
                console.error("Geolocation failed:", error);
            }
        );
    }
    
    google.maps.event.trigger(mapElement, 'resize');
}

// 1. 修正日期為 12/19 - 1/3 (共 16 天)
function getTravelDates() {
    const start = new Date('2025-12-19T00:00:00');
    const end = new Date('2026-01-03T00:00:00');
    const dates = [];
    let currentDate = new Date(start);
    while (currentDate <= end) {
        // 確保日期是正確格式
        dates.push(currentDate.toISOString().split('T')[0]);
        // 增加一天
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
}

function showApp() {
    if (appReadyToDisplay) return;

    const appElement = document.getElementById('app');
    if (appElement) {
        // 移除隱藏 class，讓應用程式顯示
        appElement.classList.remove('hidden');
    }
    appReadyToDisplay = true;
}

// **定義 SVG 圖標 (Heroicons 2.5, line style)**
const ICONS = {
    // 地圖/行程: Globe Alt Icon
    itinerary: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21v-4.5m0 0V5.25M12 16.5h3.375M12 16.5L10.5 21M12 16.5H8.625M9.75 8.25m1.125 0a2.25 2.25 0 1 1 0 4.5 2.25 2.25 0 0 1 0-4.5ZM12 4.5v1.5m-3 0h6m-1.5-1.5a1.5 1.5 0 0 1 1.5 1.5v1.5m-6 0v-1.5a1.5 1.5 0 0 1 1.5-1.5h3m-6 0H9m-3 0a1.5 1.5 0 0 0 1.5 1.5h3.75"/></svg>`,
    // 地圖: Map Pin Icon
    map: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`,
    // 記帳: Currency Dollar Icon (代表貨幣)
    accounting: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.01 60.01 0 0 0 10.5.5H12m10.5-11.25H12V12c0 1.295.127 2.583.374 3.824M19.5 16.5l-6-6M4.5 9h9m-9 0a7.5 7.5 0 0 1 7.5-7.5v1.5m-7.5 6v1.5m7.5-7.5a7.5 7.5 0 0 1 7.5 7.5v1.5m-15 3h1.5a7.5 7.5 0 0 0 7.5-7.5v-1.5m-15 3a7.5 7.5 0 0 0 7.5 7.5h1.5M4.5 18.75h15m-15 0a7.5 7.5 0 0 0 7.5 7.5V22.5"/></svg>`,
    // 購物: Shopping Cart Icon
    shopping: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.056.832L6.772 17.5c.101.489.546.832 1.056.832H20.25a1.125 1.125 0 0 0 1.12-1.248L19.46 8.423a.975.975 0 0 0-.95-1.075H5.87l-.44-2.126C5.228 4.253 4.8 3 3.636 3H2.25" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM6.75 19.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" /></svg>`,
    // 裝備清單: Clipboard Document Check Icon (3. 新增圖標)
    checklist: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-2.25A1.125 1.125 0 0 1 12 7.125v-3.375c0-1.036 1.125-1.5 1.5-1.5h.375c1.036 0 1.5 1.125 1.5 1.5v2.625a3.375 3.375 0 0 0 3.375 3.375h2.25A1.125 1.125 0 0 1 21 12v3.375m-1.5-3.375h-2.25M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Zm.75-10.5h1.5M12 10.5v1.5M12 10.5h-1.5"/></svg>`,
};


function mountVueApp() {
    const app = createApp({
        setup() {
            const tabs = [
                { id: 'itinerary', name: '行程', icon: ICONS.itinerary },
                { id: 'map', name: '地圖', icon: ICONS.map },
                { id: 'accounting', name: '記帳', icon: ICONS.accounting },
                { id: 'shopping', name: '購物', icon: ICONS.shopping },
                { id: 'checklist', name: '裝備清單', icon: ICONS.checklist }, // 3. 新增裝備清單 Tab
            ];
            const activeTab = ref('itinerary');
            
            const travelDates = getTravelDates();
            const activeDate = ref(travelDates[0]); // 12/19
            
            // --- 行程資料 (已更新為您的 16 天北歐行程) ---
            const itinerary = ref({
                // Day 1: 12/19 (五) - 台北 ✈ 飛機上
                '2025-12-19': [
                    { id: 101, time: '19:00', location: '板橋車站集合', category: '交通', notes: '約20:30前到桃機一航', lat: 25.0135, lng: 121.4654 },
                    { id: 102, time: '23:05', location: 'TPE台北 ✈ AMS阿姆斯特丹', category: '航班', notes: '華航CI073', lat: 25.0777, lng: 121.2298 },
                ],

                // Day 2: 12/20 (六) - 赫爾辛基 (Helsinki, Finland)
                '2025-12-20': [
                    { id: 201, time: '07:50', location: '抵達AMS阿姆斯特丹', category: '航班', notes: '轉機 (11:20AMS-14:45HEL)', lat: 52.3086, lng: 4.7643 },
                    { id: 202, time: '14:45', location: '抵達HEL赫爾辛基機場', category: '航班', notes: '前往住宿 (老人家)', lat: 60.3172, lng: 24.9633 },
                    { id: 203, time: '16:00', location: '前往住宿 & Check-in', category: '住宿', notes: '老人家住宿、放行李', lat: 60.1741, lng: 24.9442 },
                    { id: 204, time: '18:30', location: '赫爾辛基聖誕市集', category: '景點', notes: '晚餐與逛街', lat: 60.1685, lng: 24.9525 },
                    { id: 205, time: '20:30', location: 'Löyly Helsinki 桑拿', category: '景點', notes: '芬蘭浴體驗', lat: 60.1581, lng: 24.9392 },
                ],

                // Day 3: 12/21 (日) - 赫爾辛基 🚄 夜舖火車
                '2025-12-21': [
                    { id: 301, time: '10:00', location: 'Temppeliaukio Church (岩石教堂)', category: '景點', notes: '早午餐後參觀', lat: 60.1729, lng: 24.9329 },
                    { id: 302, time: '13:00', location: 'Oodi Central Library', category: '景點', notes: '現代圖書館設計', lat: 60.1741, lng: 24.9382 },
                    { id: 303, time: '15:00', location: 'Marimekko Outlet Herttoniemi', category: '購物', notes: '芬蘭設計品牌', lat: 60.2001, lng: 25.0210 },
                    { id: 304, time: '22:00', location: 'Helsinki Central Station', category: '交通', notes: '準備搭乘夜舖火車', lat: 60.1717, lng: 24.9415 },
                    { id: 305, time: '23:13', location: '夜舖火車前往羅瓦涅米', category: '交通', notes: '在火車上過夜', lat: 60.1717, lng: 24.9415 },
                ],

                // Day 4: 12/22 (一) - 羅瓦涅米 (Rovaniemi, Finland)
                '2025-12-22': [
                    { id: 401, time: '10:59', location: '抵達羅瓦涅米火車站', category: '交通', notes: '火車抵達', lat: 66.5055, lng: 25.7335 },
                    { id: 402, time: '12:00', location: 'Villa Muru Check-in/寄放行李', category: '住宿', notes: 'KW 訂的住宿', lat: 66.5020, lng: 25.7250 },
                    { id: 403, time: '14:00', location: '聖誕老人村 (Santa Claus Village)', category: '景點', notes: '跨越北極圈線、找聖誕老人', lat: 66.5434, lng: 25.8491 },
                    { id: 404, time: '17:00', location: '馴鹿雪橇體驗', category: '景點', notes: '要搭的人搭', lat: 66.5434, lng: 25.8491 },
                    { id: 405, time: '20:00', location: '極光團 (Get your guide)', category: '景點', notes: '已預訂', lat: 66.5000, lng: 25.7500 },
                ],

                // Day 5: 12/23 (二) - 羅瓦涅米
                '2025-12-23': [
                    { id: 501, time: '09:00', location: 'Villa Muru 住宿', category: '住宿', notes: '早餐自己煮、玩雪、港口走走', lat: 66.5020, lng: 25.7250 },
                    { id: 502, time: '13:00', location: '最北麥當勞', category: '美食', notes: '打卡紀念', lat: 66.4950, lng: 25.7340 },
                    { id: 503, time: '21:00', location: '極光團 (Get Your Guide by KW)', category: '景點', notes: '會派車來民宿接人', lat: 66.5020, lng: 25.7250 },
                ],

                // Day 6: 12/24 (三) - 特羅姆瑟 (Tromsø, Norway)
                '2025-12-24': [
                    { id: 601, time: '07:00', location: '羅瓦涅米機場 (RVN)', category: '交通', notes: '準備搭機', lat: 66.5615, lng: 25.8304 },
                    { id: 602, time: '10:50', location: 'RVN ✈️ TOS (經 HEL)', category: '航班', notes: '芬蘭航空 AY534/AY460', lat: 66.5615, lng: 25.8304 },
                    { id: 603, time: '14:20', location: '抵達TOS特羅姆瑟機場', category: '交通', notes: '搭乘機場巴士前往市區', lat: 69.6923, lng: 18.9179 },
                    { id: 604, time: '16:00', location: 'Aurora Apartments Check-in', category: '住宿', notes: 'KW 訂的住宿', lat: 69.6483, lng: 18.9507 },
                    { id: 605, time: '18:30', location: 'Fjellheisen 纜車', category: '景點', notes: '看城市夜景', lat: 69.6508, lng: 18.9610 },
                    { id: 606, time: '21:00', location: '自尋極光', category: '景點', notes: '可在住宿附近嘗試觀測', lat: 69.6483, lng: 18.9507 },
                ],

                // Day 7: 12/25 (四) - 特羅姆瑟
                '2025-12-25': [
                    { id: 701, time: '10:00', location: 'Tromsø Ice Domes', category: '景點', notes: '冰雪旅館參觀 (自費)', lat: 69.2155, lng: 18.6750 },
                    { id: 702, time: '13:00', location: '北極圈大教堂', category: '景點', notes: 'Tromsdalen Church', lat: 69.6471, lng: 18.9712 },
                    { id: 703, time: '16:00', location: 'Polaria', category: '景點', notes: '極地體驗中心', lat: 69.6450, lng: 18.9480 },
                    { id: 704, time: '21:00', location: '極光團 (Chase)', category: '景點', notes: '已預訂', lat: 69.6483, lng: 18.9507 },
                ],

                // Day 8: 12/26 (五) - 特羅姆瑟
                '2025-12-26': [
                    { id: 801, time: '10:00', location: '犬橇/雪上摩托車活動', category: '景點', notes: '二選一，視預定情況', lat: 69.7500, lng: 19.3000 },
                    { id: 802, time: '15:00', location: 'Ølhallen 啤酒吧', category: '美食', notes: '世界最北的啤酒吧 (挪威物價高)', lat: 69.6491, lng: 18.9515 },
                    { id: 803, time: '20:00', location: '自尋極光', category: '景點', notes: '最後一晚，在附近走走碰運氣', lat: 69.6483, lng: 18.9507 },
                ],

                // Day 9-16 的行程資料保持不變
                // ...
                // Day 9: 12/27 (六) - 哥本哈根 (Copenhagen, Denmark)
                '2025-12-27': [
                    { id: 901, time: '08:30', location: 'Tromsø機場 (TOS)', category: '交通', notes: '準備搭機', lat: 69.6923, lng: 18.9179 },
                    { id: 902, time: '14:30', location: 'TOS ✈️ CPH (經 OSL)', category: '航班', notes: '挪威航空', lat: 55.6214, lng: 12.6508 },
                    { id: 903, time: '16:00', location: '住宿 Check-in (Near Norreport Station)', category: '住宿', notes: '放行李休息', lat: 55.6888, lng: 12.5707 },
                    { id: 904, time: '19:00', location: 'Tivoli Gardens (聖誕節活動)', category: '景點', notes: '晚餐與逛街', lat: 55.6732, lng: 12.5651 },
                ],

                // Day 10: 12/28 (日) - 哥本哈根
                '2025-12-28': [
                    { id: 1001, time: '10:00', location: '新港 (Nyhavn)', category: '景點', notes: '彩色房子、拍照', lat: 55.6756, lng: 12.5898 },
                    { id: 1002, time: '12:00', location: '小美人魚像', category: '景點', notes: '散步到 Langelinie', lat: 55.6942, lng: 12.5992 },
                    { id: 1003, time: '14:00', location: '羅森堡城堡 & 國王花園', category: '景點', notes: '看皇家珠寶', lat: 55.6835, lng: 12.5786 },
                    { id: 1004, time: '18:30', location: 'Torvehallerne Market', category: '美食', notes: '晚餐覓食', lat: 55.6865, lng: 12.5683 },
                ],

                // Day 11: 12/29 (一) - 哥本哈根 ✈ 斯德哥爾摩
                '2025-12-29': [
                    { id: 1101, time: '10:00', location: '圓塔 (Rundetaarn)', category: '景點', notes: '登高望遠', lat: 55.6811, lng: 12.5779 },
                    { id: 1102, time: '13:00', location: 'Strøget 購物街', category: '購物', notes: '最後採買丹麥物品', lat: 55.6775, lng: 12.5785 },
                    { id: 1103, time: '17:30', location: 'CPH ✈️ ARN', category: '航班', notes: '北歐航空 SK1424', lat: 59.6496, lng: 17.9238 },
                    { id: 1104, time: '20:00', location: '斯德哥爾摩 Check-in', category: '住宿', notes: 'Södermalm 區住宿', lat: 59.3190, lng: 18.0678 },
                ],

                // Day 12: 12/30 (二) - 斯德哥爾摩 (Stockholm, Sweden)
                '2025-12-30': [
                    { id: 1201, time: '10:00', location: '舊城區 (Gamla Stan)', category: '景點', notes: '大廣場、皇宮衛兵交接', lat: 59.3293, lng: 18.0686 },
                    { id: 1202, time: '13:00', location: 'Vasa Museum (瓦薩沉船博物館)', category: '景點', notes: '必看景點', lat: 59.3281, lng: 18.0839 },
                    { id: 1203, time: '16:00', location: 'Skansen (斯坎森露天博物館)', category: '景點', notes: '聖誕節活動', lat: 59.3283, lng: 18.0967 },
                    { id: 1204, time: '19:30', location: 'Meatballs for the People', category: '美食', notes: '吃瑞典肉丸', lat: 59.3150, lng: 18.0770 },
                ],

                // Day 13: 12/31 (三) - 斯德哥爾摩
                '2025-12-31': [
                    { id: 1301, time: '10:00', location: '市政廳 (Stadshuset)', category: '景點', notes: '藍廳、金廳', lat: 59.3275, lng: 18.0543 },
                    { id: 1302, time: '13:00', location: '地下鐵藝術之旅', category: '景點', notes: '紅線、藍線等著名站點', lat: 59.3300, lng: 18.0600 },
                    { id: 1303, time: '18:00', location: '新年前夜晚餐', category: '美食', notes: '預訂餐廳', lat: 59.3190, lng: 18.0678 },
                    { id: 1304, time: '23:00', location: 'Skansen 跨年煙火', category: '景點', notes: '或選擇其他觀景點', lat: 59.3283, lng: 18.0967 },
                ],

                // Day 14: 01/01 (四) - 斯德哥爾摩
                '2026-01-01': [
                    { id: 1401, time: '12:00', location: 'Fotografiska (攝影博物館)', category: '景點', notes: '避寒，新年午餐', lat: 59.3182, lng: 18.0835 },
                    { id: 1402, time: '15:00', location: 'Södermalm 區漫步', category: '景點', notes: 'Mosebacke Torg 俯瞰市區', lat: 59.3190, lng: 18.0678 },
                    { id: 1403, time: '19:00', location: '晚餐 & 休息', category: '美食', notes: '輕鬆過節', lat: 59.3190, lng: 18.0678 },
                ],

                // Day 15: 01/02 (五) - 斯德哥爾摩 ✈ 飛機上
                '2026-01-02': [
                    { id: 1501, time: '10:00', location: 'Final Shopping/Fika', category: '購物', notes: '購買伴手禮、咖啡時光', lat: 59.3300, lng: 18.0600 },
                    { id: 1502, time: '14:00', location: '前往 ARN 機場', category: '交通', notes: '搭乘 Arlanda Express', lat: 59.3190, lng: 18.0678 },
                    { id: 1503, time: '18:15', location: 'ARN ✈️ DXB (杜拜)', category: '航班', notes: '阿聯酋航空 EK158', lat: 59.6496, lng: 17.9238 },
                ],

                // Day 16: 01/03 (六) - 杜拜 ✈ 飛機上
                '2026-01-03': [
                    { id: 1601, time: '02:50', location: '抵達 DXB 杜拜', category: '航班', notes: '轉機 (04:45DXB-16:55TPE)', lat: 25.2532, lng: 55.3653 },
                    { id: 1602, time: '16:55', location: '抵達 TPE 台北', category: '航班', notes: '華航 CI73', lat: 25.0777, lng: 121.2298 },
                ],
            });
            
            // --- 記帳/清單資料保持不變 ---
            const expenses = ref([
                { id: 1, item: '機票 (TPE-HEL-RVN/TOS-CPH-ARN-TPE)', amount: 38000, date: '2025-10-01' },
                { id: 2, item: '赫爾辛基住宿', amount: 5400, date: '2025-10-01' },
                { id: 3, item: '赫爾辛基-羅瓦涅米夜火車', amount: 4300, date: '2025-10-01' },
                { id: 4, item: '羅瓦涅米極光團 (12/22)', amount: 2800, date: '2025-10-01' },
                { id: 5, item: '羅瓦涅米住宿', amount: 7200, date: '2025-10-01' },
                { id: 6, item: '特羅姆瑟住宿', amount: 12500, date: '2025-10-01' },
                { id: 7, item: '特羅姆瑟極光團 (12/25)', amount: 3500, date: '2025-10-01' },
                { id: 8, item: '哥本哈根住宿', amount: 8000, date: '2025-10-01' },
                { id: 9, item: '斯德哥爾摩住宿', amount: 9500, date: '2025-10-01' },
            ]);

            const shoppingList = ref([
                { id: 1, name: '極光攝影鏡頭', done: false },
                { id: 2, name: '芬蘭刀 (Kuksa)', done: false },
                { id: 3, name: '極地禦寒手套', done: true },
                { id: 4, name: '瑞典肉丸香料包', done: false },
            ]);
            
            // 3. 裝備清單初始化
            const travelChecklist = ref([
                { id: 1, name: '護照/簽證', done: false, notes: '效期半年以上' },
                { id: 2, name: '歐元/挪威克朗/丹麥克朗', done: false, notes: '少量現金' },
                { id: 3, name: '保暖內衣褲/羊毛襪', done: true, notes: '洋蔥式穿法' },
                { id: 4, name: '雪靴/防水鞋', done: true, notes: '' },
                { id: 5, name: '轉接頭/行動電源', done: false, notes: '歐規插座' },
                { id: 6, name: '常用藥品 (感冒藥/腸胃藥)', done: false, notes: '' },
            ]);

            const isModalOpen = ref(false);
            const modalType = ref(''); // 'itinerary', 'accounting', 'shopping', 'checklist'
            const tempItem = ref({});
            
            // --- 地圖相關變數 ---
            const map = ref(null);
            const markers = ref([]);
            
            // --- Computed Properties ---
            const currentItinerary = computed(() => itinerary.value[activeDate.value] || []);
            const currentCity = computed(() => CITY_MAP[activeDate.value] || '未知地點');
            // ✨ 新增極光預測 Computed Property
            const currentAuroraInfo = computed(() => AURORA_PREDICTIONS[activeDate.value] || null);

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
            const totalExpenseEUR = computed(() => (totalExpense.value / EXCHANGE_RATE).toFixed(0));
            
            const modalTitle = computed(() => {
                switch (modalType.value) {
                    case 'accounting': return '新增旅費花費';
                    case 'shopping': return '新增購物清單項目';
                    case 'checklist': return '新增旅行裝備';
                    default: return '新增項目';
                }
            });
            
            const currentMapLink = computed(() => {
                const locations = currentItinerary.value.filter(item => item.lat && item.lng);
                if (locations.length === 0) return 'https://www.google.com/maps/search/Nordic+Trip';
                
                // 建立多點導航連結
                const waypoints = locations.slice(1).map(item => `${item.lat},${item.lng}`).join('|');
                const origin = `${locations[0].lat},${locations[0].lng}`;
                
                // 使用 Google Maps Directions URL Scheme
                return `https://www.google.com/maps/dir/${origin}/${waypoints}`;
            });

            // --- Methods ---
            function formatDate(isoDate) {
                const [year, month, day] = isoDate.split('-');
                return `${month}/${day}`;
            }

            function setActiveDate(date) {
                activeDate.value = date;
                if (activeTab.value === 'map') {
                    nextTick(() => {
                        initMap();
                    });
                }
                // 滾動到選中日期
                nextTick(() => {
                    const container = document.querySelector('.date-scroll-container');
                    const activeBtn = container ? container.querySelector('.tab-date-active') : null;
                    if (container && activeBtn) {
                        const offset = activeBtn.offsetLeft - (container.offsetWidth / 2) + (activeBtn.offsetWidth / 2);
                        container.scrollTo({ left: offset, behavior: 'smooth' });
                    }
                });
            }

            function getCurrentWeather() {
                // 簡化天氣顯示，根據城市和日期提供一個硬編碼值
                const city = currentCity.value.split('/')[0];
                const date = new Date(activeDate.value);
                const isLappland = ['羅瓦涅米', '特羅姆瑟'].includes(city);
                
                if (isLappland) {
                    // 極地地區 - 寒冷、多雪
                    return { icon: '❄️', temp: '-8°C', desc: '雪花飄落' };
                } else if (city === '赫爾辛基') {
                    return { icon: '🌨️', temp: '-2°C', desc: '陰天，有小雪' };
                } else if (['哥本哈根', '斯德哥爾摩'].includes(city)) {
                    return { icon: '🌬️', temp: '2°C', desc: '多雲，風大' };
                } else {
                    return { icon: '☀️', temp: '20°C', desc: '旅途愉快' };
                }
            }

            function getGoogleMapLink(item) {
                if (!item.lat || !item.lng) return '#';
                return `https://www.google.com/maps/search/?api=1&query=${item.location}&query_place_id=${item.lat},${item.lng}`;
            }
            
            function showModal(type) {
                modalType.value = type;
                tempItem.value = { id: Date.now() };
                if (type === 'accounting') {
                    tempItem.value.date = formatDate(activeDate.value);
                    tempItem.value.amount = 0;
                } else if (type === 'shopping' || type === 'checklist') {
                    tempItem.value.name = '';
                    tempItem.value.done = false;
                }
                isModalOpen.value = true;
            }
            
            function saveItem() {
                const item = { ...tempItem.value };
                if (modalType.value === 'accounting' && item.item && item.amount > 0) {
                    expenses.value.push(item);
                } else if (modalType.value === 'shopping' && item.name) {
                    shoppingList.value.push(item);
                } else if (modalType.value === 'checklist' && item.name) {
                    travelChecklist.value.push(item);
                } else {
                    alert('請填寫完整且有效的資訊！');
                    return;
                }
                isModalOpen.value = false;
            }

            function deleteItem(type, id) {
                if (!confirm('確定要刪除此項目嗎？')) return;
                switch (type) {
                    case 'itinerary':
                        itinerary.value[activeDate.value] = currentItinerary.value.filter(item => item.id !== id);
                        break;
                    case 'accounting':
                        expenses.value = expenses.value.filter(item => item.id !== id);
                        break;
                    case 'shopping':
                        shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                        break;
                    case 'checklist':
                        travelChecklist.value = travelChecklist.value.filter(item => item.id !== id);
                        break;
                }
            }

            // --- Watchers ---
            watch(activeTab, (newTab, oldTab) => {
                if (newTab === 'map') {
                    nextTick(() => {
                        // 確保在切換到地圖時重新初始化/更新地圖
                        initMap();
                    });
                } else if (oldTab === 'map') {
                    // 離開地圖頁面時清除標記 (選擇性，但有助於效能)
                    if (map.value && markers.value.length > 0) {
                        markers.value.forEach(marker => marker.setMap(null));
                        markers.value = [];
                    }
                }
            });

            // 應用程式初始化完成後，顯示 APP
            nextTick(() => {
                showApp();
            });


            return {
                tabs,
                activeTab,
                travelDates,
                activeDate,
                currentCity,
                currentItinerary,
                currentAuroraInfo, // ✨ 新增極光資訊
                totalExpense,
                totalExpenseEUR,
                expenses,
                shoppingList,
                travelChecklist, // 3. 新增
                isModalOpen,
                modalType,
                tempItem,
                modalTitle,
                currentMapLink,
                isGoogleMapsLoaded: googleMapsLoaded, // 傳遞給模板
                map,
                markers,
                // Methods
                formatDate,
                setActiveDate,
                getCurrentWeather,
                getGoogleMapLink,
                showModal,
                saveItem,
                deleteItem,
                initMap, // 傳遞給全局調用
            };
        }
    });

    appInstance = app.mount('#app');
}

// 如果 Google Maps API 尚未載入，則手動掛載 Vue App
if (typeof google === 'undefined') {
    mountVueApp();
}

</script>
</body>
</html>

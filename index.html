<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nordic Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 1. Nordic Minimalism + Snowy/Christmas Color Palette (Stronger Style) */
        :root {
            --nordic-light: #e6f0f5; /* Light, cool blue-gray for main background (Less white, stronger feel) */
            --nordic-white: #ffffff; /* Pure White for card backgrounds */
            --nordic-dark: #2c3e50; /* Dark text for readability (Stronger contrast) */
            --nordic-muted: #a9c1d6; /* Muted gray for secondary text/borders */
            --nordic-accent: #006064; /* Stronger Teal/Dark Cyan for primary highlight */
            --nordic-christmas: #b04e57; /* Soft Christmas Red for contrast/alerts */
        }
        
        /* 2. Custom Tailwind-like classes using CSS variables */
        .bg-nordic-light { background-color: var(--nordic-light); }
        .bg-nordic-white { background-color: var(--nordic-white); }
        .text-nordic-dark { color: var(--nordic-dark); }
        .text-nordic-accent { color: var(--nordic-accent); }
        .border-nordic-muted { border-color: var(--nordic-muted); }
        
        /* Softer, snowy shadow for cards and buttons */
        .shadow-snowy { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.04); } 

        /* Mobile App Container */
        #app {
            max-width: 600px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--nordic-light); 
            position: relative;
        }

        /* Vue Transition Styles */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        /* Itinerary Date Slider */
        .date-slider::-webkit-scrollbar {
            height: 4px;
        }
        .date-slider::-webkit-scrollbar-thumb {
            background: var(--nordic-muted); 
            border-radius: 2px;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ç¨å¾®æ·±ä¸€é»çš„åŠé€æ˜èƒŒæ™¯ */
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Highlighted Save Button Style */
        .btn-save {
            background-color: var(--nordic-accent);
            color: white;
            font-weight: bold;
            padding: 10px 16px;
        }
        .btn-delete {
            background-color: var(--nordic-christmas);
            color: white;
            font-weight: bold;
            padding: 10px 16px;
        }
    </style>
</head>
<body class="bg-nordic-light">

<div id="app">
    <header class="sticky top-0 bg-nordic-white shadow-snowy p-4 flex items-center justify-center z-20 border-b border-gray-200">
        <h1 class="text-xl font-extrabold" :class="{'text-nordic-accent': currentTab === 'itinerary', 'text-nordic-dark': currentTab !== 'itinerary'}">
            Nordic Trip
        </h1>
    </header>

    <main class="flex-grow overflow-y-auto bg-nordic-light relative">
        <transition name="fade" mode="out-in">
            
            <div v-if="currentTab === 'itinerary'" key="itinerary" class="pb-4">
                
                <div class="sticky top-0 bg-nordic-white shadow-snowy p-2 mb-4 z-10 border-b border-gray-200">
                    <div class="date-slider flex overflow-x-scroll space-x-2 pb-2">
                        <button v-for="(day, index) in itinerary" :key="index"
                                @click="selectDay(day)"
                                class="flex-shrink-0 px-3 py-1 text-sm font-medium rounded-full transition-colors border"
                                :class="{
                                    'bg-white border-2 border-nordic-accent text-nordic-accent shadow-md font-bold': selectedDay === day, 
                                    'bg-white border-gray-300 text-nordic-dark hover:bg-gray-100': selectedDay !== day
                                }">
                            {{ day.date.substring(5) }} <span class="text-xs ml-1 opacity-70">({{ day.day_of_week.substring(0, 1) }})</span>
                        </button>
                    </div>
                </div>

                <div class="p-4" v-if="selectedDay">
                    <h2 class="text-2xl font-bold text-nordic-dark mb-4">{{ getCityDisplay(selectedDay) }}</h2>

                    <div v-if="selectedDay.weather" class="mb-4 p-4 bg-nordic-white rounded-xl shadow-snowy border-l-4 border-gray-300 flex items-center">
                        <svg class="w-7 h-7 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <div class="text-sm">
                            <p class="font-bold text-nordic-dark">â„ï¸ é è¨ˆå¤©æ°£</p>
                            <p class="text-gray-500">ğŸŒ¡ï¸ {{ selectedDay.weather['æ°£æº«'] || 'N/A' }} / â˜€ï¸ {{ selectedDay.weather['æ—¥ç…§'] || 'N/A' }}</p>
                            <p v-if="selectedDay.weather['å‚™è¨»']" class="text-xs text-nordic-christmas mt-1">âš ï¸ {{ selectedDay.weather['å‚™è¨»'] }}</p>
                        </div>
                    </div>

                    <div v-if="selectedDay.aurora_forecast" class="mb-4 p-4 rounded-xl shadow-snowy border-l-4 border-nordic-accent bg-nordic-white">
                        <div class="flex items-center">
                            <svg class="w-7 h-7 text-nordic-accent mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 100 4m-4 10a2 2 0 100-4m14 0a2 2 0 100-4m-4 4a2 2 0 100 4m-10 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                            <div class="text-sm">
                                <p class="font-bold text-nordic-dark">ğŸŒŒ æ¥µå…‰é å ± (å»ºè­°)</p>
                                <p class="text-gray-600">**KP æŒ‡æ•¸ï¼š**<span class="font-semibold text-nordic-accent">{{ selectedDay.aurora_forecast['kp_index'] }}</span></p>
                                <p class="text-gray-600" v-if="selectedDay.aurora_forecast['time_range']">**æœ€ä½³æ™‚é–“ï¼š**{{ selectedDay.aurora_forecast['time_range'] }}</p>
                                <p v-if="selectedDay.aurora_forecast['notes']" class="text-xs text-nordic-accent mt-1">ğŸ’¡ {{ selectedDay.aurora_forecast['notes'] }}</p>
                            </div>
                        </div>
                    </div>
                    

                    <h3 class="text-xl font-bold text-nordic-dark mb-3 border-b border-gray-300 pb-2">ç•¶æ—¥å®‰æ’</h3>
                    <div v-for="(item, itemIndex) in selectedDay.events" :key="itemIndex" class="mb-3 bg-nordic-white rounded-xl shadow-snowy p-4 border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-nordic-accent">{{ item.time }}</p>
                                <p class="font-medium text-nordic-dark text-lg">{{ item.schedule }}</p>
                            </div>
                            <button @click="openModalForEdit('itinerary-event', selectedDay.date, itemIndex)" class="text-gray-400 hover:text-nordic-accent transition p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                            </button>
                        </div>
                        
                        <a v-if="item.location" :href="getMapLink(item.location)" target="_blank" class="text-sm text-blue-500 hover:underline flex items-center mt-2 pt-2 border-t border-gray-200">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                            {{ item.location }} (Google åœ°åœ–å°èˆª)
                        </a>
                    </div>
                    
                    <div class="mt-6 p-4 bg-nordic-white rounded-xl shadow-snowy text-sm text-gray-500 border border-gray-200">
                        <p class="font-bold text-nordic-dark">ğŸ  ä½å®¿ï¼š{{ selectedDay.accommodation }}</p>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === 'checklist'" key="checklist" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">è¡Œå‰è£å‚™æ¸…å–® ğŸ“‹</h2>
                <p class="text-sm text-gray-500 mb-4">é»æ“Šé …ç›®å¯æ¨™è¨˜ç‚ºå·²å®Œæˆ / é»æ“Šåˆ†é¡æ¨™é¡Œå¯å±•é–‹æ”¶åˆã€‚</p>
                <div v-for="(items, category) in checklist" :key="category" class="mb-3 bg-nordic-white rounded-xl shadow-snowy overflow-hidden border border-gray-200">
                    <div @click="toggleChecklist(category)" class="p-4 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <h3 class="text-xl font-bold text-nordic-accent">{{ category }}</h3>
                        <span class="text-sm text-gray-500">{{ getCheckedCount(category) }} / {{ items.length }}</span>
                    </div>
                    
                    <ul v-if="!collapsedChecklist[category]" class="p-4 pt-0 space-y-3">
                        <li v-for="(item, index) in items" :key="index" class="flex items-center text-nordic-dark pt-3 border-t border-gray-200 first:border-t-0">
                            <input type="checkbox" :id="category + index" v-model="item.checked" class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-3 border-gray-300 bg-white">
                            <label :for="category + index" class="text-base flex-grow cursor-pointer" :class="{ 'line-through text-gray-400': item.checked }">
                                {{ item.name }}
                                <span v-if="item.notes" class="text-xs text-gray-500"> ({{ item.notes }})</span>
                            </label>
                            <button @click.stop="showFeatureAlert('ç·¨è¼¯æ¸…å–®é …ç›®')" class="text-gray-400 hover:text-nordic-accent transition p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <div v-else-if="currentTab === 'accounting'" key="accounting" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">è¨˜å¸³ä¸­å¿ƒ ğŸ’°</h2>
                <div class="bg-nordic-white rounded-xl shadow-snowy p-4 mb-6 border border-gray-200">
                    <p class="text-lg font-bold text-nordic-dark">ç¸½æ”¯å‡ºï¼š<span :style="{ color: 'var(--nordic-christmas)' }">NT$ {{ totalSpent.toLocaleString() }}</span></p>
                </div>
                
                <h3 class="text-xl font-bold text-nordic-dark mb-3 border-b border-gray-300 pb-2">æ”¯å‡ºç´€éŒ„</h3>
                <div v-if="accounting.length === 0" class="bg-gray-100 text-gray-500 p-4 rounded-xl shadow-snowy text-center border border-gray-200">
                    <p>ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„ã€‚è«‹é»æ“Šå³ä¸‹è§’æŒ‰éˆ• **+ æ–°å¢æ”¯å‡º**ã€‚</p>
                </div>
                <div v-for="(transaction, index) in accounting" :key="index" class="bg-nordic-white rounded-xl shadow-snowy p-4 mb-3 flex justify-between items-center border border-gray-200">
                    <div @click="openModalForEdit('accounting', transaction, index)" class="flex-grow cursor-pointer">
                        <p class="font-medium text-nordic-dark">{{ transaction.description }}</p>
                        <p class="text-sm text-gray-500">{{ transaction.date }} ({{ transaction.category }})</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-bold text-red-600">
                            - NT$ {{ transaction.amount.toLocaleString() }}
                        </p>
                        <button @click.stop="openModalForEdit('accounting', transaction, index)" class="text-gray-400 hover:text-nordic-accent transition p-1 ml-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === 'shopping'" key="shopping" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">è³¼ç‰©æ¸…å–® ğŸ</h2>
                <div v-if="shoppingList.length === 0" class="bg-gray-100 text-gray-500 p-4 rounded-xl shadow-snowy text-center mb-4 border border-gray-200">
                    <p>ç›®å‰æ²’æœ‰è³¼ç‰©æ¸…å–®é …ç›®ã€‚è«‹é»æ“Šå³ä¸‹è§’æŒ‰éˆ• **+ è³¼ç‰©é …ç›®**ã€‚</p>
                </div>
                <div v-for="(item, index) in shoppingList" :key="index" class="bg-nordic-white rounded-xl shadow-snowy p-4 mb-3 flex items-center border border-gray-200">
                    <input type="checkbox" :id="'shop' + index" v-model="item.purchased" class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-3 border-gray-300 bg-white">
                    <label :for="'shop' + index" class="flex-grow text-nordic-dark" :class="{ 'line-through text-gray-400': item.purchased }">
                        <span class="font-medium text-lg">{{ item.name }}</span>
                        <span v-if="item.store" class="text-sm text-gray-500 block">({{ item.store }})</span>
                    </label>
                    <button @click.stop="openModalForEdit('shopping', item, index)" class="text-gray-400 hover:text-nordic-accent transition p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div v-else-if="currentTab === 'info'" key="info" class="p-4">
                <h2 class="text-2xl font-bold text-nordic-dark mb-4">å¯¦ç”¨è³‡è¨Š ğŸ’¡</h2>
                <div class="space-y-4">
                    <div class="bg-nordic-white rounded-xl shadow-snowy p-4 border border-gray-200">
                        <h3 class="text-xl font-bold text-nordic-dark mb-2">è³‡æ–™å„²å­˜èˆ‡ç·¨è¼¯èªªæ˜ (V10 æ›´æ–°)</h3>
                        <p class="text-sm text-nordic-accent mb-2 font-bold">
                            âœ… è³¼ç‰©æ¸…å–®ã€è¡Œç¨‹é …ç›®ã€æ”¯å‡ºç´€éŒ„çš†å·²å…·å‚™ **æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤** åŠŸèƒ½ï¼
                        </p>
                        <p class="text-sm text-gray-600">
                            æ‰€æœ‰æ•¸æ“šçš†å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ°å„²å­˜ (Local Storage)ã€‚æ‚¨å¯ä»¥è©¦è‘—åœ¨ä»»ä½•åˆ†é æ–°å¢ã€ç·¨è¼¯æˆ–åˆªé™¤é …ç›®ï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ä¾†é©—è­‰æ•¸æ“šæ˜¯å¦è¢«ä¿ç•™ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
        </transition>
    </main>
    
    <div class="fixed bottom-20 right-4 z-50">
        <div v-if="isAddMenuOpen" @click.away="isAddMenuOpen = false" class="mb-3 space-y-2">
            
            <button v-if="currentTab === 'shopping'" @click.prevent="openModalForAdd('shopping')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-bold rounded-lg shadow-snowy hover:bg-gray-100 transition border border-gray-300 text-left">
                + è³¼ç‰©é …ç›®
            </button>
            <button v-if="currentTab === 'accounting'" @click.prevent="openModalForAdd('accounting')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-bold rounded-lg shadow-snowy hover:bg-gray-100 transition border border-gray-300 text-left">
                + æ–°å¢æ”¯å‡º
            </button>
            <button v-if="currentTab === 'itinerary'" @click.prevent="openModalForAdd('itinerary-event')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-bold rounded-lg shadow-snowy hover:bg-gray-100 transition border border-gray-300 text-left">
                + æ–°å¢è¡Œç¨‹é …ç›®
            </button>
            <button v-if="currentTab === 'checklist'" @click.prevent="showFeatureAlert('æ–°å¢æ¸…å–®')" class="block w-40 p-3 bg-nordic-white text-nordic-dark text-sm font-bold rounded-lg shadow-snowy hover:bg-gray-100 transition border border-gray-300 text-left">
                + æ–°å¢æ¸…å–®é …ç›®
            </button>
        </div>
        
        <button v-if="['itinerary', 'accounting', 'shopping', 'checklist'].includes(currentTab)" 
                @click="isAddMenuOpen = !isAddMenuOpen" 
                class="bg-nordic-accent text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-teal-600 transition transform hover:rotate-90">
            <svg v-if="!isAddMenuOpen" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <svg v-else class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <transition name="fade">
        <div v-if="isModalOpen && modalDataType === 'shopping'" class="modal-backdrop">
            <div class="bg-nordic-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md border border-gray-300 transform transition-all scale-100">
                <h3 class="text-xl font-bold text-nordic-dark mb-4 border-b pb-2">
                    {{ editingItemIndex === -1 ? 'æ–°å¢è³¼ç‰©é …ç›®' : 'ç·¨è¼¯è³¼ç‰©é …ç›®' }}
                </h3>
                
                <form @submit.prevent="saveModalItem">
                    <div class="mb-4">
                        <label for="shopName" class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label>
                        <input type="text" id="shopName" v-model="editingItem.name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="ä¾‹å¦‚ï¼šä¿æš–æ‰‹å¥—ã€ç´€å¿µå“">
                    </div>
                    
                    <div class="mb-4">
                        <label for="shopStore" class="block text-sm font-medium text-gray-700 mb-1">è³¼è²·åœ°é»/å‚™è¨» (é¸å¡«)</label>
                        <input type="text" id="shopStore" v-model="editingItem.store"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="ä¾‹å¦‚ï¼šH&Mã€æ©Ÿå ´å…ç¨…åº—">
                    </div>
                    
                    <div class="flex items-center mb-6">
                        <input type="checkbox" id="shopPurchased" v-model="editingItem.purchased" 
                               class="form-checkbox h-5 w-5 text-nordic-accent rounded-sm mr-2 border-gray-300 bg-white">
                        <label for="shopPurchased" class="text-base text-gray-700">æ˜¯å¦å·²è³¼è²·ï¼Ÿ</label>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button v-if="editingItemIndex !== -1" @click.prevent="deleteItem('shopping', editingItemIndex)"
                                type="button" 
                                class="btn-delete px-4 py-2 text-sm rounded-lg transition">
                            åˆªé™¤
                        </button>
                        
                        <div class="flex space-x-3 ml-auto">
                            <button @click.prevent="closeModal" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                    class="btn-save px-4 py-2 text-sm rounded-lg hover:bg-teal-600 transition">
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div v-if="isModalOpen && modalDataType === 'itinerary-event'" class="modal-backdrop">
            <div class="bg-nordic-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md border border-gray-300 transform transition-all scale-100">
                <h3 class="text-xl font-bold text-nordic-dark mb-4 border-b pb-2">
                    {{ editingItemIndex === -1 ? 'æ–°å¢è¡Œç¨‹é …ç›®' : 'ç·¨è¼¯è¡Œç¨‹é …ç›®' }} ({{ editingItem.date }})
                </h3>
                
                <form @submit.prevent="saveModalItem">
                    <div class="mb-4">
                        <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡æ—¥æœŸ</label>
                        <select id="eventDate" v-model="editingItem.date" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent">
                            <option v-for="day in itinerary" :key="day.date" :value="day.date">
                                {{ day.date.substring(5) }} ({{ day.city_country.split('(')[0].trim() }})
                            </option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1">æ™‚é–“ (ä¾‹å¦‚: 14:30)</label>
                        <input type="text" id="eventTime" v-model="editingItem.time" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="æ ¼å¼ï¼šHH:MM">
                    </div>
                    
                    <div class="mb-4">
                        <label for="eventSchedule" class="block text-sm font-medium text-gray-700 mb-1">è¡Œç¨‹å…§å®¹</label>
                        <input type="text" id="eventSchedule" v-model="editingItem.schedule" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="ä¾‹å¦‚ï¼šåˆé¤ / æ™¯é»åç¨±">
                    </div>
                    
                    <div class="mb-6">
                        <label for="eventLocation" class="block text-sm font-medium text-gray-700 mb-1">åœ°é» (é¸å¡«)</label>
                        <input type="text" id="eventLocation" v-model="editingItem.location"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="åœ°åœ–å°èˆªç”¨ï¼Œä¾‹å¦‚ï¼šVasa Museum">
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button v-if="editingItemIndex !== -1" @click.prevent="deleteItem('itinerary-event', editingItemIndex, editingItem.date)"
                                type="button" 
                                class="btn-delete px-4 py-2 text-sm rounded-lg transition">
                            åˆªé™¤
                        </button>
                        
                        <div class="flex space-x-3 ml-auto">
                            <button @click.prevent="closeModal" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                    class="btn-save px-4 py-2 text-sm rounded-lg hover:bg-teal-600 transition">
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div v-if="isModalOpen && modalDataType === 'accounting'" class="modal-backdrop">
            <div class="bg-nordic-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md border border-gray-300 transform transition-all scale-100">
                <h3 class="text-xl font-bold text-nordic-dark mb-4 border-b pb-2">
                    {{ editingItemIndex === -1 ? 'æ–°å¢æ”¯å‡ºç´€éŒ„' : 'ç·¨è¼¯æ”¯å‡ºç´€éŒ„' }}
                </h3>
                
                <form @submit.prevent="saveModalItem">
                    <div class="mb-4">
                        <label for="accDescription" class="block text-sm font-medium text-gray-700 mb-1">æ”¯å‡ºå…§å®¹</label>
                        <input type="text" id="accDescription" v-model="editingItem.description" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="ä¾‹å¦‚ï¼šåˆé¤è²»ç”¨ã€çºœè»Šç¥¨">
                    </div>

                    <div class="mb-4">
                        <label for="accAmount" class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡ (NT$)</label>
                        <input type="number" id="accAmount" v-model.number="editingItem.amount" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent"
                               placeholder="è«‹è¼¸å…¥å°å¹£é‡‘é¡">
                    </div>
                    
                    <div class="mb-4">
                        <label for="accDate" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="accDate" v-model="editingItem.date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent">
                    </div>
                    
                    <div class="mb-6">
                        <label for="accCategory" class="block text-sm font-medium text-gray-700 mb-1">é¡åˆ¥</label>
                        <select id="accCategory" v-model="editingItem.category" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-nordic-accent focus:border-nordic-accent">
                            <option value="äº¤é€š">äº¤é€š</option>
                            <option value="é¤é£²">é¤é£²</option>
                            <option value="é–€ç¥¨/æ´»å‹•">é–€ç¥¨/æ´»å‹•</option>
                            <option value="è³¼ç‰©/ç´€å¿µå“">è³¼ç‰©/ç´€å¿µå“</option>
                            <option value="ä½å®¿">ä½å®¿</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button v-if="editingItemIndex !== -1" @click.prevent="deleteItem('accounting', editingItemIndex)"
                                type="button" 
                                class="btn-delete px-4 py-2 text-sm rounded-lg transition">
                            åˆªé™¤
                        </button>
                        
                        <div class="flex space-x-3 ml-auto">
                            <button @click.prevent="closeModal" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                    class="btn-save px-4 py-2 text-sm rounded-lg hover:bg-teal-600 transition">
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </transition>


    <nav class="sticky bottom-0 bg-nordic-white border-t border-gray-200 shadow-xl p-2 z-20">
        <ul class="flex justify-around">
            <li v-for="tab in tabs" :key="tab.id" class="flex-1 text-center">
                <a href="#" @click.prevent="changeTab(tab.id)" 
                   :class="{'flex flex-col items-center p-2 rounded-lg transition-colors': true, 'text-nordic-accent bg-gray-100': currentTab === tab.id, 'text-gray-500 hover:text-nordic-dark': currentTab !== tab.id}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" v-html="tab.icon"></svg>
                    <span class="text-xs mt-1 font-medium">{{ tab.name }}</span>
                </a>
            </li>
        </ul>
    </nav>
</div>

<script>
    const { createApp, computed, ref, watch } = Vue;

    // ----------------------------------------------------
    // æ ¸å¿ƒè³‡æ–™åº« (æ•¸æ“šåˆå§‹åŒ–èˆ‡é è¨­å€¼)
    // ----------------------------------------------------

    const getMapLink = (query) => {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
    };

    const countryFlagMap = {
        "FI": "ğŸ‡«ğŸ‡®",
        "NO": "ğŸ‡³ğŸ‡´",
        "DK": "ğŸ‡©ğŸ‡°",
        "SE": "ğŸ‡¸ğŸ‡ª",
        "TW": "ğŸ‡¹ğŸ‡¼",
        "": "", // è½‰æ©Ÿæˆ–äº¤é€šæ—¥
    };

    const defaultItineraryData = [
        {
            date: "2025/12/19", day_of_week: "äº”", city_country: "è‡ºç£ (Taiwan)", country_code: "TW", weather: null, aurora_forecast: null,
            events: [{ time: "23:05", schedule: "âœˆè¯èˆªCI073 TPE å°åŒ— èµ·é£›", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´" }],
            accommodation: "é£›æ©Ÿä¸Š"
        },
        {
            date: "2025/12/20", day_of_week: "å…­", city_country: "èµ«çˆ¾è¾›åŸº (Helsinki, FI)", country_code: "FI",
            weather: { 'æ°£æº«': 'ç´„ -6Â°C åˆ° 0Â°C', 'æ—¥ç…§': 'ç´„ 6 å°æ™‚', 'é™æ°´': 'å¸¸æœ‰é™é›ªæˆ–é›¨å¤¾é›ª' }, aurora_forecast: null,
            events: [
                { time: "14:45", schedule: "âœˆæŠµé” HELèµ«çˆ¾è¾›åŸº", location: "Helsinki Airport" },
                { time: "17:00", schedule: "ğŸ„è–èª•å¸‚é›†", location: "Tuomaan Markkinat" },
                { time: "19:00", schedule: "ğŸ¥£Sea horse resturant (æ™šé¤)", location: "Sea Horse Restaurant" },
            ],
            accommodation: "è€äººå®¶ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/21", day_of_week: "æ—¥", city_country: "èµ«çˆ¾è¾›åŸº / ç¾…ç“¦æ¶…ç±³ (Rovaniemi, FI)", country_code: "FI",
            weather: { 'æ°£æº«': 'ç´„ -15Â°C åˆ° -7Â°C', 'æ—¥ç…§': 'æ¥µå¤œå¾®å…‰', 'å‚™è¨»': 'æ¥µåœ°å¯’å†·ï¼Œéœ€æ³¨æ„ä¿æš–' }, 
            aurora_forecast: { 'kp_index': '2-3 (ä½åº¦)', 'time_range': 'N/A', 'notes': 'ç«è»Šä¸Šç„¡æ³•è§€è³' },
            events: [
                { time: "10:00", schedule: "â˜•ï¸Cafe Regatta (è‚‰æ¡‚å°å±‹)", location: "Cafe Regatta" },
                { time: "11:00", schedule: "Temppeliaukio Church (å²©çŸ³æ•™å ‚)", location: "Temppeliaukio Church" },
                { time: "12:30", schedule: "Kauppatori èµ«çˆ¾è¾›åŸºå¸‚é›†å»£å ´ & Oodi ä¸­å¤®åœ–æ›¸é¤¨", location: "" },
                { time: "16:30", schedule: "K-market (æ¡è²· VR ç«è»Šæ™šé¤/æ—©é¤)", location: "" },
                { time: "18:49", schedule: "ğŸš‚VRå¤œè»Š (è‡¥é‹ª) Helsinki -> Rovaniemi", location: "Helsinki Central Station" },
            ],
            accommodation: "VRå¤œè»Š (è‡¥é‹ª)"
        },
        {
            date: "2025/12/22", day_of_week: "ä¸€", city_country: "ç¾…ç“¦æ¶…ç±³ (Rovaniemi, FI)", country_code: "FI",
            weather: { 'æ°£æº«': 'ç´„ -15Â°C åˆ° -7Â°C', 'æ—¥ç…§': 'æ¥µå¤œå¾®å…‰', 'å‚™è¨»': 'æ¥µåœ°å¯’å†·ï¼Œéœ€æ³¨æ„ä¿æš–' }, 
            aurora_forecast: { 'kp_index': '3-4 (ä¸­åº¦)', 'time_range': '21:00 - 01:00', 'notes': 'å»ºè­°åƒåŠ æ¥µå…‰åœ˜æˆ–åœ¨æˆ¶å¤–è§€æ¸¬' },
            events: [
                { time: "07:27", schedule: "ğŸš‚æŠµé” Rovaniemi / Check in", location: "Rovaniemi Train Station" },
                { time: "10:00", schedule: "ğŸ¦Œé¦´é¹¿é›ªæ©‡ã€é›ªåœ°æ‘©æ‰˜è»Š (æ´»å‹•)", location: "" },
                { time: "14:00", schedule: "Rovaniemi éº¥ç•¶å‹ (å…¨çƒæœ€åŒ—)", location: "McDonald's Rovaniemi" },
                { time: "16:00", schedule: "Arktikum æ¥µåœ°åšç‰©é¤¨", location: "Arktikum" },
                { time: "20:00", schedule: "æ¥µå…‰åœ˜ (å¦‚æœé å ±å¥½)", location: "" },
            ],
            accommodation: "Rovaniemi City (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/23", day_of_week: "äºŒ", city_country: "ç¾…ç“¦æ¶…ç±³ / ç‰¹ç¾…å§†ç‘Ÿ (TromsÃ¸, NO)", country_code: "NO",
            weather: { 'æ°£æº«': 'ç´„ -5Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'æ¥µå¤œ', 'å‚™è¨»': 'æ²¿æµ·åŸå¸‚æ°£æº«è¼ƒé«˜ï¼Œå¤šé›ª' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "ğŸ…ğŸ»è–èª•è€äººæ‘ (åŒ—æ¥µåœˆç·š)", location: "Santa Claus Village" },
                { time: "13:00", schedule: "ğŸšŒæ­ä¹˜å·´å£«å‰å¾€æ©Ÿå ´", location: "Rovaniemi Airport" },
                { time: "16:35", schedule: "âœˆRovaniemi (RVN) -> TromsÃ¸ (TOS)", location: "TromsÃ¸ Airport" },
                { time: "19:00", schedule: "Check inã€æ¡è²·æ™šé¤", location: "" },
            ],
            accommodation: "ç‰¹ç¾…å§†ç‘Ÿ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/24", day_of_week: "ä¸‰", city_country: "ç‰¹ç¾…å§†ç‘Ÿ (TromsÃ¸, NO)", country_code: "NO",
            weather: { 'æ°£æº«': 'ç´„ -5Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'æ¥µå¤œ' }, 
            aurora_forecast: { 'kp_index': '4-5 (è¼ƒé«˜)', 'time_range': '20:00 - 00:00', 'notes': 'ç‰¹ç¾…å§†ç‘Ÿæ˜¯æ¥µå…‰å¸¶æœ€ä½³è§€æ¸¬é»ä¹‹ä¸€ï¼ŒæˆåŠŸç‡é«˜' },
            events: [
                { time: "10:00", schedule: "Polaria æ¥µåœ°é«”é©—ä¸­å¿ƒ", location: "Polaria" },
                { time: "13:00", schedule: "Fjellheisen çºœè»Š (ç™»é«˜æœ›é )", location: "Fjellheisen" },
                { time: "18:00", schedule: "æ™šé¤ï¼šRisÃ¸ Mat & Kaffebar æˆ– Mathallen", location: "" },
                { time: "21:00", schedule: "æ¥µå…‰åœ˜/è‡ªè¡Œè§€æ¸¬", location: "" },
            ],
            accommodation: "ç‰¹ç¾…å§†ç‘Ÿ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/25", day_of_week: "å››", city_country: "ç‰¹ç¾…å§†ç‘Ÿ (TromsÃ¸, NO)", country_code: "NO",
            weather: { 'æ°£æº«': 'ç´„ -5Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'æ¥µå¤œ' }, 
            aurora_forecast: { 'kp_index': '3-4 (ä¸­åº¦)', 'time_range': '22:00 - 02:00', 'notes': 'è–èª•ç¯€è¨±å¤šåº—å®¶æœªç‡Ÿæ¥­ï¼Œå»ºè­°è‡ªå‚™é¤é£Ÿæˆ–é è¨‚è–èª•é¤' },
            events: [
                { time: "10:00", schedule: "â„ï¸é›ªåœ°æ´»å‹• (ç‹—é›ªæ©‡/é›ªé‹å¥è¡Œ/æµ·ä¸Šæ´»å‹•)", location: "" },
                { time: "15:00", schedule: "è–èª•é¤æˆ–è‡ªç‚Š", location: "" },
                { time: "19:00", schedule: "åŒ—æ¥µå¤§æ•™å ‚ (TromsÃ¸ Cathedral) è–èª•å½Œæ’’ (è‹¥æœ‰)", location: "Arctic Cathedral" },
            ],
            accommodation: "ç‰¹ç¾…å§†ç‘Ÿ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/26", day_of_week: "äº”", city_country: "ç‰¹ç¾…å§†ç‘Ÿ / å“¥æœ¬å“ˆæ ¹ (Copenhagen, DK)", country_code: "DK",
            weather: { 'æ°£æº«': 'ç´„ 0Â°C åˆ° 5Â°C', 'æ—¥ç…§': 'ç´„ 7 å°æ™‚', 'å‚™è¨»': 'åŸå¸‚è¼ƒæº«å’Œï¼Œä½†é¢¨å¤§' }, aurora_forecast: null,
            events: [
                { time: "08:00", schedule: "æ—©é¤/å‰å¾€æ©Ÿå ´", location: "TromsÃ¸ Airport" },
                { time: "11:35", schedule: "âœˆTromsÃ¸ (TOS) -> Copenhagen (CPH)", location: "Copenhagen Airport" },
                { time: "15:00", schedule: "Check in / Nyhavn æ–°æ¸¯ç¢¼é ­", location: "Nyhavn" },
                { time: "19:00", schedule: "æ™šé¤ï¼šPÃ¸lsevogn (ç†±ç‹—æ”¤) æˆ– VÃ¦kst", location: "" },
            ],
            accommodation: "å“¥æœ¬å“ˆæ ¹ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/27", day_of_week: "å…­", city_country: "å“¥æœ¬å“ˆæ ¹ (Copenhagen, DK)", country_code: "DK",
            weather: { 'æ°£æº«': 'ç´„ 0Â°C åˆ° 5Â°C', 'æ—¥ç…§': 'ç´„ 7 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "Christiansborg Palace (å…‹é‡Œæ–¯è’‚å®‰å ¡å®®)", location: "Christiansborg Palace" },
                { time: "13:00", schedule: "Lunch: Torvehallerne Market (å®¤å…§å¸‚é›†)", location: "Torvehallerne Market" },
                { time: "15:00", schedule: "Round Tower (åœ“å¡”)", location: "Round Tower" },
                { time: "18:00", schedule: "æ™šé¤ï¼šHÃ¸st (åŒ—æ­æ–™ç†)", location: "" },
            ],
            accommodation: "å“¥æœ¬å“ˆæ ¹ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/28", day_of_week: "æ—¥", city_country: "å“¥æœ¬å“ˆæ ¹ (Copenhagen, DK)", country_code: "DK",
            weather: { 'æ°£æº«': 'ç´„ 0Â°C åˆ° 5Â°C', 'æ—¥ç…§': 'ç´„ 7 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "The Little Mermaid (å°ç¾äººé­š)", location: "The Little Mermaid" },
                { time: "11:00", schedule: "Kastellet (æ˜Ÿå½¢è¦å¡)", location: "Kastellet" },
                { time: "13:00", schedule: "Lunch: Paper Island/Reffen", location: "Reffen" },
                { time: "15:00", schedule: "Freetown Christiania (è‡ªç”±åŸ)", location: "Freetown Christiania" },
                { time: "18:00", schedule: "æ™šé¤ï¼šNoma (å¦‚æœè¨‚å¾—åˆ°) æˆ– Barr", location: "" },
                { time: "21:00", schedule: "ğŸŒ·Tivoli Gardens (è–èª•å­£é–‹æ”¾)", location: "Tivoli Gardens" },
            ],
            accommodation: "å“¥æœ¬å“ˆæ ¹ (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/29", day_of_week: "ä¸€", city_country: "å“¥æœ¬å“ˆæ ¹ / æ–¯å¾·å“¥çˆ¾æ‘© (Stockholm, SE)", country_code: "SE",
            weather: { 'æ°£æº«': 'ç´„ -3Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'ç´„ 6 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "è³¼ç‰©/è‡ªç”±æ´»å‹• (StrÃ¸get)", location: "StrÃ¸get" },
                { time: "14:00", schedule: "å‰å¾€æ©Ÿå ´", location: "Copenhagen Airport" },
                { time: "16:30", schedule: "âœˆCopenhagen (CPH) -> Stockholm (ARN)", location: "Arlanda Airport" },
                { time: "19:00", schedule: "Arlanda Express / Check in", location: "" },
                { time: "20:30", schedule: "æ™šé¤ï¼šMeatballs for the people", location: "Meatballs for the people" },
            ],
            accommodation: "æ–¯å¾·å“¥çˆ¾æ‘© (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/30", day_of_week: "äºŒ", city_country: "æ–¯å¾·å“¥çˆ¾æ‘© (Stockholm, SE)", country_code: "SE",
            weather: { 'æ°£æº«': 'ç´„ -3Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'ç´„ 6 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "ğŸš¢Vasa Museum (ç“¦è–©æ²‰èˆ¹åšç‰©é¤¨)", location: "Vasa Museum" },
                { time: "13:00", schedule: "Lunch: Ã–stermalms Saluhall (å®¤å…§å¸‚é›†)", location: "Ã–stermalms Saluhall" },
                { time: "15:00", schedule: "Skansen Open-Air Museum (æ–¯å ªæ£®éœ²å¤©åšç‰©é¤¨)", location: "Skansen" },
                { time: "18:00", schedule: "æ™šé¤ï¼šPelikan (ç¶“å…¸ç‘å…¸èœ)", location: "Pelikan" },
                { time: "21:00", schedule: "ğŸ¸å†°å§/é…’å§ (çµ•å°å†°å§æˆ–Hobo)", location: "ICEBAR Stockholm by ICEHOTEL" },
            ],
            accommodation: "æ–¯å¾·å“¥çˆ¾æ‘© (Airbnb/é£¯åº—)"
        },
        {
            date: "2025/12/31", day_of_week: "ä¸‰", city_country: "æ–¯å¾·å“¥çˆ¾æ‘© (Stockholm, SE)", country_code: "SE",
            weather: { 'æ°£æº«': 'ç´„ -3Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'ç´„ 6 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "MonteliusvÃ¤gen è§€æ™¯å°", location: "MonteliusvÃ¤gen" },
                { time: "12:00", schedule: "Lunch: SÃ¶dermalm å€å’–å•¡å»³", location: "SÃ¶dermalm" },
                { time: "15:00", schedule: "Fotografiska (æ”å½±åšç‰©é¤¨)", location: "Fotografiska" },
                { time: "18:00", schedule: "æ™šé¤ï¼šè·¨å¹´å¤§é¤ (SÃ¶dra Teatern or Grand HÃ´tel)", location: "" },
                { time: "23:30", schedule: "Skansen æˆ¶å¤–è·¨å¹´æ´»å‹•/ç…™ç«", location: "Skansen" },
            ],
            accommodation: "æ–¯å¾·å“¥çˆ¾æ‘© (Airbnb/é£¯åº—)"
        },
        {
            date: "2026/01/01", day_of_week: "å››", city_country: "æ–¯å¾·å“¥çˆ¾æ‘© (Stockholm, SE)", country_code: "SE",
            weather: { 'æ°£æº«': 'ç´„ -3Â°C åˆ° 2Â°C', 'æ—¥ç…§': 'ç´„ 6 å°æ™‚' }, aurora_forecast: null,
            events: [
                { time: "11:00", schedule: "â˜•ï¸Fika (ç‘å…¸å’–å•¡æ™‚é–“)", location: "" },
                { time: "13:00", schedule: "Gamla Stan (è€åŸå€)", location: "Gamla Stan" },
                { time: "15:00", schedule: "Royal Palace (çš‡å®®)", location: "Stockholm Palace" },
                { time: "18:00", schedule: "æ™šé¤ï¼šOsteria Fedora (ç¾©å¼)", location: "" },
                { time: "20:00", schedule: "è‡ªç”±æ´»å‹•", location: "" },
            ],
            accommodation: "æ–¯å¾·å“¥çˆ¾æ‘© (Airbnb/é£¯åº—)"
        },
        {
            date: "2026/01/02", day_of_week: "äº”", city_country: "äº¤é€šæ—¥", country_code: "",
            weather: null, aurora_forecast: null,
            events: [
                { time: "10:00", schedule: "æœ€å¾Œæ¡è²·/ç´€å¿µå“", location: "" },
                { time: "14:00", schedule: "å‰å¾€æ©Ÿå ´", location: "Arlanda Airport" },
                { time: "16:30", schedule: "âœˆStockholm (ARN) -> ä¸­è½‰é»", location: "" },
            ],
            accommodation: "é£›æ©Ÿä¸Š"
        },
        {
            date: "2026/01/03", day_of_week: "å…­", city_country: "è‡ºç£ (Taiwan)", country_code: "TW",
            weather: null, aurora_forecast: null,
            events: [
                { time: "14:35", schedule: "âœˆæŠµé” TPE å°åŒ—", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´" },
            ],
            accommodation: "æº«æš–çš„å®¶"
        },
    ]; [cite_start]// Data derived from 2026åŒ—æ­è¡Œ.xlsx - ç¸½è¡Œç¨‹.csv [cite: 26]

    const defaultChecklistData = {
        "è¡£ç‰© (æ¥µåœ°ä¿æš–å¿…å‚™)": [
            { name: "å…§è¡£è¤²", notes: "", checked: false },
            { name: "ä¿æš–è¡£ç‰©", notes: "ç™¼ç†±è¡£ã€è¤²è¥ª", checked: false },
            { name: "ä¸Šè¡£", notes: "", checked: false },
            { name: "ä¸‹èº«è¡£ç‰©", notes: "", checked: false },
            { name: "ç¡è¡£", notes: "", checked: false },
            { name: "å¤–å¥—", notes: "æ¥µåœ°ç­‰ç´šå¤–å¥—", checked: false },
            { name: "è¥ªå­", notes: "ç¾Šæ¯›è¥ª/ä¿æš–è¥ª", checked: false },
            { name: "é‹å­", notes: "é›ªé´/é˜²æ°´é˜²æ»‘é‹", checked: false },
            { name: "æ³³è¡£", notes: "ï¼ˆæ¡‘æ‹¿æˆ–æº«æ³‰ç”¨ï¼‰", checked: false },
        ],
        "é…ä»¶èˆ‡åŒ…è¢‹": [
            { name: "å¤ªé™½çœ¼é¡", notes: "é›ªåœ°é˜²çœ©å…‰", checked: false },
            { name: "ä¿æš–é…ä»¶", notes: "å¸½å­ã€åœå·¾ã€æ‰‹å¥—ã€è€³ç½©", checked: false },
            { name: "åŒ…åŒ…", notes: "éš¨èº«å°åŒ…/å¾ŒèƒŒåŒ…", checked: false },
            { name: "é£¾å“", notes: "", checked: false },
        ],
        "å€‹äººç”¨å“èˆ‡è—¥å“": [
            { name: "ç‰™åˆ·ç‰™è†", notes: "", checked: false },
            { name: "ç›¥æ´—ç”¨å“", notes: "æ´—é«®ç²¾ã€æ²æµ´ä¹³ã€è­·é«®ç­‰", checked: false },
            { name: "è‡‰éƒ¨æ´—å¸ç”¨å“", notes: "å¸å¦ä¹³ã€æ´—é¢ä¹³", checked: false },
            { name: "ä¿é¤Šå“", notes: "è‡‰éƒ¨ã€èº«é«”ã€è­·å”‡è†ã€è­·æ‰‹éœœã€é˜²æ›¬ä¹³", checked: false },
            { name: "åŒ–å¦å“", notes: "", checked: false },
            { name: "æ¢³å­/é¢è†œ", notes: "", checked: false },
            { name: "éš±å½¢çœ¼é¡/è¿‘è¦–çœ¼é¡", notes: "", checked: false },
            { name: "åˆ®é¬ç”¨å“", notes: "", checked: false },
            { name: "å€‹äººè—¥å“", notes: "æ„Ÿå†’è—¥ã€èƒƒè—¥ã€ä¿å¥é£Ÿå“ã€ç™¼æ³¡éŒ ã€æšˆè»Šè—¥", checked: false },
            { name: "å¹é¢¨æ©Ÿ", notes: "", checked: false },
            { name: "è¡›ç”Ÿæ£‰/è­·å¢Š", notes: "", checked: false },
            { name: "æŒ‡ç”²å‰ª", notes: "", checked: false },
        ],
        "è­‰ä»¶èˆ‡é‡è¦æ–‡ä»¶": [
            { name: "è­·ç…§", notes: "", checked: false },
            { name: "éŒ¢", notes: "ä¸¹éº¥å…‹æœ—/æŒªå¨å…‹æœ—/ç‘å…¸å…‹æœ—/æ­å…ƒ (åŠä¿¡ç”¨å¡)", checked: false },
            { name: "æ—…å¹³éšª", notes: "ç´™æœ¬æˆ–é›»å­æª”", checked: false },
            { name: "ä¿¡ç”¨å¡", notes: "", checked: false },
            { name: "é§•ç…§ï¼Ÿ", notes: "ï¼ˆå¦‚æœéœ€è¦ç§Ÿè»Šï¼‰", checked: false },
            { name: "å…©å‹ç…§ç‰‡*2", notes: "å‚™ç”¨", checked: false },
        ],
        "é›»å­ç”¢å“èˆ‡é›œé …": [
            { name: "å……é›»å™¨", notes: "æ­è¦è½‰æ¥é ­", checked: false },
            { name: "è¡Œå‹•é›»æº", notes: "éœ€è£å¤¾éˆè¢‹æ‰‹æä¸Šæ©Ÿ", checked: false },
            { name: "ç›¸æ©Ÿå……é›»ç·š", notes: "", checked: false },
            { name: "ä¸‰è…³æ¶", notes: "ï¼ˆæ‹æ¥µå…‰ç”¨ï¼‰", checked: false },
            { name: "è€³æ©Ÿ", notes: "", checked: false },
            { name: "ç¶²å¡/eSIM", notes: "", checked: false },
            { name: "å¯¦ç”¨APP", notes: "Flush (æ‰¾å»æ‰€), My Aurora Forecast (æ¥µå…‰), Norway lights (æŒªå¨æ¥µå…‰)", checked: false },
        ]
    }; [cite_start]// Data derived from 2026åŒ—æ­è¡Œ.xlsx - æ—…è¡Œè£å‚™æ¸…å–®.csv metadata snippet [cite: 18]

    // å„²å­˜æ–¼ Local Storage çš„ Key
    const LOCAL_STORAGE_KEYS = {
        ITINERARY: 'nordic_trip_itinerary_v10',
        CHECKLIST: 'nordic_trip_checklist_v10',
        ACCOUNTING: 'nordic_trip_accounting_v10',
        SHOPPING: 'nordic_trip_shopping_v10',
    };

    // å¾ Local Storage è¼‰å…¥æ•¸æ“šï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
    const loadData = (key, defaultValue) => {
        try {
            const data = localStorage.getItem(key);
            if (data) {
                return JSON.parse(data);
            }
        } catch (e) {
            console.error(`Error loading data from key: ${key}`, e);
        }
        return JSON.parse(JSON.stringify(defaultValue)); // æ·±æ‹·è²é è¨­å€¼
    };

    // å„²å­˜æ•¸æ“šåˆ° Local Storage
    const saveData = (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            console.error(`Error saving data to key: ${key}`, e);
        }
    };

    const app = createApp({
        setup() {
            // State
            const currentTab = ref('itinerary');
            const tabs = [
                { id: 'itinerary', name: 'è¡Œç¨‹', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>' },
                { id: 'checklist', name: 'æ¸…å–®', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>' },
                { id: 'accounting', name: 'è¨˜å¸³', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m4 5h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"></path>' },
                { id: 'shopping', name: 'è³¼ç‰©', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>' },
                { id: 'info', name: 'è³‡è¨Š', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' }
            ];

            const itinerary = ref(loadData(LOCAL_STORAGE_KEYS.ITINERARY, defaultItineraryData));
            const checklist = ref(loadData(LOCAL_STORAGE_KEYS.CHECKLIST, defaultChecklistData));
            const accounting = ref(loadData(LOCAL_STORAGE_KEYS.ACCOUNTING, []));
            const shoppingList = ref(loadData(LOCAL_STORAGE_KEYS.SHOPPING, []));

            const selectedDay = ref(itinerary.value[0]);
            const collapsedChecklist = ref({});
            const isAddMenuOpen = ref(false);

            // Modal State
            const isModalOpen = ref(false);
            const modalDataType = ref(null); // 'shopping', 'accounting', 'itinerary-event'
            const editingItem = ref({});
            const editingItemIndex = ref(-1);
            const editingItineraryDate = ref(null); // å°ˆé–€çµ¦è¡Œç¨‹ç·¨è¼¯ç”¨ï¼Œå› ç‚ºè¡Œç¨‹äº‹ä»¶æ˜¯å·¢ç‹€çš„


            // Computed
            const totalSpent = computed(() => {
                return accounting.value.reduce((sum, item) => sum + item.amount, 0);
            });


            // Methods
            const changeTab = (tabId) => {
                currentTab.value = tabId;
                isAddMenuOpen.value = false;
            };

            const selectDay = (day) => {
                selectedDay.value = day;
            };

            const getCityDisplay = (day) => {
                const flag = countryFlagMap[day.country_code] || '';
                return `${flag} ${day.city_country}`;
            };

            const toggleChecklist = (category) => {
                collapsedChecklist.value[category] = !collapsedChecklist.value[category];
            };

            const getCheckedCount = (category) => {
                return checklist.value[category].filter(item => item.checked).length;
            };
            
            const showFeatureAlert = (feature) => {
                alert(`æ­¤ç‚ºå±•ç¤ºåŠŸèƒ½ï¼Œæš«ä¸æ”¯æ´ ${feature}ã€‚æ‚¨å¯ä»¥æ‰‹å‹•ç·¨è¼¯ç¨‹å¼ç¢¼ä¸­çš„ defaultChecklistDataã€‚`);
            };

            // Modal Logic
            const openModalForAdd = (type) => {
                modalDataType.value = type;
                editingItemIndex.value = -1;
                if (type === 'shopping') {
                    editingItem.value = { name: '', store: '', purchased: false };
                } else if (type === 'accounting') {
                    const today = new Date().toISOString().substring(0, 10);
                    editingItem.value = { description: '', amount: null, date: today, category: 'é¤é£²' };
                } else if (type === 'itinerary-event') {
                    const defaultDate = selectedDay.value ? selectedDay.value.date : itinerary.value[0].date;
                    editingItem.value = { date: defaultDate, time: '', schedule: '', location: '' };
                    editingItineraryDate.value = defaultDate;
                }
                isModalOpen.value = true;
                isAddMenuOpen.value = false;
            };

            const openModalForEdit = (type, itemOrDate, index) => {
                modalDataType.value = type;
                editingItemIndex.value = index;

                if (type === 'shopping' || type === 'accounting') {
                    editingItem.value = JSON.parse(JSON.stringify(itemOrDate)); // Deep copy
                } else if (type === 'itinerary-event') {
                    // itemOrDate is the date string, index is the event index
                    const day = itinerary.value.find(d => d.date === itemOrDate);
                    editingItem.value = JSON.parse(JSON.stringify({ ...day.events[index], date: itemOrDate }));
                    editingItineraryDate.value = itemOrDate;
                }
                isModalOpen.value = true;
            };

            const closeModal = () => {
                isModalOpen.value = false;
                editingItem.value = {};
                editingItemIndex.value = -1;
                editingItineraryDate.value = null;
            };

            const saveModalItem = () => {
                if (modalDataType.value === 'shopping') {
                    if (editingItemIndex.value === -1) {
                        shoppingList.value.push(editingItem.value);
                    } else {
                        shoppingList.value[editingItemIndex.value] = editingItem.value;
                    }
                    saveData(LOCAL_STORAGE_KEYS.SHOPPING, shoppingList.value);

                } else if (modalDataType.value === 'accounting') {
                    // ç¢ºä¿é‡‘é¡æ˜¯æ•¸å­—
                    editingItem.value.amount = parseFloat(editingItem.value.amount);
                    if (editingItemIndex.value === -1) {
                        accounting.value.push(editingItem.value);
                        // ç¢ºä¿æ’åºï¼Œè®“æœ€æ–°é …ç›®åœ¨å‰é¢ (å¯é¸)
                        accounting.value.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    } else {
                        accounting.value[editingItemIndex.value] = editingItem.value;
                    }
                    saveData(LOCAL_STORAGE_KEYS.ACCOUNTING, accounting.value);

                } else if (modalDataType.value === 'itinerary-event') {
                    const itemToSave = JSON.parse(JSON.stringify(editingItem.value));
                    const targetDate = itemToSave.date;
                    delete itemToSave.date; // ç§»é™¤ date å±¬æ€§ï¼Œå› ç‚º event åªéœ€è¦ time, schedule, location
                    
                    if (editingItemIndex.value === -1) {
                        // æ–°å¢
                        const day = itinerary.value.find(d => d.date === targetDate);
                        if (day) {
                            day.events.push(itemToSave);
                            // æ’åº: æ ¹æ“š time æ¬„ä½æ’åº
                            day.events.sort((a, b) => a.time.localeCompare(b.time));
                        }
                    } else {
                        // ç·¨è¼¯ (å¯èƒ½æœ‰æ›æ—¥æœŸ)
                        const originalDate = editingItineraryDate.value;
                        if (originalDate === targetDate) {
                            // æ—¥æœŸæœªè®Š
                            const day = itinerary.value.find(d => d.date === targetDate);
                            day.events[editingItemIndex.value] = itemToSave;
                            day.events.sort((a, b) => a.time.localeCompare(b.time));
                        } else {
                            // æ—¥æœŸå·²è®Šï¼Œå¾åŸæ—¥æœŸåˆªé™¤ï¼Œæ–°å¢åˆ°æ–°æ—¥æœŸ
                            const originalDay = itinerary.value.find(d => d.date === originalDate);
                            if (originalDay) {
                                originalDay.events.splice(editingItemIndex.value, 1);
                            }
                            const newDay = itinerary.value.find(d => d.date === targetDate);
                            if (newDay) {
                                newDay.events.push(itemToSave);
                                newDay.events.sort((a, b) => a.time.localeCompare(b.time));
                                selectedDay.value = newDay; // åˆ‡æ›åˆ°æ–°çš„æ—¥æœŸé é¢
                            }
                        }
                    }
                    saveData(LOCAL_STORAGE_KEYS.ITINERARY, itinerary.value);
                }

                closeModal();
            };

            const deleteItem = (type, index, date) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
                    if (type === 'shopping') {
                        shoppingList.value.splice(index, 1);
                        saveData(LOCAL_STORAGE_KEYS.SHOPPING, shoppingList.value);
                    } else if (type === 'accounting') {
                        accounting.value.splice(index, 1);
                        saveData(LOCAL_STORAGE_KEYS.ACCOUNTING, accounting.value);
                    } else if (type === 'itinerary-event') {
                        const day = itinerary.value.find(d => d.date === date);
                        if (day) {
                            day.events.splice(index, 1);
                            saveData(LOCAL_STORAGE_KEYS.ITINERARY, itinerary.value);
                        }
                    }
                    closeModal();
                }
            };
            
            // Watchers for immediate saving on simple updates (checkboxes)
            watch(checklist, (newVal) => {
                saveData(LOCAL_STORAGE_KEYS.CHECKLIST, newVal);
            }, { deep: true });
            
            watch(shoppingList, (newVal) => {
                // è³¼ç‰©æ¸…å–®çš„å‹¾é¸ç‹€æ…‹ä¹Ÿæœƒè§¸ç™¼å„²å­˜
                saveData(LOCAL_STORAGE_KEYS.SHOPPING, newVal);
            }, { deep: true });

            // Ensure the first day is selected upon load if itinerary data is present
            if (itinerary.value.length > 0 && !selectedDay.value) {
                selectedDay.value = itinerary.value[0];
            }


            return {
                currentTab,
                tabs,
                itinerary,
                checklist,
                accounting,
                shoppingList,
                selectedDay,
                collapsedChecklist,
                isAddMenuOpen,
                isModalOpen,
                modalDataType,
                editingItem,
                editingItemIndex,
                totalSpent,
                
                // Methods
                changeTab,
                selectDay,
                getCityDisplay,
                getMapLink,
                toggleChecklist,
                getCheckedCount,
                showFeatureAlert,
                openModalForAdd,
                openModalForEdit,
                closeModal,
                saveModalItem,
                deleteItem,
            };
        }
    });

    app.mount('#app');
</script>
</body>
</html>

<template>
  <div class="flex flex-col h-full bg-gray-50">
    <div class="px-2 py-3 bg-white shadow-md overflow-x-auto whitespace-nowrap sticky top-0 z-5">
      <button 
        v-for="date in tripDates" 
        :key="date.full" 
        @click="selectDate(date)"
        :class="['inline-flex flex-col items-center mx-1 p-2 rounded-xl transition-all duration-200 w-16', 
          selectedDate.full === date.full ? 'bg-blue-100 text-blue-700 shadow-md transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']"
      >
        <span class="text-xs font-bold">{{ date.dayOfWeek }}</span>
        <span class="text-lg font-extrabold">{{ date.day }}</span>
        <span class="text-xs">{{ date.month }}</span>
      </button>
    </div>

    <div id="map" class="h-64 w-full bg-gray-200 border-b border-gray-300">
      <div class="h-full flex items-center justify-center text-gray-500">
        [Google åœ°åœ–ï¼šè«‹ä½¿ç”¨ API è¼‰å…¥]
        <p class="absolute top-2 right-2 p-1 bg-white/70 rounded-full text-sm font-medium">ğŸ“ é¡¯ç¤ºç•¶å‰ä½ç½®</p>
      </div>
    </div>

    <div class="flex-1 p-4 overflow-y-auto">
      <h2 class="text-xl font-light text-gray-800 mb-3">
        ğŸ“… {{ selectedDate.month }}{{ selectedDate.day }} ({{ selectedDate.dayOfWeek }}) è¡Œç¨‹
      </h2>

      <div v-if="currentItinerary.length === 0" class="text-center py-12 text-gray-400">
        <p>ä»Šæ—¥è¡Œç¨‹ç‚ºç©ºï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ã€‚</p>
      </div>

      <div v-else>
        <div v-for="(item, index) in currentItinerary" :key="item.id" 
             class="bg-white rounded-xl shadow-md p-4 mb-3 border-l-4 transition-all duration-300 hover:shadow-lg"
             :class="{'border-l-blue-400': item.category === 'æ™¯é»', 'border-l-green-400': item.category === 'äº¤é€š', 'border-l-red-400': item.category === 'ç¾é£Ÿ'}"
             draggable="true" @dragstart="dragStart(index)" @dragover.prevent @drop="drop(index)">
             
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="text-sm font-bold text-gray-700 mr-2">{{ item.time }}</span>
              <span :class="['text-xs font-medium px-2 py-0.5 rounded-full', categoryClasses[item.category] || 'bg-gray-200 text-gray-600']">
                {{ item.category }}
              </span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 focus:outline-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
          </div>

          <h3 class="text-lg font-semibold text-gray-800">{{ item.location }}</h3>
          
          <div class="mt-2 text-sm text-gray-600">
            <p class="flex items-center text-blue-600 font-medium">
                <span class="text-xl mr-1">{{ item.weatherIcon }}</span> 
                {{ item.temperature }} | {{ item.weather }}
            </p>
            <p v-if="item.notes" class="mt-1 border-t border-gray-100 pt-1 text-gray-500 italic">å‚™è¨»: {{ item.notes }}</p>
          </div>

          <div class="mt-3 flex justify-end space-x-2 border-t pt-2">
            <button class="text-xs text-blue-500 hover:text-blue-700">ç·¨è¼¯</button>
            <button class="text-xs text-red-500 hover:text-red-700">åˆªé™¤</button>
          </div>
        </div>
      </div>
    </div>

    <button class="fixed right-6 bottom-20 w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center text-2xl font-bold z-10">
      +
    </button>
  </div>

  <div v-if="false" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-30">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
      <h3 class="text-xl font-bold mb-4">æ–°å¢è¡Œç¨‹</h3>
      <input type="text" placeholder="åœ°é»åç¨±" class="w-full p-2 mb-3 border rounded-lg">
      <input type="time" placeholder="æ™‚é–“" class="w-full p-2 mb-3 border rounded-lg">
      
      <select class="w-full p-2 mb-3 border rounded-lg">
        <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
      </select>
      
      <textarea placeholder="å‚™è¨»" rows="3" class="w-full p-2 mb-4 border rounded-lg"></textarea>
      
      <div class="flex justify-end space-x-3">
        <button class="text-gray-600 hover:text-gray-800 p-2">å–æ¶ˆ</button>
        <button class="bg-blue-600 text-white rounded-lg p-2 px-4 hover:bg-blue-700">å„²å­˜</button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { format, eachDayOfInterval } from 'date-fns';
import { zhTW } from 'date-fns/locale';

// --- éœæ…‹æ•¸æ“šå®šç¾© ---

// è¡Œç¨‹åˆ†é¡é¸é …
const categories = ['æ™¯é»', 'äº¤é€š', 'èˆªç­', 'ç¾é£Ÿ', 'è³¼ç‰©', 'å…¶ä»–'];

// è¡Œç¨‹å¡ç‰‡åˆ†é¡æ¨£å¼ (Tailwind CSS)
const categoryClasses = {
  'æ™¯é»': 'bg-blue-50 text-blue-600',
  'äº¤é€š': 'bg-green-50 text-green-600',
  'èˆªç­': 'bg-purple-50 text-purple-600',
  'ç¾é£Ÿ': 'bg-red-50 text-red-600',
  'è³¼ç‰©': 'bg-yellow-50 text-yellow-600',
  'å…¶ä»–': 'bg-gray-200 text-gray-700',
};


// è™›æ“¬è¡Œç¨‹æ•¸æ“š (ç”¨æ–¼ç¤ºç¯„)
const tripData = ref({
  '2025-12-19': [
    { id: 1, time: '10:00', location: 'æŠµé”å¥§æ–¯é™¸åœ‹éš›æ©Ÿå ´', category: 'èˆªç­', notes: 'æº–å‚™è½‰ä¹˜ç«è»Š', weather: 'æ™´æ™‚å¤šé›²', temperature: '-5Â°C', weatherIcon: 'â˜€ï¸', lat: 60.197, lng: 11.100 },
    { id: 2, time: '14:00', location: 'æŒªå¨åœ‹å®¶ç¾è¡“é¤¨ (National Gallery)', category: 'æ™¯é»', notes: 'æ¬£è³å­Ÿå…‹ã€Šå¶å–Šã€‹', weather: 'å°é›ª', temperature: '-8Â°C', weatherIcon: 'ğŸŒ¨ï¸', lat: 59.913, lng: 10.738 },
  ],
  '2025-12-20': [
    { id: 3, time: '09:00', location: 'å¥§æ–¯é™¸å¤§æ•™å ‚', category: 'æ™¯é»', notes: 'ä½æ–¼å¸‚ä¸­å¿ƒï¼Œå¯å…ˆæ‹ç…§', weather: 'å¤§é›ª', temperature: '-10Â°C', weatherIcon: 'â„ï¸', lat: 59.912, lng: 10.750 },
    { id: 4, time: '12:30', location: 'Aker Brygge æµ·æ¸¯å€åˆé¤', category: 'ç¾é£Ÿ', notes: 'æ‰¾ä¸€å®¶æµ·é®®é¤å»³', weather: 'é™°å¤©', temperature: '-6Â°C', weatherIcon: 'â˜ï¸', lat: 59.907, lng: 10.722 },
    { id: 5, time: '15:00', location: 'å‰å¾€å‘çˆ¾æ ¹çš„ç«è»Š', category: 'äº¤é€š', notes: 'å¥§æ–¯é™¸-å‘çˆ¾æ ¹éµè·¯ï¼Œå…¨çƒæœ€ç¾éµè·¯ä¹‹ä¸€', weather: 'å°é›ª', temperature: '-7Â°C', weatherIcon: 'ğŸŒ¨ï¸', lat: 59.914, lng: 10.748 },
  ],
  // æ›´å¤šæ—¥æœŸ...
});

// --- æ—¥æœŸè™•ç†èˆ‡é¸å–® ---

const startDate = new Date('2025-12-19');
const endDate = new Date('2026-01-03'); // æ³¨æ„å¹´ä»½

// ç”Ÿæˆæ‰€æœ‰æ—…è¡Œæ—¥æœŸçš„åˆ—è¡¨
const tripDates = eachDayOfInterval({ start: startDate, end: endDate }).map(date => ({
  full: format(date, 'yyyy-MM-dd'),
  day: format(date, 'd'),
  month: format(date, 'MM/'),
  dayOfWeek: format(date, 'EEE', { locale: zhTW }), // æ˜ŸæœŸå¹¾
}));

const selectedDate = ref(tripDates[0]);

const selectDate = (date) => {
  selectedDate.value = date;
  // TODO: ç•¶æ—¥æœŸæ”¹è®Šæ™‚ï¼Œæ›´æ–°åœ°åœ–æ¨™è¨˜é»
};

// è¨ˆç®—ç•¶å‰æ—¥æœŸçš„è¡Œç¨‹
const currentItinerary = computed(() => {
  return tripData.value[selectedDate.value.full] || [];
});

// --- åœ°åœ–é‚è¼¯ (æ¦‚å¿µæ€§ï¼Œéœ€è‡ªè¡Œåˆå§‹åŒ– Google Maps JS) ---

const initializeMap = (itinerary) => {
    /* å¯¦éš›é‹è¡Œæ™‚éœ€è¦åšä»¥ä¸‹æ“ä½œï¼š
    1. ç¢ºä¿ HTML head ä¸­å·²è¼‰å…¥ Google Maps JS API (åŒ…å« KEY)ã€‚
    2. ä½¿ç”¨ `new google.maps.Map(document.getElementById('map'), options)` åˆå§‹åŒ–åœ°åœ–ã€‚
    3. éæ­· itineraryï¼Œä½¿ç”¨ `new google.maps.Marker` å°‡æ‰€æœ‰åœ°é»é‡˜é¸åœ¨åœ°åœ–ä¸Šã€‚
    4. ç²å–ä½¿ç”¨è€…ç•¶å‰ä½ç½®ï¼ˆGeolocation APIï¼‰ï¼Œä¸¦æ–°å¢ä¸€å€‹æ¨™è¨˜ã€‚
    5. å¯¦ç¾å°èˆªåŠŸèƒ½ (Directions Service)ã€‚
    */
    console.log(`[MAP INIT] æ­£åœ¨åˆå§‹åŒ– ${selectedDate.value.full} çš„åœ°åœ–ï¼Œæ¨™è¨˜åœ°é»æ•¸ï¼š${itinerary.length}`);
    const locations = itinerary.map(item => ({ lat: item.lat, lng: item.lng, title: item.location }));
    // æ¦‚å¿µä¸Šï¼Œåœ°åœ–æœƒæ ¹æ“š locations é€²è¡Œæ¨™è¨˜å’Œå±…ä¸­ã€‚
};

// æ¯æ¬¡ currentItinerary è®ŠåŒ–æ™‚ï¼Œé‡æ–°åˆå§‹åŒ–/æ›´æ–°åœ°åœ–
// import { watch } from 'vue'
// watch(currentItinerary, initializeMap, { immediate: true });
initializeMap(currentItinerary.value); // é¦–æ¬¡è¼‰å…¥

// --- æ‹–æ›³æ’åºé‚è¼¯ (ç°¡åŒ–ç‰ˆ) ---
let draggedIndex = ref(null);

const dragStart = (index) => {
    draggedIndex.value = index;
};

const drop = (dropIndex) => {
    if (draggedIndex.value !== null && draggedIndex.value !== dropIndex) {
        // ç¢ºä¿è¡Œç¨‹æ•¸æ“šæ˜¯å¯è®Šçš„
        const items = tripData.value[selectedDate.value.full];
        
        // 1. å–å¾—è¢«æ‹–æ›³çš„é …ç›®
        const [draggedItem] = items.splice(draggedIndex.value, 1);
        
        // 2. æ’å…¥åˆ°æ–°çš„ä½ç½®
        items.splice(dropIndex, 0, draggedItem);
        
        // é‡è¨­æ‹–æ›³ç´¢å¼•
        draggedIndex.value = null;
    }
};

</script>

<style scoped>
/* éš±è—æ©«å‘æ»¾å‹•æ¢ï¼Œä¿æŒ App ä»‹é¢çš„ç°¡æ½”æ„Ÿ */
.overflow-x-auto::-webkit-scrollbar {
  display: none;
}
.overflow-x-auto {
  -ms-overflow-style: none; /* IE and Edge */
  scrollbar-width: none; /* Firefox */
}
</style>
